{{define "pages/dashboard/webdj"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<div class="d-flex align-items-center justify-content-between">
    <h4 class="mb-0"><i class="bi bi-disc me-2"></i>WebDJ Console</h4>
    <div class="d-flex align-items-center gap-2">
        <span id="connection-status" class="badge bg-secondary">Disconnected</span>
        <button id="end-session-btn" class="btn btn-sm btn-outline-danger d-none">
            <i class="bi bi-x-circle me-1"></i>End Session
        </button>
    </div>
</div>
{{end}}

{{define "main"}}
<!-- Station ID for JavaScript -->
<div id="webdj-app" x-data="webdjConsole()" x-init="init()" data-station-id="{{.Station.ID}}">
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-broadcast me-2"></i>Now Playing (IRT)</h6>
            <button class="btn btn-sm btn-outline-secondary" id="webdjIrtRefreshBtn"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div class="card-body">
            <div id="webdjIrtNowPlaying" class="mb-3 text-body-secondary small">Loading current playback...</div>
            <div id="webdjIrtUpcoming" class="irt-list"></div>
        </div>
    </div>

    <!-- Session Start Screen -->
    <div x-show="!sessionId" class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-disc display-1 text-primary mb-4"></i>
                    <h2 class="mb-3">WebDJ Console</h2>
                    <p class="text-body-secondary mb-4">
                        Start a WebDJ session to mix tracks in your browser.
                    </p>
                    {{if .Data.HasSession}}
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        You have an active session. Click below to reconnect.
                    </div>
                    {{end}}
                    <button @click="startSession()" class="btn btn-primary btn-lg">
                        <i class="bi bi-play-circle me-2"></i>
                        {{if .Data.HasSession}}Resume Session{{else}}Start Session{{end}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main DJ Console -->
    <div x-show="sessionId" x-cloak>
        <!-- Decks Row -->
        <div class="row g-3 mb-3">
            <!-- Deck A -->
            <div class="col-lg-6">
                <div class="card deck-card" :class="{'deck-active': deckA.state === 'playing'}">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <span class="badge bg-primary">DECK A</span>
                        <div class="d-flex align-items-center gap-2">
                            <span class="small text-body-secondary" x-text="deckA.state"></span>
                            <span class="badge" :class="{'bg-success': deckA.state === 'playing', 'bg-warning': deckA.state === 'paused', 'bg-secondary': deckA.state === 'idle'}">
                                <i class="bi" :class="{'bi-play-fill': deckA.state === 'playing', 'bi-pause-fill': deckA.state === 'paused', 'bi-stop-fill': deckA.state !== 'playing' && deckA.state !== 'paused'}"></i>
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <!-- Track Info -->
                        <div class="d-flex align-items-start mb-2">
                            <div class="deck-artwork me-2" @click="loadToDeck('a')">
                                <img :src="deckA.mediaId ? '/dashboard/webdj/media/' + deckA.mediaId + '/artwork' : 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect fill=%22%231a1a2e%22 width=%22200%22 height=%22200%22/></svg>'"
                                     alt="Artwork" class="rounded">
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="fw-bold text-truncate" x-text="deckA.title || 'No Track Loaded'"></div>
                                <div class="small text-body-secondary text-truncate" x-text="deckA.artist || '-'"></div>
                                <div class="small">
                                    <span x-text="formatMs(deckA.positionMs)">0:00</span>
                                    <span class="text-body-secondary">/</span>
                                    <span class="text-body-secondary" x-text="formatMs(deckA.durationMs)">0:00</span>
                                    <span class="ms-2 badge bg-secondary" x-show="deckA.bpm" x-text="deckA.bpm?.toFixed(1) + ' BPM'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Waveform -->
                        <div class="waveform-container mb-2" @click="seekDeck('a', $event)">
                            <canvas id="waveform-a" width="400" height="60"></canvas>
                            <div class="waveform-position" :style="'left: ' + (deckA.positionMs / deckA.durationMs * 100) + '%'"></div>
                        </div>

                        <!-- Transport Controls -->
                        <div class="d-flex justify-content-center gap-1 mb-2">
                            <button class="btn btn-sm btn-outline-secondary" @click="seekDeck('a', null, 0)" title="Go to start">
                                <i class="bi bi-skip-start-fill"></i>
                            </button>
                            <button class="btn btn-sm" :class="deckA.state === 'playing' ? 'btn-warning' : 'btn-success'"
                                    @click="togglePlay('a')" :disabled="!deckA.mediaId">
                                <i class="bi" :class="deckA.state === 'playing' ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" @click="stopDeck('a')" :disabled="!deckA.mediaId" title="Cue">
                                <i class="bi bi-stop-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="ejectDeck('a')" :disabled="!deckA.mediaId" title="Eject">
                                <i class="bi bi-eject-fill"></i>
                            </button>
                        </div>

                        <!-- Hot Cues -->
                        <div class="d-flex justify-content-center gap-1 mb-2">
                            <template x-for="i in 8" :key="i">
                                <button class="btn btn-sm hotcue-btn"
                                        :class="getCueClass('a', i)"
                                        @click="handleCue('a', i)"
                                        @contextmenu.prevent="deleteCue('a', i)">
                                    <span x-text="i"></span>
                                </button>
                            </template>
                        </div>

                        <!-- Volume & Pitch -->
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Volume</label>
                                <input type="range" class="form-range" min="0" max="1" step="0.01"
                                       x-model="deckA.volume" @input="setVolume('a', $event.target.value)">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Pitch <span x-text="deckA.pitch?.toFixed(1) + '%'"></span></label>
                                <input type="range" class="form-range" min="-8" max="8" step="0.1"
                                       x-model="deckA.pitch" @input="setPitch('a', $event.target.value)">
                            </div>
                        </div>

                        <!-- EQ -->
                        <div class="row g-2 mt-1">
                            <div class="col-4">
                                <label class="form-label small mb-1 text-center d-block">HI</label>
                                <input type="range" class="form-range eq-slider" min="-12" max="12" step="0.5"
                                       x-model="deckA.eqHigh" @input="setEQ('a')" orient="vertical">
                            </div>
                            <div class="col-4">
                                <label class="form-label small mb-1 text-center d-block">MID</label>
                                <input type="range" class="form-range eq-slider" min="-12" max="12" step="0.5"
                                       x-model="deckA.eqMid" @input="setEQ('a')" orient="vertical">
                            </div>
                            <div class="col-4">
                                <label class="form-label small mb-1 text-center d-block">LO</label>
                                <input type="range" class="form-range eq-slider" min="-12" max="12" step="0.5"
                                       x-model="deckA.eqLow" @input="setEQ('a')" orient="vertical">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deck B -->
            <div class="col-lg-6">
                <div class="card deck-card" :class="{'deck-active': deckB.state === 'playing'}">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <span class="badge bg-danger">DECK B</span>
                        <div class="d-flex align-items-center gap-2">
                            <span class="small text-body-secondary" x-text="deckB.state"></span>
                            <span class="badge" :class="{'bg-success': deckB.state === 'playing', 'bg-warning': deckB.state === 'paused', 'bg-secondary': deckB.state === 'idle'}">
                                <i class="bi" :class="{'bi-play-fill': deckB.state === 'playing', 'bi-pause-fill': deckB.state === 'paused', 'bi-stop-fill': deckB.state !== 'playing' && deckB.state !== 'paused'}"></i>
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <!-- Track Info -->
                        <div class="d-flex align-items-start mb-2">
                            <div class="deck-artwork me-2" @click="loadToDeck('b')">
                                <img :src="deckB.mediaId ? '/dashboard/webdj/media/' + deckB.mediaId + '/artwork' : 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect fill=%22%231a1a2e%22 width=%22200%22 height=%22200%22/></svg>'"
                                     alt="Artwork" class="rounded">
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="fw-bold text-truncate" x-text="deckB.title || 'No Track Loaded'"></div>
                                <div class="small text-body-secondary text-truncate" x-text="deckB.artist || '-'"></div>
                                <div class="small">
                                    <span x-text="formatMs(deckB.positionMs)">0:00</span>
                                    <span class="text-body-secondary">/</span>
                                    <span class="text-body-secondary" x-text="formatMs(deckB.durationMs)">0:00</span>
                                    <span class="ms-2 badge bg-secondary" x-show="deckB.bpm" x-text="deckB.bpm?.toFixed(1) + ' BPM'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Waveform -->
                        <div class="waveform-container mb-2" @click="seekDeck('b', $event)">
                            <canvas id="waveform-b" width="400" height="60"></canvas>
                            <div class="waveform-position" :style="'left: ' + (deckB.positionMs / deckB.durationMs * 100) + '%'"></div>
                        </div>

                        <!-- Transport Controls -->
                        <div class="d-flex justify-content-center gap-1 mb-2">
                            <button class="btn btn-sm btn-outline-secondary" @click="seekDeck('b', null, 0)" title="Go to start">
                                <i class="bi bi-skip-start-fill"></i>
                            </button>
                            <button class="btn btn-sm" :class="deckB.state === 'playing' ? 'btn-warning' : 'btn-success'"
                                    @click="togglePlay('b')" :disabled="!deckB.mediaId">
                                <i class="bi" :class="deckB.state === 'playing' ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" @click="stopDeck('b')" :disabled="!deckB.mediaId" title="Cue">
                                <i class="bi bi-stop-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="ejectDeck('b')" :disabled="!deckB.mediaId" title="Eject">
                                <i class="bi bi-eject-fill"></i>
                            </button>
                        </div>

                        <!-- Hot Cues -->
                        <div class="d-flex justify-content-center gap-1 mb-2">
                            <template x-for="i in 8" :key="i">
                                <button class="btn btn-sm hotcue-btn"
                                        :class="getCueClass('b', i)"
                                        @click="handleCue('b', i)"
                                        @contextmenu.prevent="deleteCue('b', i)">
                                    <span x-text="i"></span>
                                </button>
                            </template>
                        </div>

                        <!-- Volume & Pitch -->
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Volume</label>
                                <input type="range" class="form-range" min="0" max="1" step="0.01"
                                       x-model="deckB.volume" @input="setVolume('b', $event.target.value)">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Pitch <span x-text="deckB.pitch?.toFixed(1) + '%'"></span></label>
                                <input type="range" class="form-range" min="-8" max="8" step="0.1"
                                       x-model="deckB.pitch" @input="setPitch('b', $event.target.value)">
                            </div>
                        </div>

                        <!-- EQ -->
                        <div class="row g-2 mt-1">
                            <div class="col-4">
                                <label class="form-label small mb-1 text-center d-block">HI</label>
                                <input type="range" class="form-range eq-slider" min="-12" max="12" step="0.5"
                                       x-model="deckB.eqHigh" @input="setEQ('b')" orient="vertical">
                            </div>
                            <div class="col-4">
                                <label class="form-label small mb-1 text-center d-block">MID</label>
                                <input type="range" class="form-range eq-slider" min="-12" max="12" step="0.5"
                                       x-model="deckB.eqMid" @input="setEQ('b')" orient="vertical">
                            </div>
                            <div class="col-4">
                                <label class="form-label small mb-1 text-center d-block">LO</label>
                                <input type="range" class="form-range eq-slider" min="-12" max="12" step="0.5"
                                       x-model="deckB.eqLow" @input="setEQ('b')" orient="vertical">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mixer Row -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="badge bg-primary">A</span>
                            <div class="flex-grow-1 mx-3">
                                <label class="form-label small mb-0 text-center d-block">Crossfader</label>
                                <input type="range" class="form-range crossfader" min="0" max="1" step="0.01"
                                       x-model="mixer.crossfader" @input="setCrossfader($event.target.value)">
                            </div>
                            <span class="badge bg-danger">B</span>
                            <div class="ms-4 d-flex align-items-center gap-2">
                                <label class="form-label small mb-0">Master</label>
                                <input type="range" class="form-range" style="width: 100px;" min="0" max="1" step="0.01"
                                       x-model="mixer.masterVolume" @input="setMasterVolume($event.target.value)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Broadcast Control Row -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card" :class="{'border-danger': isLive}">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-3">
                                <!-- Live Status Indicator -->
                                <div class="d-flex align-items-center gap-2">
                                    <span class="live-indicator" :class="{'live-active': isLive}"></span>
                                    <span class="fw-bold" :class="{'text-danger': isLive}" x-text="isLive ? 'ON AIR' : 'OFF AIR'"></span>
                                </div>

                                <!-- Mount Selector -->
                                <div class="d-flex align-items-center gap-2" x-show="!isLive">
                                    <label class="form-label small mb-0">Mount:</label>
                                    <select class="form-select form-select-sm" style="width: 180px;" x-model="selectedMount">
                                        <option value="">Select mount...</option>
                                        {{range .Data.Mounts}}
                                        <option value="{{.ID}}">{{.Name}}</option>
                                        {{end}}
                                    </select>
                                </div>

                                <!-- Current Mount Display (when live) -->
                                <div class="d-flex align-items-center gap-2" x-show="isLive">
                                    <span class="text-body-secondary small">Broadcasting to:</span>
                                    <span class="badge bg-danger" x-text="liveMountName"></span>
                                </div>
                            </div>

                            <div class="d-flex align-items-center gap-2">
                                <!-- Input Type Selector -->
                                <select class="form-select form-select-sm" style="width: 120px;" x-model="inputType" x-show="!isLive">
                                    <option value="webrtc">WebRTC</option>
                                    <option value="icecast">Icecast</option>
                                    <option value="rtp">RTP</option>
                                </select>

                                <!-- Go Live / Off Air Button -->
                                <button class="btn btn-sm px-4"
                                        :class="isLive ? 'btn-danger' : 'btn-success'"
                                        @click="toggleLive()"
                                        :disabled="!isLive && !selectedMount">
                                    <i class="bi me-1" :class="isLive ? 'bi-broadcast' : 'bi-broadcast'"></i>
                                    <span x-text="isLive ? 'Go Off Air' : 'Go Live'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Row -->
        <div class="row g-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0"><i class="bi bi-collection me-2"></i>Library</h6>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" style="width: 200px;"
                                   placeholder="Search..." x-model="searchQuery" @input.debounce.300ms="searchLibrary()">
                            <select class="form-select form-select-sm" style="width: 150px;" x-model="selectedPlaylist" @change="searchLibrary()">
                                <option value="">All Tracks</option>
                                {{range .Data.Playlists}}
                                <option value="{{.ID}}">{{.Name}}</option>
                                {{end}}
                            </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="sticky-top bg-body">
                                    <tr>
                                        <th></th>
                                        <th>Title</th>
                                        <th>Artist</th>
                                        <th>Duration</th>
                                        <th>BPM</th>
                                        <th>Load</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="track in libraryTracks" :key="track.id">
                                        <tr class="library-row" draggable="true"
                                            @dragstart="startDrag($event, track)"
                                            @dblclick="loadTrack('a', track.id)">
                                            <td style="width: 40px;">
                                                <img :src="'/dashboard/webdj/media/' + track.id + '/artwork'"
                                                     class="rounded" style="width: 32px; height: 32px; object-fit: cover;">
                                            </td>
                                            <td x-text="track.title"></td>
                                            <td class="text-body-secondary" x-text="track.artist"></td>
                                            <td x-text="formatMs(track.duration_ms)"></td>
                                            <td x-text="track.bpm ? track.bpm.toFixed(1) : '-'"></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" @click="loadTrack('a', track.id)" title="Load to Deck A">
                                                        A
                                                    </button>
                                                    <button class="btn btn-outline-danger" @click="loadTrack('b', track.id)" title="Load to Deck B">
                                                        B
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="libraryTracks.length === 0">
                                        <td colspan="6" class="text-center text-body-secondary py-4">
                                            <span x-show="!loading">No tracks found</span>
                                            <span x-show="loading"><i class="bi bi-arrow-repeat spin"></i> Loading...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.deck-card {
    transition: box-shadow 0.3s;
}
.deck-card.deck-active {
    box-shadow: 0 0 0 2px var(--bs-success);
}
.deck-artwork {
    width: 64px;
    height: 64px;
    cursor: pointer;
}
.deck-artwork img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.waveform-container {
    position: relative;
    height: 60px;
    background: var(--bs-tertiary-bg);
    border-radius: 4px;
    cursor: pointer;
    overflow: hidden;
}
.waveform-container canvas {
    width: 100%;
    height: 100%;
}
.waveform-position {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--bs-primary);
    pointer-events: none;
}
.hotcue-btn {
    width: 28px;
    height: 28px;
    padding: 0;
    font-size: 0.75rem;
    border-radius: 50%;
}
.hotcue-btn.has-cue {
    background-color: var(--bs-warning);
    border-color: var(--bs-warning);
    color: #000;
}
.eq-slider {
    writing-mode: vertical-lr;
    direction: rtl;
    height: 60px;
}
.crossfader {
    background: linear-gradient(to right, var(--bs-primary) 0%, var(--bs-primary) 50%, var(--bs-danger) 50%, var(--bs-danger) 100%);
    border-radius: 4px;
}
.library-row {
    cursor: grab;
}
.library-row:active {
    cursor: grabbing;
}
.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
[x-cloak] {
    display: none !important;
}
.live-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--bs-secondary);
    display: inline-block;
}
.live-indicator.live-active {
    background-color: var(--bs-danger);
    animation: pulse 1s ease-in-out infinite;
}
.irt-list .irt-item { border-bottom: 1px solid var(--bs-border-color); }
.irt-list .irt-item:last-child { border-bottom: 0; }
.irt-now-pill { font-size: 0.68rem; }
@keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
}
</style>

<script src="/static/js/webdj.js"></script>
<script>
(function() {
    const stationID = '{{.Station.ID}}';
    const canManageIRT = {{if or (stationRoleAtLeast .StationRole "manager") (roleAtLeast .User "manager")}}true{{else}}false{{end}};
    const nowPlayingEl = document.getElementById('webdjIrtNowPlaying');
    const upcomingEl = document.getElementById('webdjIrtUpcoming');
    const refreshBtn = document.getElementById('webdjIrtRefreshBtn');

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function renderNowPlaying(np) {
        if (!np || np.status !== 'playing') {
            return '<i class="bi bi-music-note me-1"></i>No active playback right now.';
        }
        const source = np.is_live_dj ? 'Live DJ' : 'Automation';
        return `
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="fw-semibold">${escapeHtml(np.artist || 'Unknown Artist')} - ${escapeHtml(np.title || 'Unknown Title')}</div>
                    <small class="text-body-secondary">${source}</small>
                </div>
                <span class="badge bg-success">LIVE</span>
            </div>
        `;
    }

    function renderEntries(entries) {
        const now = new Date();
        const sorted = (entries || []).slice().sort((a, b) => new Date(a.start) - new Date(b.start));
        if (sorted.length === 0) {
            return '<div class="text-body-secondary small">No scheduled entries in the next 6 hours.</div>';
        }
        return sorted.map(entry => {
            const start = new Date(entry.start);
            const end = new Date(entry.end);
            const isNow = start <= now && end > now;
            const nowPill = isNow ? '<span class="badge bg-danger irt-now-pill">NOW</span>' : '';
            const source = escapeHtml(entry.extendedProps?.source_label || entry.extendedProps?.source_type || 'Scheduled');
            const editBtn = canManageIRT
                ? `<a class="btn btn-sm btn-outline-primary" href="/dashboard/schedule?edit_entry=${encodeURIComponent(entry.id)}"><i class="bi bi-pencil"></i></a>`
                : '';
            const removeBtn = canManageIRT
                ? `<button class="btn btn-sm btn-outline-danger" onclick="removeWebDJIRTEntry('${entry.id}')"><i class="bi bi-trash"></i></button>`
                : '';
            return `
                <div class="irt-item py-2 d-flex align-items-center justify-content-between gap-2">
                    <div class="flex-grow-1">
                        <div class="fw-medium">${escapeHtml(entry.title || entry.extendedProps?.source_name || 'Untitled')} ${nowPill}</div>
                        <div class="small text-body-secondary">${source} â€¢ ${start.toLocaleTimeString()} - ${end.toLocaleTimeString()}</div>
                    </div>
                    <div class="d-flex gap-1">${editBtn}${removeBtn}</div>
                </div>
            `;
        }).join('');
    }

    async function refreshWebDJIRTPanel() {
        if (!nowPlayingEl || !upcomingEl) return;
        try {
            const now = new Date();
            const start = new Date(now.getTime() - 5 * 60 * 1000);
            const end = new Date(now.getTime() + 6 * 60 * 60 * 1000);
            const [npResp, eventsResp] = await Promise.all([
                fetch(`/api/v1/analytics/now-playing?station_id=${stationID}`),
                fetch(`/dashboard/schedule/events?start=${start.toISOString()}&end=${end.toISOString()}`),
            ]);
            const np = npResp.ok ? await npResp.json() : { status: 'idle' };
            const entries = eventsResp.ok ? await eventsResp.json() : [];
            nowPlayingEl.innerHTML = renderNowPlaying(np);
            upcomingEl.innerHTML = renderEntries(entries);
        } catch (err) {
            nowPlayingEl.innerHTML = '<span class="text-danger">Failed to load IRT state.</span>';
        }
    }

    window.removeWebDJIRTEntry = async function(entryID) {
        if (!confirm('Remove this scheduled entry from the IRT list?')) return;
        try {
            const resp = await fetch(`/dashboard/schedule/entries/${entryID}`, { method: 'DELETE' });
            if (!resp.ok) throw new Error('delete_failed');
            if (window.grimnirUtils?.showToast) {
                window.grimnirUtils.showToast('Entry removed', 'success');
            }
            refreshWebDJIRTPanel();
        } catch (err) {
            if (window.grimnirUtils?.showToast) {
                window.grimnirUtils.showToast('Failed to remove entry', 'error');
            }
        }
    };

    refreshBtn?.addEventListener('click', refreshWebDJIRTPanel);
    refreshWebDJIRTPanel();
    setInterval(refreshWebDJIRTPanel, 10000);
})();
</script>
{{end}}
