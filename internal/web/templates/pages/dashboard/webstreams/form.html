{{define "pages/dashboard/webstreams/form"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
{{$data := .Data}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/webstreams">Webstreams</a></li>
        {{if index $data "IsNew"}}
        <li class="breadcrumb-item active">New</li>
        {{else}}
        <li class="breadcrumb-item active">Edit</li>
        {{end}}
    </ol>
</nav>
{{end}}

{{define "main"}}
{{$data := .Data}}
{{$ws := index $data "Webstream"}}
{{$isNew := index $data "IsNew"}}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">
                <i class="bi bi-globe me-2"></i>
                {{if $isNew}}New Webstream{{else}}Edit Webstream{{end}}
            </h4>
            <a href="/dashboard/webstreams" class="btn btn-outline-secondary">
                <i class="bi bi-x me-1"></i>Cancel
            </a>
        </div>

        <form method="POST"
              action="{{if $isNew}}/dashboard/webstreams{{else}}/dashboard/webstreams/{{$ws.ID}}{{end}}"
              {{if $isNew}}
              hx-post="/dashboard/webstreams"
              {{else}}
              hx-put="/dashboard/webstreams/{{$ws.ID}}"
              {{end}}
              hx-swap="none">

            <!-- Basic Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name"
                               value="{{$ws.Name}}" required
                               placeholder="e.g. NPR News Stream">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"
                                  placeholder="Optional description">{{$ws.Description}}</textarea>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="active" id="active"
                               {{if $ws.Active}}checked{{end}}>
                        <label class="form-check-label" for="active">Active</label>
                        <div class="form-text">Only active webstreams can be scheduled.</div>
                    </div>
                </div>
            </div>

            <!-- Stream URLs -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Stream URLs</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">URLs <span class="text-danger">*</span></label>
                        <textarea class="form-control font-monospace" name="urls" rows="4" required
                                  placeholder="https://stream.example.com/live&#10;https://backup.example.com/live">{{range $i, $url := $ws.URLs}}{{if $i}}&#10;{{end}}{{$url}}{{end}}</textarea>
                        <div class="form-text">
                            Enter one URL per line. First URL is primary, subsequent URLs are failover targets.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Check Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Health Check</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="health_check_enabled" id="healthCheckEnabled"
                               {{if $ws.HealthCheckEnabled}}checked{{end}}>
                        <label class="form-check-label" for="healthCheckEnabled">Enable health checks</label>
                        <div class="form-text">Periodically check if the stream is available.</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Method</label>
                            <select class="form-select" name="health_check_method">
                                <option value="GET" {{if or (eq $ws.HealthCheckMethod "GET") (eq $ws.HealthCheckMethod "")}}selected{{end}}>GET (Recommended)</option>
                                <option value="HEAD" {{if eq $ws.HealthCheckMethod "HEAD"}}selected{{end}}>HEAD</option>
                            </select>
                            <div class="form-text">GET works with most stream servers. HEAD may not be supported.</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Interval (seconds)</label>
                            <input type="number" class="form-control" name="health_check_interval_sec"
                                   value="{{if $ws.HealthCheckInterval}}{{formatDurationSec $ws.HealthCheckInterval}}{{else}}30{{end}}"
                                   min="5" max="300">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Timeout (seconds)</label>
                            <input type="number" class="form-control" name="health_check_timeout_sec"
                                   value="{{if $ws.HealthCheckTimeout}}{{formatDurationSec $ws.HealthCheckTimeout}}{{else}}5{{end}}"
                                   min="1" max="30">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Failover Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Failover Settings</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="failover_enabled" id="failoverEnabled"
                               {{if $ws.FailoverEnabled}}checked{{end}}>
                        <label class="form-check-label" for="failoverEnabled">Enable automatic failover</label>
                        <div class="form-text">Automatically switch to backup URL when primary fails.</div>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="auto_recover_enabled" id="autoRecoverEnabled"
                               {{if $ws.AutoRecoverEnabled}}checked{{end}}>
                        <label class="form-check-label" for="autoRecoverEnabled">Auto-recover to primary</label>
                        <div class="form-text">Automatically return to primary URL when it becomes healthy again.</div>
                    </div>
                </div>
            </div>

            <!-- Connection Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Connection Settings</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Buffer Size (ms)</label>
                            <input type="number" class="form-control" name="buffer_size_ms"
                                   value="{{if $ws.BufferSizeMS}}{{$ws.BufferSizeMS}}{{else}}5000{{end}}"
                                   min="1000" max="30000">
                            <div class="form-text">Audio buffer in milliseconds</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Reconnect Delay (ms)</label>
                            <input type="number" class="form-control" name="reconnect_delay_ms"
                                   value="{{if $ws.ReconnectDelayMS}}{{$ws.ReconnectDelayMS}}{{else}}1000{{end}}"
                                   min="100" max="30000">
                            <div class="form-text">Wait time before reconnecting</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Max Reconnect Attempts</label>
                            <input type="number" class="form-control" name="max_reconnect_attempts"
                                   value="{{if $ws.MaxReconnectAttempts}}{{$ws.MaxReconnectAttempts}}{{else}}5{{end}}"
                                   min="1" max="100">
                            <div class="form-text">Before triggering failover</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>
                    {{if $isNew}}Create Webstream{{else}}Save Changes{{end}}
                </button>
                <a href="/dashboard/webstreams" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{{end}}
