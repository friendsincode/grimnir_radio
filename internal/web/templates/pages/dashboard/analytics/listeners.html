{{define "pages/dashboard/analytics/listeners"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/analytics">Analytics</a></li>
        <li class="breadcrumb-item active">Listener Stats</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
{{$data := .Data}}
{{$currentListeners := index $data "CurrentListeners"}}
{{$peakToday := index $data "PeakToday"}}
{{$avg24h := index $data "Avg24h"}}
{{$fromValue := index $data "FromValue"}}
{{$toValue := index $data "ToValue"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-headphones me-2"></i>Listener Stats</h4>
    <a href="/dashboard/analytics" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Analytics
    </a>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="/dashboard/analytics/listeners" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label mb-1">Start</label>
                <input type="datetime-local" class="form-control" name="from" value="{{$fromValue}}" required>
            </div>
            <div class="col-md-4">
                <label class="form-label mb-1">End</label>
                <input type="datetime-local" class="form-control" name="to" value="{{$toValue}}" required>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel me-1"></i>Apply
                </button>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" formaction="/dashboard/analytics/listeners/export.csv" class="btn btn-outline-secondary">
                    <i class="bi bi-download me-1"></i>Export CSV
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Current Listeners -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-4">
                <i class="bi bi-people fs-1 text-primary mb-3 d-block"></i>
                <h2 class="display-4 fw-bold mb-0">{{$currentListeners}}</h2>
                <p class="text-body-secondary mb-0">Current Listeners</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-4">
                <i class="bi bi-graph-up fs-1 text-success mb-3 d-block"></i>
                <h2 class="display-4 fw-bold mb-0">{{$peakToday}}</h2>
                <p class="text-body-secondary mb-0">Peak (Range)</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-4">
                <i class="bi bi-clock fs-1 text-info mb-3 d-block"></i>
                <h2 class="display-4 fw-bold mb-0">{{printf "%.1f" $avg24h}}</h2>
                <p class="text-body-secondary mb-0">Avg Listeners (Range)</p>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Listeners Over Time</h5>
    </div>
    <div class="card-body">
        <div id="listenersChart" class="bg-body-tertiary rounded p-3" style="height: 260px;">
            <div class="text-center text-body-secondary py-5">
                <i class="bi bi-bar-chart-line fs-1"></i>
                <p class="mb-0">Loading listener chart...</p>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
const listenerPoints = {{jsonMarshal (index .Data "SeriesPoints")}};

function esc(s) {
    return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function renderListenerChart(points) {
    const chartEl = document.getElementById('listenersChart');
    if (!chartEl) return;

    if (!Array.isArray(points) || points.length === 0) {
        chartEl.innerHTML = `
            <div class="text-center text-body-secondary py-5">
                <i class="bi bi-bar-chart-line fs-1"></i>
                <p class="mb-0">No listener data yet</p>
            </div>
        `;
        return;
    }

    const normalized = points.map((p) => ({
        timestamp: p.timestamp,
        listeners: Number.isFinite(Number(p.listeners)) ? Number(p.listeners) : 0,
    }));
    const max = Math.max(1, ...normalized.map((p) => p.listeners));
    const hasSamples = normalized.some((p) => p.listeners > 0);

    if (!hasSamples) {
        chartEl.innerHTML = `
            <div class="text-center text-body-secondary py-5">
                <i class="bi bi-bar-chart-line fs-1"></i>
                <p class="mb-0">No listener samples captured yet</p>
            </div>
        `;
        return;
    }

    const width = 960;
    const height = 220;
    const pad = { top: 12, right: 8, bottom: 28, left: 38 };
    const innerW = width - pad.left - pad.right;
    const innerH = height - pad.top - pad.bottom;
    const step = normalized.length > 1 ? innerW / (normalized.length - 1) : 0;
    const yFor = (value) => pad.top + innerH - Math.round((value / max) * innerH);

    const polyline = normalized.map((point, idx) => {
        const x = Math.round(pad.left + step * idx);
        const y = yFor(point.listeners);
        return `${x},${y}`;
    }).join(' ');

    const labelCount = 6;
    const labelStep = Math.max(1, Math.floor((normalized.length - 1) / labelCount));
    const xLabels = [];
    for (let i = 0; i < normalized.length; i += labelStep) {
        const dt = new Date(normalized[i].timestamp);
        const label = `${String(dt.getHours()).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}`;
        const x = Math.round(pad.left + step * i);
        xLabels.push(`<text x="${x}" y="${height - 8}" font-size="10" fill="currentColor" text-anchor="middle" opacity="0.65">${esc(label)}</text>`);
    }
    if (normalized.length > 1) {
        const lastIdx = normalized.length - 1;
        const dt = new Date(normalized[lastIdx].timestamp);
        const lastLabel = `${String(dt.getHours()).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}`;
        const lastX = Math.round(pad.left + step * lastIdx);
        xLabels.push(`<text x="${lastX}" y="${height - 8}" font-size="10" fill="currentColor" text-anchor="end" opacity="0.65">${esc(lastLabel)}</text>`);
    }

    const yTicks = 4;
    const yGrid = [];
    const yLabels = [];
    for (let i = 0; i <= yTicks; i++) {
        const v = Math.round((max * (yTicks - i)) / yTicks);
        const y = pad.top + Math.round((innerH * i) / yTicks);
        yGrid.push(`<line x1="${pad.left}" y1="${y}" x2="${width - pad.right}" y2="${y}" stroke="currentColor" stroke-opacity="0.12" stroke-width="1" />`);
        yLabels.push(`<text x="${pad.left - 6}" y="${y + 3}" font-size="10" fill="currentColor" text-anchor="end" opacity="0.65">${v}</text>`);
    }

    chartEl.innerHTML = `
        <div class="small text-body-secondary mb-2">Max: ${max} listeners</div>
        <svg viewBox="0 0 ${width} ${height}" width="100%" height="100%" aria-label="Listeners over time chart" role="img">
            ${yGrid.join('')}
            ${yLabels.join('')}
            <polyline fill="none" stroke="var(--bs-info)" stroke-width="2.5" points="${polyline}" />
            ${xLabels.join('')}
        </svg>
    `;
}

renderListenerChart(listenerPoints);
</script>
{{end}}
