{{define "pages/dashboard/admin/audit"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/admin/logs">Admin</a></li>
        <li class="breadcrumb-item active">Audit Logs</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-shield-check me-2"></i>Platform Audit Logs</h4>
    <button type="button" class="btn btn-outline-secondary" onclick="refreshLogs()">
        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label small">Action</label>
                <select class="form-select form-select-sm" id="filterAction" onchange="refreshLogs()">
                    <option value="">All Actions</option>
                    <option value="station.create">Station Created</option>
                    <option value="priority.emergency">Priority Emergency</option>
                    <option value="priority.override">Priority Override</option>
                    <option value="priority.release">Priority Released</option>
                    <option value="live.connect">DJ Connected</option>
                    <option value="live.disconnect">DJ Disconnected</option>
                    <option value="live.handover">Live Handover</option>
                    <option value="schedule.update">Schedule Update</option>
                    <option value="schedule.refresh">Schedule Refresh</option>
                    <option value="webstream.create">Webstream Created</option>
                    <option value="webstream.update">Webstream Updated</option>
                    <option value="webstream.delete">Webstream Deleted</option>
                    <option value="webstream.failover">Webstream Failover</option>
                    <option value="api_key.create">API Key Created</option>
                    <option value="api_key.revoke">API Key Revoked</option>
                    <option value="landingpage.publish">Landing Page Published</option>
                    <option value="landingpage.update">Landing Page Updated</option>
                    <option value="landingpage.restore">Landing Page Restored</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Station</label>
                <select class="form-select form-select-sm" id="filterStation" onchange="refreshLogs()">
                    <option value="">All Stations</option>
                    {{range .Stations}}
                    <option value="{{.ID}}">{{.Name}}</option>
                    {{end}}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Start Date</label>
                <input type="date" class="form-control form-control-sm" id="filterStart" onchange="refreshLogs()">
            </div>
            <div class="col-md-3">
                <label class="form-label small">End Date</label>
                <input type="date" class="form-control form-control-sm" id="filterEnd" onchange="refreshLogs()">
            </div>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card bg-body-tertiary">
            <div class="card-body text-center py-3">
                <div class="fs-4 fw-bold text-primary" id="statTotal">-</div>
                <div class="small text-body-secondary">Total Entries</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-body-tertiary">
            <div class="card-body text-center py-3">
                <div class="fs-4 fw-bold text-warning" id="statPriority">-</div>
                <div class="small text-body-secondary">Priority Events</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-body-tertiary">
            <div class="card-body text-center py-3">
                <div class="fs-4 fw-bold text-success" id="statLive">-</div>
                <div class="small text-body-secondary">Live Events</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-body-tertiary">
            <div class="card-body text-center py-3">
                <div class="fs-4 fw-bold text-info" id="statSchedule">-</div>
                <div class="small text-body-secondary">Schedule Events</div>
            </div>
        </div>
    </div>
</div>

<!-- Audit Log Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Audit Entries</span>
        <span class="badge bg-secondary" id="entryCount">0 entries</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-sm mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width: 160px;">Timestamp</th>
                    <th style="width: 140px;">Action</th>
                    <th>User</th>
                    <th>Station</th>
                    <th>Resource</th>
                    <th>Details</th>
                    <th style="width: 100px;">IP Address</th>
                </tr>
            </thead>
            <tbody id="auditTable">
                <tr>
                    <td colspan="7" class="text-center text-body-secondary py-4">
                        <i class="bi bi-hourglass-split me-2"></i>Loading...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<nav class="mt-3" id="pagination"></nav>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Audit Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="detailContent" class="bg-body-tertiary p-3 rounded small" style="max-height: 400px; overflow: auto;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
const wsToken = '{{.WSToken}}';
let detailModal;
let currentPage = 1;
const pageSize = 50;

document.addEventListener('DOMContentLoaded', function() {
    detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    refreshLogs();
});

function getActionBadge(action) {
    const badges = {
        'station.create': 'bg-primary',
        'priority.emergency': 'bg-danger',
        'priority.override': 'bg-warning text-dark',
        'priority.release': 'bg-secondary',
        'live.connect': 'bg-success',
        'live.disconnect': 'bg-secondary',
        'live.handover': 'bg-info',
        'schedule.update': 'bg-info',
        'schedule.refresh': 'bg-info',
        'webstream.create': 'bg-primary',
        'webstream.update': 'bg-info',
        'webstream.delete': 'bg-danger',
        'webstream.failover': 'bg-warning text-dark',
        'api_key.create': 'bg-success',
        'api_key.revoke': 'bg-danger',
        'landingpage.publish': 'bg-success',
        'landingpage.update': 'bg-info',
        'landingpage.restore': 'bg-warning text-dark'
    };
    return badges[action] || 'bg-secondary';
}

function formatAction(action) {
    return action.replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function refreshLogs() {
    const action = document.getElementById('filterAction').value;
    const stationId = document.getElementById('filterStation').value;
    const startDate = document.getElementById('filterStart').value;
    const endDate = document.getElementById('filterEnd').value;

    let url = `/api/v1/audit?limit=${pageSize}&offset=${(currentPage - 1) * pageSize}`;
    if (action) url += `&action=${encodeURIComponent(action)}`;
    if (stationId) url += `&station_id=${encodeURIComponent(stationId)}`;
    if (startDate) url += `&start=${encodeURIComponent(startDate)}T00:00:00Z`;
    if (endDate) url += `&end=${encodeURIComponent(endDate)}T23:59:59Z`;

    fetch(url, {
        headers: { 'Authorization': 'Bearer ' + wsToken }
    })
    .then(r => r.json())
    .then(data => {
        const entries = data.audit_logs || [];
        renderLogs(entries);
        document.getElementById('entryCount').textContent = (data.total || 0) + ' entries';
        document.getElementById('statTotal').textContent = data.total || 0;

        // Count by type
        let priority = 0, live = 0, schedule = 0;
        entries.forEach(e => {
            if (e.action.startsWith('priority.')) priority++;
            else if (e.action.startsWith('live.')) live++;
            else if (e.action.startsWith('schedule.')) schedule++;
        });
        document.getElementById('statPriority').textContent = priority;
        document.getElementById('statLive').textContent = live;
        document.getElementById('statSchedule').textContent = schedule;

        renderPagination(data.total || 0);
    })
    .catch(err => {
        console.error('Failed to fetch audit logs:', err);
        document.getElementById('auditTable').innerHTML = `
            <tr><td colspan="7" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle me-2"></i>Failed to load audit logs
            </td></tr>`;
    });
}

let auditEntries = [];

function renderLogs(entries) {
    auditEntries = entries || [];
    const tbody = document.getElementById('auditTable');
    if (!auditEntries || auditEntries.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="7" class="text-center text-body-secondary py-4">
                <i class="bi bi-inbox me-2"></i>No audit entries found
            </td></tr>`;
        return;
    }

    tbody.innerHTML = auditEntries.map((entry, idx) => `
        <tr style="cursor: pointer;" onclick="showDetail(${idx})">
            <td class="font-monospace small">${new Date(entry.timestamp).toLocaleString()}</td>
            <td><span class="badge ${getActionBadge(entry.action)}">${formatAction(entry.action)}</span></td>
            <td>${escapeHtml(entry.user_email) || '<span class="text-body-secondary">-</span>'}</td>
            <td>${entry.station_id ? '<span class="font-monospace small">' + entry.station_id.substring(0, 8) + '...</span>' : '<span class="text-body-secondary">-</span>'}</td>
            <td>${entry.resource_type ? escapeHtml(entry.resource_type) + (entry.resource_id ? ' <span class="font-monospace small">' + entry.resource_id.substring(0, 8) + '...</span>' : '') : '<span class="text-body-secondary">-</span>'}</td>
            <td class="small">${Object.keys(entry.details || {}).length > 0 ? '<i class="bi bi-file-text text-info"></i>' : '-'}</td>
            <td class="font-monospace small">${escapeHtml(entry.ip_address) || '-'}</td>
        </tr>
    `).join('');
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showDetail(idx) {
    const entry = auditEntries[idx];
    if (entry) {
        document.getElementById('detailContent').textContent = JSON.stringify(entry, null, 2);
        detailModal.show();
    }
}

function renderPagination(total) {
    const totalPages = Math.ceil(total / pageSize);
    if (totalPages <= 1) {
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    let html = '<ul class="pagination pagination-sm justify-content-center">';
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">Previous</a>
    </li>`;

    for (let i = 1; i <= totalPages && i <= 10; i++) {
        html += `<li class="page-item ${currentPage === i ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
        </li>`;
    }

    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">Next</a>
    </li>`;
    html += '</ul>';

    document.getElementById('pagination').innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    refreshLogs();
}
</script>
{{end}}
