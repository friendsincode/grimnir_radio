{{define "pages/dashboard/admin/logs"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "main"}}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="bi bi-terminal me-2"></i>System Logs</h1>
        <div class="d-flex gap-2 align-items-center">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="toggleAutoRefresh">
                <label class="form-check-label small" for="toggleAutoRefresh">Auto-refresh</label>
            </div>
            <button class="btn btn-outline-secondary" onclick="refreshLogs()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
            <button class="btn btn-outline-danger" onclick="clearLogs()">
                <i class="bi bi-trash me-1"></i>Clear
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label small">Level</label>
                    <select class="form-select form-select-sm" id="filterLevel">
                        <option value="">All Levels</option>
                        <option value="debug">Debug</option>
                        <option value="info">Info</option>
                        <option value="warn">Warning</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Component</label>
                    <select class="form-select form-select-sm" id="filterComponent">
                        <option value="">All Components</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Search</label>
                    <input type="text" class="form-control form-control-sm" id="filterSearch" placeholder="Search messages...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Timeframe</label>
                    <select class="form-select form-select-sm" id="filterTime">
                        <option value="" selected>All</option>
                        <option value="5m">Last 5 min</option>
                        <option value="15m">Last 15 min</option>
                        <option value="1h">Last 1 hour</option>
                        <option value="6h">Last 6 hours</option>
                        <option value="24h">Last 24 hours</option>
                        <option value="7d">Last 7 days</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Limit</label>
                    <select class="form-select form-select-sm" id="filterLimit">
                        <option value="100">100</option>
                        <option value="250">250</option>
                        <option value="500" selected>500</option>
                        <option value="1000">1000</option>
                        <option value="2500">2500</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-primary btn-sm w-100" onclick="refreshLogs()">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4" id="logStats">
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between">
                        <span>Total</span>
                        <span id="statTotal">-</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between">
                        <span>Debug</span>
                        <span id="statDebug">-</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between">
                        <span>Info</span>
                        <span id="statInfo">-</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-dark">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between">
                        <span>Warn</span>
                        <span id="statWarn">-</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between">
                        <span>Error</span>
                        <span id="statError">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log entries -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Log Entries</span>
            <span class="badge bg-secondary" id="entryCount">0 entries</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-sm table-striped table-hover mb-0" id="logTable">
                    <thead class="sticky-top bg-dark">
                        <tr>
                            <th style="width: 160px;">Timestamp</th>
                            <th style="width: 70px;">Level</th>
                            <th style="width: 100px;">Station</th>
                            <th style="width: 120px;">Component</th>
                            <th>Message</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="logBody">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-hourglass-split me-2"></i>Loading logs...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="logDetailContent" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow: auto; font-size: 0.85em;"></pre>
            </div>
        </div>
    </div>
</div>

<style>
.log-level-debug { color: #0dcaf0; }
.log-level-info { color: #198754; }
.log-level-warn { color: #ffc107; }
.log-level-error { color: #dc3545; font-weight: bold; }
#logTable tbody tr { font-size: 0.85em; }
#logTable td { vertical-align: middle; }
.log-row-clickable { cursor: pointer; }
.log-message {
    max-width: 600px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>

<script>
const wsToken = '{{.WSToken}}';
let logDetailModal;
let stationNames = {};
let autoRefreshTimer = null;
let currentEntries = [];
const autoRefreshMs = 10000;

document.addEventListener('DOMContentLoaded', function() {
    logDetailModal = new bootstrap.Modal(document.getElementById('logDetailModal'));
    loadComponents();
    loadStats();
    refreshLogs();

    document.getElementById('toggleAutoRefresh').addEventListener('change', function(e) {
        setAutoRefreshEnabled(e.target.checked);
    });

    // Filter on Enter key
    document.getElementById('filterSearch').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') refreshLogs();
    });
});

function setAutoRefreshEnabled(enabled) {
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
    if (enabled) {
        autoRefreshTimer = setInterval(refreshLogs, autoRefreshMs);
    }
}

function parseTimeframeToMs(v) {
    if (!v) return 0;
    const n = parseInt(v, 10);
    if (Number.isNaN(n) || n <= 0) return 0;
    if (v.endsWith('m')) return n * 60 * 1000;
    if (v.endsWith('h')) return n * 60 * 60 * 1000;
    if (v.endsWith('d')) return n * 24 * 60 * 60 * 1000;
    return 0;
}

function loadComponents() {
    fetch('/api/v1/system/logs/components', {
        headers: { 'Authorization': 'Bearer ' + wsToken }
    })
    .then(r => r.json())
    .then(data => {
        const select = document.getElementById('filterComponent');
        select.innerHTML = '<option value="">All Components</option>';
        if (data.components) {
            data.components.sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                select.appendChild(opt);
            });
        }
    })
    .catch(err => console.error('Failed to load components:', err));
}

function loadStats() {
    fetch('/api/v1/system/logs/stats', {
        headers: { 'Authorization': 'Bearer ' + wsToken }
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('statTotal').textContent = data.count || 0;
        document.getElementById('statDebug').textContent = data.level_count?.debug || 0;
        document.getElementById('statInfo').textContent = data.level_count?.info || 0;
        document.getElementById('statWarn').textContent = data.level_count?.warn || 0;
        document.getElementById('statError').textContent = data.level_count?.error || 0;
    })
    .catch(err => console.error('Failed to load stats:', err));
}

function refreshLogs() {
    const level = document.getElementById('filterLevel').value;
    const component = document.getElementById('filterComponent').value;
    const search = document.getElementById('filterSearch').value;
    const timeframe = document.getElementById('filterTime').value;
    const limit = document.getElementById('filterLimit').value;

    let url = `/api/v1/system/logs?limit=${limit}`;
    if (level) url += `&level=${encodeURIComponent(level)}`;
    if (component) url += `&component=${encodeURIComponent(component)}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    const ms = parseTimeframeToMs(timeframe);
    if (ms > 0) {
        const since = new Date(Date.now() - ms).toISOString();
        url += `&since=${encodeURIComponent(since)}`;
    }

    fetch(url, {
        headers: { 'Authorization': 'Bearer ' + wsToken }
    })
    .then(r => r.json())
    .then(data => {
        stationNames = data.station_names || {};
        renderLogs(data.entries || []);
        document.getElementById('entryCount').textContent = (data.count || 0) + ' entries';
        loadStats(); // Also refresh stats
    })
    .catch(err => {
        console.error('Failed to load logs:', err);
        document.getElementById('logBody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle me-2"></i>Failed to load logs
                </td>
            </tr>
        `;
    });
}

function renderLogs(entries) {
    const tbody = document.getElementById('logBody');
    currentEntries = entries || [];

    if (!entries || entries.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-inbox me-2"></i>No log entries found
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = entries.map((entry, idx) => {
        const ts = new Date(entry.timestamp).toLocaleString();
        const levelBadge = getLevelBadge(entry.level);
        const message = escapeHtml(entry.message || '(no message)');
        const component = entry.component || '-';
        const stationId = entry.fields?.station_id || entry.fields?.stationID || entry.fields?.stationId || '';
        const stationName = stationId ? (stationNames[stationId] || stationId.substring(0, 8) + '...') : '-';
        let rowClass = '';
        if (entry.level === 'error') rowClass = 'table-danger';
        if (entry.level === 'warn') rowClass = 'table-warning';

        return `
            <tr class="log-row-clickable ${rowClass}" onclick="showLogDetailByIndex(${idx})" title="Click to view details">
                <td class="text-muted">${ts}</td>
                <td>${levelBadge}</td>
                <td class="small">${escapeHtml(stationName)}</td>
                <td><code class="small">${escapeHtml(component)}</code></td>
                <td class="log-message" title="${escapeHtml(entry.message)}">${message}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="showLogDetailByIndex(${idx}, event)">
                        <i class="bi bi-code"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getLevelBadge(level) {
    const badges = {
        'debug': '<span class="badge bg-info">DBG</span>',
        'info': '<span class="badge bg-success">INF</span>',
        'warn': '<span class="badge bg-warning text-dark">WRN</span>',
        'error': '<span class="badge bg-danger">ERR</span>',
    };
    return badges[level] || `<span class="badge bg-secondary">${level}</span>`;
}

function showLogDetailByIndex(index, e) {
    if (e) e.stopPropagation();
    const entry = currentEntries[index];
    if (!entry) return;
    document.getElementById('logDetailContent').textContent = buildLogDetailText(entry);
    logDetailModal.show();
}

function buildLogDetailText(entry) {
    const timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'Unknown';
    const insight = analyzeLogEntry(entry);
    const causes = derivePossibleCauses(entry);
    const lines = [
        'Plain-English Summary',
        '---------------------',
        insight.summary,
        '',
        'What This Means',
        '---------------',
        insight.meaning,
        '',
        'Possible Causes',
        '---------------',
        ...causes.map((cause, i) => `${i + 1}. ${cause}`),
        '',
        'How To Resolve',
        '--------------',
        ...insight.actions.map((action, i) => `${i + 1}. ${action}`),
        '',
        'Technical Context',
        '-----------------',
        `Timestamp: ${timestamp}`,
        `Level: ${entry.level || '-'}`,
        `Component: ${entry.component || '-'}`,
        `Message: ${entry.message || '(no message)'}`,
    ];

    const errorField = entry.fields?.error || entry.fields?.err || entry.error;
    if (errorField) {
        lines.push(`Error: ${typeof errorField === 'string' ? errorField : JSON.stringify(errorField)}`);
    }

    lines.push('');
    lines.push('Nerd Details (Raw JSON):');
    lines.push(JSON.stringify(entry, null, 2));
    return lines.join('\n');
}

function analyzeLogEntry(entry) {
    const level = (entry.level || '').toLowerCase();
    const component = (entry.component || '').toLowerCase();
    const message = (entry.message || '').toLowerCase();
    const fieldsText = JSON.stringify(entry.fields || {}).toLowerCase();
    const combined = `${component} ${message} ${fieldsText}`;

    const out = {
        summary: 'System activity log entry.',
        meaning: 'This is a normal system event record.',
        actions: ['No immediate action needed.'],
    };

    if (level === 'debug') {
        out.summary = 'Debug log captured for troubleshooting.';
        out.meaning = 'This is diagnostic detail for deeper investigation, not usually a production issue by itself.';
        out.actions = [
            'No action is required unless you are actively investigating a problem.',
            'If users report an issue, review nearby warning/error logs in the same timeframe.',
        ];
    }
    if (level === 'info') {
        out.summary = 'Informational event.';
        out.meaning = 'The system is reporting a normal operation or state change.';
        out.actions = [
            'No action is usually needed.',
            'If behavior is unexpected, check related entries before and after this timestamp.',
        ];
    }
    if (level === 'warn') {
        out.summary = 'Warning: something may need attention soon.';
        out.meaning = 'The system continued running, but this could lead to a failure if ignored.';
        out.actions = [
            'Review the component and message for the first failing dependency.',
            'Fix configuration/data issues now to prevent escalation to errors.',
        ];
    }
    if (level === 'error') {
        out.summary = 'Error: operation failed.';
        out.meaning = 'A requested action did not complete successfully.';
        out.actions = [
            'Identify the failing component and operation in this log entry.',
            'Retry after fixing the root cause shown in the message/fields.',
            'If repeated, escalate with this full log entry.',
        ];
    }

    if (combined.includes('overlap')) {
        out.summary = 'Schedule overlap detected.';
        out.meaning = 'Two or more items are scheduled for the same time window.';
        out.actions = [
            'Open Schedule -> Validate to see conflicting item IDs and times.',
            'Move, shorten, or remove one of the overlapping items.',
            'Re-run validation to confirm overlap count returns to zero.',
        ];
    } else if (combined.includes('validation failed')) {
        out.summary = 'Schedule validation failed to complete.';
        out.meaning = 'The validator could not finish, likely due to a data or service issue.';
        out.actions = [
            'Retry validation once.',
            'Check database and scheduler health logs around this timestamp.',
            'If it persists, capture this entry and contact support/engineering.',
        ];
    } else if (combined.includes('unauthorized') || combined.includes('forbidden') || combined.includes('permission') || combined.includes('401') || combined.includes('403')) {
        out.summary = 'Access/permission issue.';
        out.meaning = 'The request was blocked by authentication or role permissions.';
        out.actions = [
            'Confirm the user has the correct station/platform role.',
            'Verify token/session is valid and not expired.',
            'Retry after re-authenticating.',
        ];
    } else if (combined.includes('not found') || combined.includes('404')) {
        out.summary = 'Requested resource was not found.';
        out.meaning = 'The item ID or endpoint path does not exist or was removed.';
        out.actions = [
            'Verify the ID/path used by the action.',
            'Confirm the resource still exists in the UI/database.',
            'Retry using the correct station/context.',
        ];
    } else if (combined.includes('timeout') || combined.includes('timed out') || combined.includes('deadline exceeded')) {
        out.summary = 'Operation timed out.';
        out.meaning = 'The dependency did not respond before the timeout limit.';
        out.actions = [
            'Check network/connectivity to the dependency.',
            'Check dependency health (database/redis/web service).',
            'Retry once load has stabilized.',
        ];
    } else if (combined.includes('database') || combined.includes(' db ') || combined.includes('sql') || combined.includes('gorm') || combined.includes('postgres') || combined.includes('sqlite')) {
        out.summary = 'Database-related issue.';
        out.meaning = 'A query or database connection failed or degraded.';
        out.actions = [
            'Check database availability and credentials.',
            'Inspect query/data constraints indicated in the message.',
            'Retry after database health is restored.',
        ];
    } else if (combined.includes('redis') || combined.includes('nats') || combined.includes('websocket') || combined.includes('dial tcp') || combined.includes('connection refused')) {
        out.summary = 'Service connectivity issue.';
        out.meaning = 'The app could not reach a required internal/external service.';
        out.actions = [
            'Confirm target service is running and reachable.',
            'Verify host/port settings and firewall/network policies.',
            'Retry after connectivity is restored.',
        ];
    }

    return out;
}

function derivePossibleCauses(entry) {
    const component = (entry.component || '').toLowerCase();
    const message = (entry.message || '').toLowerCase();
    const fieldsText = JSON.stringify(entry.fields || {}).toLowerCase();
    const combined = `${component} ${message} ${fieldsText}`;

    if (combined.includes('overlap')) {
        return [
            'Two schedule entries were set for overlapping times.',
            'A recurring event and a one-off event collided in the same window.',
        ];
    }
    if (combined.includes('unauthorized') || combined.includes('forbidden') || combined.includes('permission') || combined.includes('401') || combined.includes('403')) {
        return [
            'User/session token expired or invalid.',
            'User role does not have required permissions for the action.',
        ];
    }
    if (combined.includes('timeout') || combined.includes('timed out') || combined.includes('deadline exceeded')) {
        return [
            'Dependency service is slow or overloaded.',
            'Temporary network instability between services.',
        ];
    }
    if (combined.includes('database') || combined.includes(' db ') || combined.includes('sql') || combined.includes('gorm') || combined.includes('postgres') || combined.includes('sqlite')) {
        return [
            'Database connection issue or transient outage.',
            'Constraint/query/data mismatch during write/read.',
        ];
    }
    if (combined.includes('redis') || combined.includes('nats') || combined.includes('websocket') || combined.includes('dial tcp') || combined.includes('connection refused')) {
        return [
            'Target service is down or unreachable on configured host/port.',
            'Network policy/firewall blocked service traffic.',
        ];
    }
    if ((entry.level || '').toLowerCase() === 'warn') {
        return [
            'Configuration mismatch that did not yet fully fail.',
            'Resource limits approaching threshold.',
        ];
    }
    if ((entry.level || '').toLowerCase() === 'error') {
        return [
            'Operation dependency failed at runtime.',
            'Invalid state or invalid input data for the requested action.',
        ];
    }
    return [
        'Normal operational event or status update.',
        'Diagnostic output generated by component instrumentation.',
    ];
}

function clearLogs() {
    if (!confirm('Are you sure you want to clear all logs from the buffer?')) return;

    fetch('/api/v1/system/logs', {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + wsToken }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            refreshLogs();
            loadStats();
        }
    })
    .catch(err => console.error('Failed to clear logs:', err));
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{{end}}
