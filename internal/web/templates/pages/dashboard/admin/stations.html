{{define "pages/dashboard/admin/stations"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item">Platform Admin</li>
        <li class="breadcrumb-item active">All Stations</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-broadcast-pin me-2"></i>All Stations</h4>
    <a href="/dashboard/stations/new" class="btn btn-primary">
        <i class="bi bi-plus-lg me-2"></i>New Station
    </a>
</div>

<!-- Bulk Actions Toolbar -->
<div class="card mb-3 d-none" id="bulkActionsBar">
    <div class="card-body py-2">
        <div class="d-flex align-items-center gap-3">
            <span class="text-body-secondary">
                <strong id="selectedCount">0</strong> selected
            </span>
            <div class="vr"></div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-success" onclick="bulkAction('activate')" title="Activate selected">
                    <i class="bi bi-play-fill me-1"></i>Activate
                </button>
                <button class="btn btn-outline-warning" onclick="bulkAction('deactivate')" title="Deactivate selected">
                    <i class="bi bi-pause-fill me-1"></i>Deactivate
                </button>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info" onclick="bulkAction('make_public')" title="Make public">
                    <i class="bi bi-globe me-1"></i>Public
                </button>
                <button class="btn btn-outline-secondary" onclick="bulkAction('make_private')" title="Make private">
                    <i class="bi bi-lock me-1"></i>Private
                </button>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-success" onclick="bulkAction('approve')" title="Approve selected">
                    <i class="bi bi-shield-check me-1"></i>Approve
                </button>
                <button class="btn btn-outline-secondary" onclick="bulkAction('unapprove')" title="Revoke approval">
                    <i class="bi bi-shield-x me-1"></i>Unapprove
                </button>
            </div>
            <div class="vr"></div>
            <button class="btn btn-sm btn-outline-danger" onclick="bulkAction('delete')" title="Delete selected">
                <i class="bi bi-trash me-1"></i>Delete
            </button>
            <div class="ms-auto">
                <button class="btn btn-sm btn-link text-body-secondary" onclick="clearSelection()" title="Clear selection">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="form-check-input" id="selectAll"
                               onchange="toggleSelectAll(this)" title="Select all">
                    </th>
                    <th>Station</th>
                    <th>Owner</th>
                    <th>Status</th>
                    <th>Visibility</th>
                    <th>Approval</th>
                    <th>Created</th>
                    <th style="width: 180px;"></th>
                </tr>
            </thead>
            <tbody>
                {{range .Data.AllStations}}
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input station-checkbox"
                               value="{{.ID}}" onchange="updateSelection()">
                    </td>
                    <td>
                        <i class="bi bi-broadcast me-2"></i>
                        <strong>{{.Name}}</strong>
                        {{if .Description}}
                        <br><small class="text-body-secondary">{{truncate .Description 50}}</small>
                        {{end}}
                    </td>
                    <td>
                        {{if .Owner}}
                        <span class="badge bg-secondary" title="Station owner">{{.Owner.Email}}</span>
                        {{else}}
                        <span class="text-body-secondary">-</span>
                        {{end}}
                    </td>
                    <td>
                        {{if .Active}}
                        <span class="badge bg-success" title="Station is active and can broadcast"><i class="bi bi-check-circle me-1"></i>Active</span>
                        {{else}}
                        <span class="badge bg-danger" title="Station is inactive"><i class="bi bi-x-circle me-1"></i>Inactive</span>
                        {{end}}
                    </td>
                    <td>
                        {{if .Public}}
                        <span class="badge bg-info" title="Visible in public directory"><i class="bi bi-globe me-1"></i>Public</span>
                        {{else}}
                        <span class="badge bg-secondary" title="Hidden from public directory"><i class="bi bi-lock me-1"></i>Private</span>
                        {{end}}
                    </td>
                    <td>
                        {{if .Approved}}
                        <span class="badge bg-success" title="Approved to go live"><i class="bi bi-shield-check me-1"></i>Approved</span>
                        {{else}}
                        <span class="badge bg-warning text-dark" title="Awaiting approval"><i class="bi bi-hourglass-split me-1"></i>Pending</span>
                        {{end}}
                    </td>
                    <td><small class="text-body-secondary">{{formatTime .CreatedAt}}</small></td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn {{if .Active}}btn-outline-warning{{else}}btn-outline-success{{end}}"
                                    hx-post="/dashboard/admin/stations/{{.ID}}/toggle-active"
                                    hx-confirm="{{if .Active}}Deactivate{{else}}Activate{{end}} this station?"
                                    title="{{if .Active}}Deactivate{{else}}Activate{{end}}">
                                {{if .Active}}<i class="bi bi-pause-fill"></i>{{else}}<i class="bi bi-play-fill"></i>{{end}}
                            </button>
                            <button class="btn {{if .Public}}btn-outline-secondary{{else}}btn-outline-info{{end}}"
                                    hx-post="/dashboard/admin/stations/{{.ID}}/toggle-public"
                                    title="{{if .Public}}Make Private{{else}}Make Public{{end}}">
                                {{if .Public}}<i class="bi bi-lock"></i>{{else}}<i class="bi bi-globe"></i>{{end}}
                            </button>
                            <button class="btn {{if .Approved}}btn-outline-secondary{{else}}btn-outline-success{{end}}"
                                    hx-post="/dashboard/admin/stations/{{.ID}}/toggle-approved"
                                    title="{{if .Approved}}Revoke Approval{{else}}Approve{{end}}">
                                {{if .Approved}}<i class="bi bi-shield-x"></i>{{else}}<i class="bi bi-shield-check"></i>{{end}}
                            </button>
                            <a href="/dashboard/stations/{{.ID}}" class="btn btn-outline-secondary" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button class="btn btn-outline-danger"
                                    hx-delete="/dashboard/stations/{{.ID}}"
                                    hx-confirm="Delete this station? This cannot be undone."
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="8" class="text-center py-5 text-body-secondary">
                        No stations found
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-4">
    <div class="card bg-body-tertiary">
        <div class="card-body">
            <h6 class="card-title"><i class="bi bi-info-circle me-2"></i>Status Legend</h6>
            <div class="row">
                <div class="col-md-4">
                    <p class="mb-1"><strong>Active/Inactive:</strong> Controls whether the station can broadcast</p>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong>Public/Private:</strong> Public stations appear in the station directory</p>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong>Approved/Pending:</strong> Stations need approval before they can go live</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function getSelectedIds() {
    return Array.from(document.querySelectorAll('.station-checkbox:checked')).map(cb => cb.value);
}

function updateSelection() {
    const selected = getSelectedIds();
    const bar = document.getElementById('bulkActionsBar');
    const count = document.getElementById('selectedCount');
    const selectAll = document.getElementById('selectAll');
    const total = document.querySelectorAll('.station-checkbox').length;

    if (selected.length > 0) {
        bar.classList.remove('d-none');
        count.textContent = selected.length;
    } else {
        bar.classList.add('d-none');
    }

    selectAll.checked = selected.length === total && total > 0;
    selectAll.indeterminate = selected.length > 0 && selected.length < total;
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.station-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelection();
}

function clearSelection() {
    document.querySelectorAll('.station-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

function bulkAction(action) {
    const ids = getSelectedIds();
    if (ids.length === 0) return;

    let message = '';
    switch(action) {
        case 'activate': message = `Activate ${ids.length} station(s)?`; break;
        case 'deactivate': message = `Deactivate ${ids.length} station(s)?`; break;
        case 'make_public': message = `Make ${ids.length} station(s) public?`; break;
        case 'make_private': message = `Make ${ids.length} station(s) private?`; break;
        case 'approve': message = `Approve ${ids.length} station(s)?`; break;
        case 'unapprove': message = `Revoke approval for ${ids.length} station(s)?`; break;
        case 'delete': message = `DELETE ${ids.length} station(s)? This cannot be undone!`; break;
    }

    if (!confirm(message)) return;

    fetch('/dashboard/admin/stations/bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        },
        body: JSON.stringify({ action: action, ids: ids })
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            response.text().then(text => alert('Error: ' + text));
        }
    }).catch(err => alert('Error: ' + err));
}
</script>
{{end}}
