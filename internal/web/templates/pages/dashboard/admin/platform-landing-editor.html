{{define "pages/dashboard/admin/platform-landing-editor"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item">Platform Admin</li>
        <li class="breadcrumb-item active">Landing Page Editor</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="landing-editor" id="landingEditor" data-config="{{.Data.ConfigJSON}}">
    <!-- Header Toolbar -->
    <div class="editor-toolbar d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <a href="/dashboard" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Back
            </a>
            <h5 class="mb-0 ms-2"><i class="bi bi-house-door me-2"></i>Platform Landing Page Editor</h5>
            {{if .Data.HasDraft}}
            <span class="badge bg-warning text-dark ms-2">Unsaved Draft</span>
            {{end}}
        </div>
        <div class="d-flex gap-2">
            <a href="/" class="btn btn-outline-info btn-sm" target="_blank">
                <i class="bi bi-eye me-1"></i>View Live
            </a>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="saveDraft()">
                <i class="bi bi-save me-1"></i>Save Draft
            </button>
            {{if .Data.HasDraft}}
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="discardDraft()">
                <i class="bi bi-x-circle me-1"></i>Discard
            </button>
            {{end}}
            <button type="button" class="btn btn-primary btn-sm" onclick="publishPage()">
                <i class="bi bi-send me-1"></i>Publish
            </button>
        </div>
    </div>

    <div class="row g-3">
        <!-- Settings Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header p-0">
                    <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#headerTab"><i class="bi bi-layout-wtf me-1"></i>Header</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#heroTab"><i class="bi bi-image me-1"></i>Hero</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#widgetsTab"><i class="bi bi-puzzle me-1"></i>Widgets</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#contentTab"><i class="bi bi-grid me-1"></i>Content</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#seoTab"><i class="bi bi-search me-1"></i>SEO</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#colorsTab"><i class="bi bi-palette me-1"></i>Colors</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <div class="tab-content">
                        <!-- Header Tab -->
                        <div class="tab-pane fade show active" id="headerTab">
                            <div class="mb-3">
                                <label class="form-label">Platform Logo</label>
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div id="logoPreview" class="border rounded d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background: #f8f9fa;">
                                        {{if .Data.LandingPage.LogoURL}}
                                        <img src="{{.Data.LandingPage.LogoURL}}" alt="Logo" style="max-width: 100%; max-height: 100%;">
                                        {{else}}
                                        <i class="bi bi-image text-muted fs-4"></i>
                                        {{end}}
                                    </div>
                                    <div>
                                        <input type="file" id="logoUpload" accept="image/*" class="d-none" onchange="uploadLogo(this)">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="document.getElementById('logoUpload').click()">
                                            <i class="bi bi-upload me-1"></i>Upload
                                        </button>
                                        {{if .Data.LandingPage.LogoURL}}
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLogo()">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {{end}}
                                    </div>
                                </div>
                                <small class="text-muted">Recommended: PNG or SVG, 200x200px</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Platform Name</label>
                                <input type="text" class="form-control form-control-sm" id="platformName" onchange="updateConfig()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tagline</label>
                                <input type="text" class="form-control form-control-sm" id="tagline" onchange="updateConfig()">
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showLogo" onchange="updateConfig()">
                                <label class="form-check-label" for="showLogo">Show Logo</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showPlatformName" onchange="updateConfig()">
                                <label class="form-check-label" for="showPlatformName">Show Platform Name</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showTagline" onchange="updateConfig()">
                                <label class="form-check-label" for="showTagline">Show Tagline</label>
                            </div>
                        </div>

                        <!-- Hero Tab -->
                        <div class="tab-pane fade" id="heroTab">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="heroEnabled" onchange="updateConfig()">
                                <label class="form-check-label" for="heroEnabled">Enable Hero Section</label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hero Title</label>
                                <input type="text" class="form-control form-control-sm" id="heroTitle" onchange="updateConfig()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hero Description</label>
                                <textarea class="form-control form-control-sm" id="heroDescription" rows="3" onchange="updateConfig()"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hero Height</label>
                                <select class="form-select form-select-sm" id="heroHeight" onchange="updateConfig()">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hero Background</label>
                                <input type="file" id="heroBgUpload" accept="image/*" class="form-control form-control-sm" onchange="uploadHeroBackground(this)">
                                <small class="text-muted">Leave empty for gradient background</small>
                            </div>
                        </div>

                        <!-- Widgets Tab -->
                        <div class="tab-pane fade" id="widgetsTab">
                            <h6 class="text-muted small mb-2">Available Widgets</h6>
                            <div class="widget-list mb-3">
                                {{range .Data.WidgetList}}
                                <div class="widget-item" onclick="addWidget('{{.Type}}')" style="cursor: pointer;">
                                    <i class="bi bi-{{.Icon}} me-2"></i>{{.Name}}
                                </div>
                                {{end}}
                            </div>

                            <hr class="my-2">

                            <h6 class="text-muted small mb-2">
                                <i class="bi bi-layers me-1"></i>Added Widgets
                                <small class="text-muted">(click to edit)</small>
                            </h6>
                            <div class="widget-list" id="addedWidgetsList">
                                <!-- Populated by JavaScript -->
                            </div>

                            <!-- Widget Properties -->
                            <div class="widget-properties-panel d-none mt-3 border rounded p-2" id="widgetProperties">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="small fw-bold" id="selectedWidgetName">Widget Properties</span>
                                    <button type="button" class="btn-close btn-close-sm" onclick="deselectWidget()"></button>
                                </div>
                                <div id="widgetConfigForm"></div>
                                <hr class="my-2">
                                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="deleteSelectedWidget()">
                                    <i class="bi bi-trash me-1"></i>Remove Widget
                                </button>
                            </div>
                        </div>

                        <!-- Content Tab -->
                        <div class="tab-pane fade" id="contentTab">
                            <h6 class="text-muted small mb-2">Stations Grid</h6>
                            <div class="mb-3">
                                <label class="form-label">Grid Columns</label>
                                <select class="form-select form-select-sm" id="gridColumns" onchange="updateConfig()">
                                    <option value="2">2 Columns</option>
                                    <option value="3">3 Columns</option>
                                    <option value="4">4 Columns</option>
                                </select>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showDescription" onchange="updateConfig()">
                                <label class="form-check-label" for="showDescription">Show Station Descriptions</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showListeners" onchange="updateConfig()">
                                <label class="form-check-label" for="showListeners">Show Listener Count</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="showStationLogo" onchange="updateConfig()">
                                <label class="form-check-label" for="showStationLogo">Show Station Logos</label>
                            </div>

                            <hr>
                            <h6 class="text-muted small mb-2">Station Order</h6>
                            <p class="small text-muted">Drag to reorder stations</p>
                            <div id="stationOrderList" class="list-group list-group-flush">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- SEO Tab -->
                        <div class="tab-pane fade" id="seoTab">
                            <div class="mb-3">
                                <label class="form-label">Page Title</label>
                                <input type="text" class="form-control form-control-sm" id="seoTitle" onchange="updateConfig()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Meta Description</label>
                                <textarea class="form-control form-control-sm" id="seoDescription" rows="3" onchange="updateConfig()"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Footer Copyright</label>
                                <input type="text" class="form-control form-control-sm" id="copyrightText" placeholder="Leave empty for default" onchange="updateConfig()">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="seoNoIndex" onchange="updateConfig()">
                                <label class="form-check-label" for="seoNoIndex">No Index (hide from search engines)</label>
                            </div>
                        </div>

                        <!-- Colors Tab -->
                        <div class="tab-pane fade" id="colorsTab">
                            <p class="small text-muted mb-3">Override theme colors. Leave empty to use theme defaults.</p>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">Primary Color</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorPrimary" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorPrimaryText" placeholder="#00ff00" onchange="syncColorInput('Primary')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('Primary')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Secondary Color</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorSecondary" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorSecondaryText" placeholder="#10b981" onchange="syncColorInput('Secondary')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('Secondary')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Background</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorBackground" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorBackgroundText" placeholder="#0a0a0a" onchange="syncColorInput('Background')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('Background')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Surface (Cards)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorSurface" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorSurfaceText" placeholder="#121212" onchange="syncColorInput('Surface')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('Surface')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Text Color</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorText" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorTextText" placeholder="#ffffff" onchange="syncColorInput('Text')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('Text')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Muted Text</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorTextMuted" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorTextMutedText" placeholder="#888888" onchange="syncColorInput('TextMuted')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('TextMuted')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Card Background</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorCardBackground" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorCardBackgroundText" placeholder="#1a1a1a" onchange="syncColorInput('CardBackground')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('CardBackground')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Card Text</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorCardText" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorCardTextText" placeholder="#ffffff" onchange="syncColorInput('CardText')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('CardText')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Border Color</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="colorBorder" onchange="updateConfig()">
                                        <input type="text" class="form-control form-control-sm" id="colorBorderText" placeholder="#333333" onchange="syncColorInput('Border')">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearColor('Border')" title="Clear"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Selection -->
            <div class="card mt-3">
                <div class="card-header py-2">
                    <i class="bi bi-palette me-1"></i>Theme
                </div>
                <div class="card-body py-2">
                    <div class="row g-2">
                        {{range .Data.Themes}}
                        <div class="col-4">
                            <div class="theme-option p-2 border rounded text-center" data-theme="{{.ID}}" onclick="selectTheme('{{.ID}}')" style="cursor: pointer;">
                                <div class="d-flex justify-content-center gap-1 mb-1">
                                    <span class="rounded-circle" style="width: 12px; height: 12px; background: {{.Colors.Primary}};"></span>
                                    <span class="rounded-circle" style="width: 12px; height: 12px; background: {{.Colors.Secondary}};"></span>
                                </div>
                                <small class="d-block" style="font-size: 0.7rem;">{{.Name}}</small>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-eye me-1"></i>Preview</span>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary active" onclick="setPreviewMode('desktop')">
                            <i class="bi bi-display"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setPreviewMode('tablet')">
                            <i class="bi bi-tablet"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setPreviewMode('mobile')">
                            <i class="bi bi-phone"></i>
                        </button>
                        <a href="/dashboard/admin/landing-page/preview" target="_blank" class="btn btn-outline-secondary">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-0 bg-secondary-subtle">
                    <div class="preview-container d-flex justify-content-center p-3" style="height: 600px;">
                        <iframe id="previewFrame" src="/dashboard/admin/landing-page/preview" class="preview-frame"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="editorToast" class="toast" role="alert">
        <div class="toast-body d-flex align-items-center gap-2">
            <i class="bi" id="toastIcon"></i>
            <span id="toastMessage"></span>
        </div>
    </div>
</div>

<style>
.nav-tabs-sm .nav-link {
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
}
.theme-option.active {
    border-color: var(--bs-primary) !important;
    background: var(--bs-primary-bg-subtle);
}
/* Fix for Firefox click blocking issue */
.landing-editor {
    position: relative;
}
.landing-editor .row {
    position: relative;
}
/* Ensure settings panel is always on top and receives pointer events */
.landing-editor .col-md-4 {
    position: relative;
    z-index: 100;
    /* Ensure this column receives pointer events */
    pointer-events: auto;
}
/* Keep preview panel below settings panel in stacking order */
.landing-editor .col-md-8 {
    position: relative;
    z-index: 1;
}
.preview-container {
    overflow: auto;
    position: relative;
}
.preview-frame {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
    border-radius: 0.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: width 0.3s;
    /* Prevent iframe from stealing focus/events from parent */
    pointer-events: auto;
}
/* Prevent iframe from capturing pointer events when loading */
.preview-frame.loading {
    pointer-events: none;
    opacity: 0.7;
}
.preview-frame.tablet {
    width: 768px;
}
.preview-frame.mobile {
    width: 375px;
}
.station-order-item {
    cursor: move;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.5rem;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    font-size: 0.8125rem;
}
.station-order-item:hover {
    background: var(--bs-tertiary-bg);
}
.station-order-item.dragging {
    opacity: 0.5;
}
.widget-item {
    padding: 0.5rem 0.75rem;
    background: var(--bs-tertiary-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.15s;
}
.widget-item:hover {
    background: var(--bs-secondary-bg);
    border-color: var(--bs-primary);
}
.widget-item.active {
    background: var(--bs-primary-bg-subtle);
    border-color: var(--bs-primary);
}
.widget-list {
    max-height: 200px;
    overflow-y: auto;
}
</style>
{{end}}

{{define "scripts"}}
<script>
let config = JSON.parse(document.getElementById('landingEditor').dataset.config || '{}');
let isDirty = false;
let updateTimeout = null;

// Station data from server
const stationsData = ({{jsonMarshal .Data.Stations}} || []).map(station => ({
    id: station.ID,
    name: station.Name,
    sortOrder: Number(station.SortOrder || 0),
}));

// Widget definitions
const widgetDefs = {
    {{range .Data.WidgetList}}
    "{{.Type}}": {
        name: "{{.Name}}",
        configSpec: [
            {{range .ConfigSpec}}
            { key: "{{.Key}}", label: "{{.Label}}", type: "{{.Type}}", default: {{if .Default}}{{jsonMarshal .Default}}{{else}}null{{end}} },
            {{end}}
        ]
    },
    {{end}}
};

let selectedWidget = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadConfigToForm();
    highlightCurrentTheme();
    initStationOrder();
    updateAddedWidgetsList();
});

function loadConfigToForm() {
    // Header
    document.getElementById('platformName').value = config.header?.platformName || 'Grimnir Radio';
    document.getElementById('tagline').value = config.header?.tagline || '';
    document.getElementById('showLogo').checked = config.header?.showLogo !== false;
    document.getElementById('showPlatformName').checked = config.header?.showPlatformName !== false;
    document.getElementById('showTagline').checked = config.header?.showTagline !== false;

    // Hero
    document.getElementById('heroEnabled').checked = config.hero?.enabled !== false;
    document.getElementById('heroTitle').value = config.hero?.title || '';
    document.getElementById('heroDescription').value = config.hero?.description || '';
    document.getElementById('heroHeight').value = config.hero?.height || 'large';

    // Content
    document.getElementById('gridColumns').value = config.content?.columns || '3';
    document.getElementById('showDescription').checked = config.content?.showDescription !== false;
    document.getElementById('showListeners').checked = config.content?.showListeners === true;
    document.getElementById('showStationLogo').checked = config.content?.showStationLogo !== false;

    // SEO
    document.getElementById('seoTitle').value = config.seo?.title || '';
    document.getElementById('seoDescription').value = config.seo?.description || '';
    document.getElementById('copyrightText').value = config.footer?.copyrightText || '';
    document.getElementById('seoNoIndex').checked = config.seo?.noIndex === true;

    // Colors
    loadColorField('Primary', config.colors?.primary);
    loadColorField('Secondary', config.colors?.secondary);
    loadColorField('Background', config.colors?.background);
    loadColorField('Surface', config.colors?.surface);
    loadColorField('Text', config.colors?.text);
    loadColorField('TextMuted', config.colors?.textMuted);
    loadColorField('CardBackground', config.colors?.cardBackground);
    loadColorField('CardText', config.colors?.cardText);
    loadColorField('Border', config.colors?.border);
}

function loadColorField(name, value) {
    const picker = document.getElementById('color' + name);
    const text = document.getElementById('color' + name + 'Text');
    if (value) {
        picker.value = value;
        text.value = value;
    } else {
        picker.value = '#000000';
        text.value = '';
    }
}

function syncColorInput(name) {
    const text = document.getElementById('color' + name + 'Text');
    const picker = document.getElementById('color' + name);
    if (text.value && text.value.match(/^#[0-9a-fA-F]{6}$/)) {
        picker.value = text.value;
    }
    updateConfig();
}

function clearColor(name) {
    document.getElementById('color' + name).value = '#000000';
    document.getElementById('color' + name + 'Text').value = '';
    updateConfig();
}

function updateConfig() {
    config.header = config.header || {};
    config.header.platformName = document.getElementById('platformName').value;
    config.header.tagline = document.getElementById('tagline').value;
    config.header.showLogo = document.getElementById('showLogo').checked;
    config.header.showPlatformName = document.getElementById('showPlatformName').checked;
    config.header.showTagline = document.getElementById('showTagline').checked;

    config.hero = config.hero || {};
    config.hero.enabled = document.getElementById('heroEnabled').checked;
    config.hero.title = document.getElementById('heroTitle').value;
    config.hero.description = document.getElementById('heroDescription').value;
    config.hero.height = document.getElementById('heroHeight').value;

    config.content = config.content || {};
    config.content.columns = parseInt(document.getElementById('gridColumns').value) || 3;
    config.content.showDescription = document.getElementById('showDescription').checked;
    config.content.showListeners = document.getElementById('showListeners').checked;
    config.content.showStationLogo = document.getElementById('showStationLogo').checked;

    config.seo = config.seo || {};
    config.seo.title = document.getElementById('seoTitle').value;
    config.seo.description = document.getElementById('seoDescription').value;
    config.seo.noIndex = document.getElementById('seoNoIndex').checked;

    config.footer = config.footer || {};
    config.footer.copyrightText = document.getElementById('copyrightText').value;

    // Colors - only save non-empty values
    config.colors = {};
    const colorFields = ['Primary', 'Secondary', 'Background', 'Surface', 'Text', 'TextMuted', 'CardBackground', 'CardText', 'Border'];
    colorFields.forEach(name => {
        const textInput = document.getElementById('color' + name + 'Text');
        const pickerInput = document.getElementById('color' + name);
        // Use text input if it has a value, otherwise check if picker was changed
        let value = textInput.value.trim();
        if (!value && pickerInput.value !== '#000000') {
            value = pickerInput.value;
            textInput.value = value; // Sync text input
        }
        if (value) {
            // Convert camelCase to config keys
            const key = name.charAt(0).toLowerCase() + name.slice(1);
            config.colors[key] = value;
        }
    });
    // Remove empty colors object
    if (Object.keys(config.colors).length === 0) {
        delete config.colors;
    }

    isDirty = true;

    // Debounce preview refresh
    if (updateTimeout) clearTimeout(updateTimeout);
    updateTimeout = setTimeout(() => refreshPreview(), 500);
}

function selectTheme(themeId) {
    config.theme = themeId;
    highlightCurrentTheme();
    isDirty = true;
    // Don't await - let it refresh in background to avoid blocking UI
    refreshPreview().catch(err => console.error('Preview refresh failed:', err));
}

function highlightCurrentTheme() {
    document.querySelectorAll('.theme-option').forEach(el => {
        el.classList.toggle('active', el.dataset.theme === config.theme);
    });
}

// Widget management
function addWidget(type) {
    const id = 'w' + Date.now();
    const widget = {
        id: id,
        type: type,
        config: {}
    };

    // Apply defaults
    const def = widgetDefs[type];
    if (def && def.configSpec) {
        def.configSpec.forEach(field => {
            if (field.default !== null && field.default !== undefined) {
                widget.config[field.key] = field.default;
            }
        });
    }

    if (!config.content) config.content = {};
    if (!config.content.widgets) config.content.widgets = [];
    config.content.widgets.push(widget);

    isDirty = true;
    updateAddedWidgetsList();
    selectWidgetForEdit(id);
    refreshPreview();
}

function selectWidgetForEdit(widgetId) {
    selectedWidget = widgetId;
    const widgets = config.content?.widgets || [];
    const widget = widgets.find(w => w.id === widgetId);
    if (!widget) return;

    const def = widgetDefs[widget.type];
    document.getElementById('selectedWidgetName').textContent = def?.name || widget.type;
    document.getElementById('widgetProperties').classList.remove('d-none');
    updateAddedWidgetsList();
    renderWidgetConfigForm(widget, def);
}

function renderWidgetConfigForm(widget, def) {
    const container = document.getElementById('widgetConfigForm');
    let html = '';

    // Widget-specific config fields
    if (def && def.configSpec && def.configSpec.length > 0) {
        def.configSpec.forEach(field => {
            const value = widget.config[field.key] ?? field.default ?? '';

            html += `<div class="mb-2">`;
            html += `<label class="form-label small">${field.label}</label>`;

            switch (field.type) {
                case 'boolean':
                    html += `<div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="widget_${field.key}"
                            ${value ? 'checked' : ''}
                            onchange="updateWidgetConfig('${widget.id}', '${field.key}', this.checked)">
                    </div>`;
                    break;
                case 'number':
                    html += `<input type="number" class="form-control form-control-sm" id="widget_${field.key}"
                        value="${value}"
                        onchange="updateWidgetConfig('${widget.id}', '${field.key}', parseInt(this.value))">`;
                    break;
                case 'textarea':
                    html += `<textarea class="form-control form-control-sm" id="widget_${field.key}" rows="4"
                        onchange="updateWidgetConfig('${widget.id}', '${field.key}', this.value)">${escapeHtml(value)}</textarea>`;
                    break;
                case 'code':
                    html += `<textarea class="form-control form-control-sm font-monospace" id="widget_${field.key}" rows="8"
                        placeholder="Enter HTML, including iframes..."
                        onchange="updateWidgetConfig('${widget.id}', '${field.key}', this.value)">${escapeHtml(value)}</textarea>`;
                    html += `<small class="text-muted">Supports HTML including iframes, scripts, and embeds</small>`;
                    break;
                case 'color':
                    html += `<input type="color" class="form-control form-control-color w-100" id="widget_${field.key}"
                        value="${value || '#000000'}"
                        onchange="updateWidgetConfig('${widget.id}', '${field.key}', this.value)">`;
                    break;
                default: // text
                    html += `<input type="text" class="form-control form-control-sm" id="widget_${field.key}"
                        value="${escapeHtml(value)}"
                        onchange="updateWidgetConfig('${widget.id}', '${field.key}', this.value)">`;
            }

            html += `</div>`;
        });
    }

    // Layout options (common to all widgets)
    html += `<hr class="my-2">`;
    html += `<p class="small fw-bold mb-2">Layout</p>`;

    // Same row as previous (newRow = false means same row)
    const widgets = config.content?.widgets || [];
    const widgetIndex = widgets.findIndex(w => w.id === widget.id);
    const newRow = widget.config.newRow !== false; // default true
    if (widgetIndex > 0) {
        html += `<div class="mb-2 form-check">
            <input type="checkbox" class="form-check-input" id="widget_sameRow"
                ${!newRow ? 'checked' : ''}
                onchange="updateWidgetConfig('${widget.id}', 'newRow', !this.checked)">
            <label class="form-check-label small" for="widget_sameRow">Same row as previous widget</label>
        </div>`;
    }

    // Column width
    const colWidth = widget.config.colWidth || '12';
    html += `<div class="mb-2">
        <label class="form-label small">Width (columns 1-12)</label>
        <select class="form-select form-select-sm" onchange="updateWidgetConfig('${widget.id}', 'colWidth', this.value)">
            <option value="12" ${colWidth === '12' ? 'selected' : ''}>Full width (12)</option>
            <option value="10" ${colWidth === '10' ? 'selected' : ''}>10 columns</option>
            <option value="8" ${colWidth === '8' ? 'selected' : ''}>8 columns</option>
            <option value="6" ${colWidth === '6' ? 'selected' : ''}>Half width (6)</option>
            <option value="4" ${colWidth === '4' ? 'selected' : ''}>4 columns</option>
            <option value="3" ${colWidth === '3' ? 'selected' : ''}>3 columns</option>
        </select>
        <small class="text-muted">Total columns in a row must equal 12</small>
    </div>`;

    // Height (optional)
    const height = widget.config.height || '';
    html += `<div class="mb-2">
        <label class="form-label small">Height (optional)</label>
        <input type="text" class="form-control form-control-sm" placeholder="e.g., 400px, 50vh, auto"
            value="${escapeHtml(height)}"
            onchange="updateWidgetConfig('${widget.id}', 'height', this.value)">
        <small class="text-muted">Leave empty for auto height</small>
    </div>`;

    container.innerHTML = html;
}

function updateWidgetConfig(widgetId, key, value) {
    const widgets = config.content?.widgets || [];
    const widget = widgets.find(w => w.id === widgetId);
    if (!widget) return;

    if (!widget.config) widget.config = {};
    widget.config[key] = value;

    isDirty = true;
    refreshPreview();
}

function updateAddedWidgetsList() {
    const container = document.getElementById('addedWidgetsList');
    if (!container) return;

    const widgets = config.content?.widgets || [];

    if (widgets.length === 0) {
        container.innerHTML = '<p class="text-muted small fst-italic">Click a widget above to add</p>';
        return;
    }

    let html = '';
    widgets.forEach((widget, index) => {
        const def = widgetDefs[widget.type];
        const name = def?.name || widget.type;
        const isSelected = selectedWidget === widget.id;
        const isFirst = index === 0;
        const isLast = index === widgets.length - 1;

        html += `<div class="widget-item d-flex align-items-center ${isSelected ? 'active' : ''}" style="cursor: pointer;">
            <div class="d-flex flex-column me-2">
                <button type="button" class="btn btn-link btn-sm p-0 text-muted ${isFirst ? 'invisible' : ''}" onclick="event.stopPropagation(); moveWidget('${widget.id}', -1)" title="Move up">
                    <i class="bi bi-chevron-up"></i>
                </button>
                <button type="button" class="btn btn-link btn-sm p-0 text-muted ${isLast ? 'invisible' : ''}" onclick="event.stopPropagation(); moveWidget('${widget.id}', 1)" title="Move down">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div class="flex-grow-1" onclick="selectWidgetForEdit('${widget.id}')">
                <span class="badge bg-secondary me-2">${index + 1}</span>
                ${name}
            </div>
        </div>`;
    });

    container.innerHTML = html;
}

function moveWidget(widgetId, direction) {
    const widgets = config.content?.widgets || [];
    const index = widgets.findIndex(w => w.id === widgetId);
    if (index === -1) return;

    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= widgets.length) return;

    // Swap widgets
    [widgets[index], widgets[newIndex]] = [widgets[newIndex], widgets[index]];

    isDirty = true;
    updateAddedWidgetsList();
    refreshPreview();
}

function deselectWidget() {
    selectedWidget = null;
    document.getElementById('widgetProperties').classList.add('d-none');
    updateAddedWidgetsList();
}

function deleteSelectedWidget() {
    if (!selectedWidget) return;
    if (!confirm('Remove this widget?')) return;

    const widgets = config.content?.widgets || [];
    const index = widgets.findIndex(w => w.id === selectedWidget);
    if (index !== -1) {
        widgets.splice(index, 1);
        isDirty = true;
        refreshPreview();
        deselectWidget();
        updateAddedWidgetsList();
    }
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

async function refreshPreview() {
    const iframe = document.getElementById('previewFrame');

    // Add loading class to prevent pointer event issues
    iframe.classList.add('loading');

    try {
        if (isDirty) {
            await saveDraft(true);
        }
        const url = new URL(iframe.src, window.location.origin);
        url.searchParams.set('_t', Date.now());
        iframe.src = url.toString();
    } finally {
        // Remove loading class after iframe starts loading
        // Use load event to ensure it's fully loaded
        iframe.onload = () => {
            iframe.classList.remove('loading');
        };
        // Fallback: remove loading class after timeout in case load event doesn't fire
        setTimeout(() => {
            iframe.classList.remove('loading');
        }, 3000);
    }
}

function setPreviewMode(mode) {
    const frame = document.getElementById('previewFrame');
    const buttons = document.querySelectorAll('.btn-group .btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.closest('.btn').classList.add('active');

    frame.classList.remove('desktop', 'tablet', 'mobile');
    if (mode !== 'desktop') {
        frame.classList.add(mode);
    }
}

// Station ordering
function initStationOrder() {
    const container = document.getElementById('stationOrderList');
    if (!container) return;

    // Get custom order from config or use default
    const customOrder = config.content?.stationOrder || [];

    // Sort stations: custom ordered first, then by sort_order
    const orderedStations = [...stationsData].sort((a, b) => {
        const aIndex = customOrder.indexOf(a.id);
        const bIndex = customOrder.indexOf(b.id);
        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
        if (aIndex !== -1) return -1;
        if (bIndex !== -1) return 1;
        return a.sortOrder - b.sortOrder;
    });

    container.innerHTML = orderedStations.map((station, i) => `
        <div class="station-order-item" draggable="true" data-station-id="${station.id}">
            <div class="d-flex align-items-center gap-2 flex-grow-1">
                <i class="bi bi-grip-vertical text-muted"></i>
                <span class="badge text-bg-secondary station-order-index">${i + 1}</span>
                <span>${station.name}</span>
            </div>
            <div class="btn-group btn-group-sm" role="group" aria-label="Reorder station">
                <button type="button" class="btn btn-outline-secondary py-0 px-1"
                        onclick="moveStation('${station.id}', -1); event.stopPropagation();" title="Move up">
                    <i class="bi bi-chevron-up"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary py-0 px-1"
                        onclick="moveStation('${station.id}', 1); event.stopPropagation();" title="Move down">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
        </div>
    `).join('');

    // Setup drag and drop
    const items = container.querySelectorAll('.station-order-item');
    items.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
    });

    updateStationOrderIndices();
}

let draggedItem = null;

function handleDragStart(e) {
    draggedItem = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedItem = null;
    saveStationOrder();
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    const container = document.getElementById('stationOrderList');
    const afterElement = getDragAfterElement(container, e.clientY);

    if (afterElement == null) {
        container.appendChild(draggedItem);
    } else {
        container.insertBefore(draggedItem, afterElement);
    }
}

function handleDrop(e) {
    e.preventDefault();
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.station-order-item:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function saveStationOrder() {
    updateStationOrderIndices();

    const items = document.querySelectorAll('#stationOrderList .station-order-item');
    const order = Array.from(items).map(item => item.dataset.stationId);

    config.content = config.content || {};
    config.content.stationOrder = order;
    isDirty = true;

    // Debounce refresh
    if (updateTimeout) clearTimeout(updateTimeout);
    updateTimeout = setTimeout(() => refreshPreview(), 500);
}

function moveStation(stationId, direction) {
    const container = document.getElementById('stationOrderList');
    if (!container) return;

    const items = Array.from(container.querySelectorAll('.station-order-item'));
    const index = items.findIndex(item => item.dataset.stationId === stationId);
    if (index === -1) return;

    const nextIndex = index + direction;
    if (nextIndex < 0 || nextIndex >= items.length) return;

    const current = items[index];
    const target = items[nextIndex];

    if (direction < 0) {
        container.insertBefore(current, target);
    } else {
        container.insertBefore(target, current);
    }

    updateStationOrderIndices();
    saveStationOrder();
}

function updateStationOrderIndices() {
    const items = document.querySelectorAll('#stationOrderList .station-order-item');
    items.forEach((item, idx) => {
        const badge = item.querySelector('.station-order-index');
        if (badge) badge.textContent = String(idx + 1);
    });
}

// Logo upload
async function uploadLogo(input) {
    if (!input.files || !input.files[0]) return;

    const formData = new FormData();
    formData.append('file', input.files[0]);
    formData.append('type', 'logo');

    try {
        const response = await fetch('/dashboard/admin/landing-page/assets', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const asset = await response.json();
            config.header = config.header || {};
            config.header.logoUrl = asset.url;

            // Update preview
            const preview = document.getElementById('logoPreview');
            preview.innerHTML = `<img src="${asset.url}" alt="Logo" style="max-width: 100%; max-height: 100%;">`;

            isDirty = true;
            showToast('Logo uploaded', 'success');
            refreshPreview();
        } else {
            showToast('Failed to upload logo', 'danger');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showToast('Failed to upload logo', 'danger');
    }
}

function removeLogo() {
    if (!confirm('Remove the platform logo?')) return;

    config.header = config.header || {};
    delete config.header.logoUrl;

    const preview = document.getElementById('logoPreview');
    preview.innerHTML = '<i class="bi bi-image text-muted fs-4"></i>';

    isDirty = true;
    refreshPreview();
}

async function uploadHeroBackground(input) {
    if (!input.files || !input.files[0]) return;

    const formData = new FormData();
    formData.append('file', input.files[0]);
    formData.append('type', 'hero');

    try {
        const response = await fetch('/dashboard/admin/landing-page/assets', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const asset = await response.json();
            config.hero = config.hero || {};
            config.hero.backgroundUrl = asset.url;

            isDirty = true;
            showToast('Background uploaded', 'success');
            refreshPreview();
        } else {
            showToast('Failed to upload background', 'danger');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showToast('Failed to upload background', 'danger');
    }
}

// Save/Publish/Discard
window.saveDraft = async function(silent = false) {
    try {
        const response = await fetch('/dashboard/admin/landing-page/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            isDirty = false;
            if (!silent) showToast('Draft saved', 'success');
        } else {
            showToast('Failed to save draft', 'danger');
        }
    } catch (error) {
        console.error('Save error:', error);
        showToast('Failed to save draft', 'danger');
    }
};

window.publishPage = async function() {
    if (!confirm('Publish the platform landing page? It will be visible to all visitors.')) return;

    try {
        await saveDraft(true);

        const response = await fetch('/dashboard/admin/landing-page/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });

        if (response.ok) {
            showToast('Platform landing page published!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to publish', 'danger');
        }
    } catch (error) {
        console.error('Publish error:', error);
        showToast('Failed to publish', 'danger');
    }
};

window.discardDraft = async function() {
    if (!confirm('Discard all changes and revert to published version?')) return;

    try {
        const response = await fetch('/dashboard/admin/landing-page/discard', {
            method: 'POST'
        });

        if (response.ok) {
            showToast('Draft discarded', 'info');
            location.reload();
        } else {
            showToast('Failed to discard draft', 'danger');
        }
    } catch (error) {
        console.error('Discard error:', error);
        showToast('Failed to discard draft', 'danger');
    }
};

function showToast(message, type = 'info') {
    const toast = document.getElementById('editorToast');
    const icon = document.getElementById('toastIcon');
    const msg = document.getElementById('toastMessage');

    msg.textContent = message;
    toast.className = 'toast bg-' + type + ' text-white';
    icon.className = 'bi bi-' + (type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle');

    new bootstrap.Toast(toast).show();
}

// Warn on unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (isDirty) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Debug: Log click targets to help identify blocking elements
// Enable with: localStorage.setItem('debugClicks', 'true')
if (localStorage.getItem('debugClicks') === 'true') {
    document.addEventListener('click', (e) => {
        console.log('[ClickDebug] Clicked element:', e.target);
        console.log('[ClickDebug] Element path:', e.composedPath().map(el => {
            if (el.tagName) {
                return el.tagName + (el.id ? '#' + el.id : '') + (el.className ? '.' + el.className.split(' ').join('.') : '');
            }
            return String(el);
        }).slice(0, 5).join(' > '));
    }, true);

    document.addEventListener('mousedown', (e) => {
        // Check what element is actually at this position
        const elemAtPoint = document.elementFromPoint(e.clientX, e.clientY);
        if (elemAtPoint !== e.target) {
            console.log('[ClickDebug] WARNING: Element at point differs!');
            console.log('[ClickDebug] e.target:', e.target);
            console.log('[ClickDebug] elementFromPoint:', elemAtPoint);
        }
    }, true);

    console.log('[ClickDebug] Click debugging enabled. Click anywhere to see element info.');
}
</script>
{{end}}
