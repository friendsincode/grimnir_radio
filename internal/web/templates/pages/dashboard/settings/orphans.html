{{define "pages/dashboard/settings/orphans"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/settings">Settings</a></li>
        <li class="breadcrumb-item active">Orphans</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Orphan Media Manager</h1>
            <p class="text-muted mb-0">
                Manage media files found on disk but not in the database
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="/dashboard/settings/migrations" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Migrations
            </a>
            <button type="button" class="btn btn-primary"
                    id="scan-btn"
                    hx-post="/dashboard/settings/orphans/scan"
                    hx-target="#scan-result"
                    hx-disabled-elt="this">
                <i class="bi bi-search me-1"></i> Scan Now
            </button>
        </div>
    </div>

    <!-- Scan Result Alert -->
    <div id="scan-result" class="mb-4"></div>

    <!-- Orphans Content (auto-refreshes on orphans-updated event) -->
    <div id="orphans-content"
         hx-get="/dashboard/settings/orphans?per_page={{ .Data.PageSize }}{{ if gt .Data.PageSize 0 }}&page={{ .Data.Page }}{{ end }}"
         hx-trigger="orphans-updated from:body"
         hx-select="#orphans-content"
         hx-swap="outerHTML">

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div class="h3 mb-0">{{ .Data.Count }}</div>
                    <small class="text-muted">Orphaned Files</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div class="h3 mb-0">{{ .Data.SizeHuman }}</div>
                    <small class="text-muted">Total Size</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div class="h3 mb-0">{{ len .Data.StationList }}</div>
                    <small class="text-muted">Available Stations</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Alert -->
    {{ if eq .Data.Count 0 }}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>No orphaned files detected.</strong>
        <p class="mb-0 mt-2">
            Click "Scan Now" to search for media files on disk that are not in the database.
            This typically happens after a database reset when files remain on disk.
        </p>
    </div>
    {{ else }}

    <!-- Bulk Actions -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="bulk-action-form">
                <div class="row align-items-end g-3">
                    <div class="col-md-4">
                        <label class="form-label">With Selected:</label>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllOrphans(true)">
                                Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllOrphans(false)">
                                Deselect All
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="bulk-station" class="form-label">Adopt to Station:</label>
                        <select id="bulk-station" name="station_id" class="form-select form-select-sm">
                            <option value="">Select station...</option>
                            {{ range .Data.StationList }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-success w-100"
                                onclick="bulkAdopt()"
                                id="bulk-adopt-btn">
                            <i class="bi bi-box-arrow-in-down me-1"></i> Adopt Selected
                        </button>
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group w-100">
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="bulkDelete(false)"
                                    title="Remove from orphan list only">
                                <i class="bi bi-trash me-1"></i> Remove Records
                            </button>
                            <button type="button" class="btn btn-sm btn-danger"
                                    onclick="bulkDelete(true)"
                                    title="Delete files from disk">
                                <i class="bi bi-trash-fill me-1"></i> Delete Files
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Select All Banner -->
    <div id="select-all-banner" class="alert alert-info d-none mb-4">
        <i class="bi bi-check2-all me-2"></i>
        All <span id="banner-page-count"></span> orphans on this page are selected.
        <a href="#" class="alert-link" onclick="selectAllAcrossPages(); return false;">
            Select all <strong><span id="banner-total-count">{{ .Data.Total }}</span></strong> orphans
        </a>
    </div>
    <div id="select-all-confirmed" class="alert alert-success d-none mb-4">
        <i class="bi bi-check2-all me-2"></i>
        All <strong><span id="confirmed-total-count">{{ .Data.Total }}</span></strong> orphans are selected.
        <a href="#" class="alert-link" onclick="clearSelectAll(); return false;">Clear selection</a>
    </div>

    <!-- Bulk Result -->
    <div id="bulk-result" class="mb-4"></div>

    <!-- Orphans Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-sm table-hover">
                    <thead class="sticky-top bg-body">
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>File Path</th>
                            <th>Title (from filename)</th>
                            <th>Size</th>
                            <th>Hash (first 12)</th>
                            <th>Detected</th>
                            <th style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Data.Orphans }}
                        {{$orphanID := .ID}}
                        <tr id="orphan-row-{{ .ID }}">
                            <td>
                                <input type="checkbox" class="form-check-input orphan-checkbox"
                                       name="orphan_ids" value="{{ .ID }}"
                                       onchange="onCheckboxChange()">
                            </td>
                            <td>
                                <code class="small text-break" style="word-break: break-all;">{{ .FilePath }}</code>
                            </td>
                            <td>{{ .Title }}</td>
                            <td>{{ formatBytes .FileSize }}</td>
                            <td>
                                {{ if .ContentHash }}
                                <code class="small">{{ slice .ContentHash 0 12 }}...</code>
                                {{ else }}
                                <span class="text-muted">-</span>
                                {{ end }}
                            </td>
                            <td>
                                <small class="text-muted">{{ .DetectedAt.Format "Jan 2, 15:04" }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-success dropdown-toggle"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-box-arrow-in-down"></i> Adopt
                                    </button>
                                    <ul class="dropdown-menu">
                                        {{ range $.Data.StationList }}
                                        <li>
                                            <button type="button" class="dropdown-item"
                                                    hx-post="/dashboard/settings/orphans/{{ $orphanID }}/adopt"
                                                    hx-vals='{"station_id": "{{ .ID }}"}'
                                                    hx-target="#orphan-row-{{ $orphanID }}"
                                                    hx-swap="outerHTML">
                                                {{ .Name }}
                                            </button>
                                        </li>
                                        {{ end }}
                                    </ul>
                                    <button type="button" class="btn btn-outline-danger"
                                            hx-delete="/dashboard/settings/orphans/{{ .ID }}"
                                            hx-target="#orphan-row-{{ .ID }}"
                                            hx-swap="outerHTML"
                                            hx-confirm="Remove this orphan record? The file will remain on disk.">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger"
                                            hx-delete="/dashboard/settings/orphans/{{ .ID }}?delete_file=true"
                                            hx-target="#orphan-row-{{ .ID }}"
                                            hx-swap="outerHTML"
                                            hx-confirm="Delete this file from disk? This cannot be undone.">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>

            <!-- Pagination + Page Size -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <!-- Page Size Selector -->
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">Show:</small>
                    <select class="form-select form-select-sm" style="width: auto;"
                            onchange="changePageSize(this.value)">
                        <option value="25" {{ if eq .Data.PageSize 25 }}selected{{ end }}>25</option>
                        <option value="50" {{ if eq .Data.PageSize 50 }}selected{{ end }}>50</option>
                        <option value="100" {{ if eq .Data.PageSize 100 }}selected{{ end }}>100</option>
                        <option value="all" {{ if eq .Data.PageSize 0 }}selected{{ end }}>All</option>
                    </select>
                    <small class="text-muted">per page</small>
                </div>

                <!-- Pagination -->
                {{ if gt .Data.TotalPages 1 }}
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {{ if .Data.HasPrev }}
                        <li class="page-item">
                            <a class="page-link" href="/dashboard/settings/orphans?page={{ .Data.PrevPage }}&per_page={{ .Data.PageSize }}">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                        </li>
                        {{ else }}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-left"></i> Previous</span>
                        </li>
                        {{ end }}

                        <li class="page-item disabled">
                            <span class="page-link">Page {{ .Data.Page }} of {{ .Data.TotalPages }}</span>
                        </li>

                        {{ if .Data.HasNext }}
                        <li class="page-item">
                            <a class="page-link" href="/dashboard/settings/orphans?page={{ .Data.NextPage }}&per_page={{ .Data.PageSize }}">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {{ else }}
                        <li class="page-item disabled">
                            <span class="page-link">Next <i class="bi bi-chevron-right"></i></span>
                        </li>
                        {{ end }}
                    </ul>
                </nav>
                {{ else }}
                <div></div>
                {{ end }}
            </div>
        </div>
    </div>
    {{ end }}

    </div><!-- end #orphans-content -->
</div>

<script>
var _selectAllFlag = false;

function selectAllOrphans(checked) {
    document.querySelectorAll('.orphan-checkbox').forEach(function(cb) {
        cb.checked = checked;
    });
    _selectAllFlag = false;
    updateSelectAllBanner(checked);
}

function onCheckboxChange() {
    _selectAllFlag = false;
    hideBanners();
}

function updateSelectAllBanner(allChecked) {
    var banner = document.getElementById('select-all-banner');
    var confirmed = document.getElementById('select-all-confirmed');
    if (!banner) return;

    confirmed.classList.add('d-none');

    if (!allChecked) {
        banner.classList.add('d-none');
        return;
    }

    var visible = document.querySelectorAll('.orphan-checkbox').length;
    var total = {{ .Data.Total }};

    if (total > visible) {
        document.getElementById('banner-page-count').textContent = visible;
        document.getElementById('banner-total-count').textContent = total;
        banner.classList.remove('d-none');
    } else {
        banner.classList.add('d-none');
    }
}

function selectAllAcrossPages() {
    _selectAllFlag = true;
    var banner = document.getElementById('select-all-banner');
    var confirmed = document.getElementById('select-all-confirmed');
    banner.classList.add('d-none');
    document.getElementById('confirmed-total-count').textContent = {{ .Data.Total }};
    confirmed.classList.remove('d-none');
}

function clearSelectAll() {
    _selectAllFlag = false;
    selectAllOrphans(false);
    hideBanners();
}

function hideBanners() {
    var banner = document.getElementById('select-all-banner');
    var confirmed = document.getElementById('select-all-confirmed');
    if (banner) banner.classList.add('d-none');
    if (confirmed) confirmed.classList.add('d-none');
}

function getSelectedOrphanIds() {
    var ids = [];
    document.querySelectorAll('.orphan-checkbox:checked').forEach(function(cb) {
        ids.push(cb.value);
    });
    return ids;
}

function bulkAdopt() {
    var ids = getSelectedOrphanIds();
    if (!_selectAllFlag && ids.length === 0) {
        alert('Please select at least one orphan');
        return;
    }

    var stationId = document.getElementById('bulk-station').value;
    if (!stationId) {
        alert('Please select a station');
        return;
    }

    var count = _selectAllFlag ? {{ .Data.Total }} : ids.length;
    if (!confirm('Adopt ' + count + ' selected orphan(s) to the chosen station?')) {
        return;
    }

    var formData = new FormData();
    if (_selectAllFlag) {
        formData.append('select_all', 'true');
    } else {
        ids.forEach(function(id) { formData.append('orphan_ids', id); });
    }
    formData.append('station_id', stationId);

    htmx.ajax('POST', '/dashboard/settings/orphans/bulk-adopt', {
        target: '#bulk-result',
        swap: 'innerHTML',
        values: Object.fromEntries(formData)
    });

    _selectAllFlag = false;
    hideBanners();
}

function bulkDelete(deleteFiles) {
    var ids = getSelectedOrphanIds();
    if (!_selectAllFlag && ids.length === 0) {
        alert('Please select at least one orphan');
        return;
    }

    var count = _selectAllFlag ? {{ .Data.Total }} : ids.length;
    var action = deleteFiles ? 'delete ' + count + ' file(s) from disk' : 'remove ' + count + ' record(s)';
    if (!confirm('Are you sure you want to ' + action + '?')) {
        return;
    }

    var formData = new FormData();
    if (_selectAllFlag) {
        formData.append('select_all', 'true');
    } else {
        ids.forEach(function(id) { formData.append('orphan_ids', id); });
    }
    if (deleteFiles) {
        formData.append('delete_files', 'true');
    }

    htmx.ajax('POST', '/dashboard/settings/orphans/bulk-delete', {
        target: '#bulk-result',
        swap: 'innerHTML',
        values: Object.fromEntries(formData)
    });

    _selectAllFlag = false;
    hideBanners();
}

function changePageSize(value) {
    var url = '/dashboard/settings/orphans?page=1';
    if (value !== '25') {
        url += '&per_page=' + value;
    }
    window.location.href = url;
}

// Show scanning indicator when scan starts
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    if (evt.detail.elt && evt.detail.elt.id === 'scan-btn') {
        document.getElementById('scan-result').innerHTML =
            '<div class="alert alert-info">' +
            '<span class="spinner-border spinner-border-sm me-2"></span>' +
            '<strong>Scanning media directory...</strong> This may take a while for large libraries.' +
            '</div>';
    }
});
</script>
{{end}}
