{{define "pages/dashboard/settings/orphans"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/settings">Settings</a></li>
        <li class="breadcrumb-item active">Orphans</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Orphan Media Manager</h1>
            <p class="text-muted mb-0">
                Manage media files found on disk but not in the database
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="/dashboard/settings/migrations" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Migrations
            </a>
            <button type="button" class="btn btn-primary"
                    hx-post="/dashboard/settings/orphans/scan"
                    hx-target="#scan-result"
                    hx-indicator="#scan-spinner">
                <span id="scan-spinner" class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
                <i class="bi bi-search me-1"></i> Scan Now
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div class="h3 mb-0">{{ .Data.Count }}</div>
                    <small class="text-muted">Orphaned Files</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div class="h3 mb-0">{{ .Data.SizeHuman }}</div>
                    <small class="text-muted">Total Size</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body py-3">
                    <div class="h3 mb-0">{{ len .Data.StationList }}</div>
                    <small class="text-muted">Available Stations</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Result Alert -->
    <div id="scan-result" class="mb-4"></div>

    <!-- Info Alert -->
    {{ if eq .Data.Count 0 }}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>No orphaned files detected.</strong>
        <p class="mb-0 mt-2">
            Click "Scan Now" to search for media files on disk that are not in the database.
            This typically happens after a database reset when files remain on disk.
        </p>
    </div>
    {{ else }}

    <!-- Bulk Actions -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="bulk-action-form">
                <div class="row align-items-end g-3">
                    <div class="col-md-4">
                        <label class="form-label">With Selected:</label>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllOrphans(true)">
                                Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllOrphans(false)">
                                Deselect All
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="bulk-station" class="form-label">Adopt to Station:</label>
                        <select id="bulk-station" name="station_id" class="form-select form-select-sm">
                            <option value="">Select station...</option>
                            {{ range .Data.StationList }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-success w-100"
                                onclick="bulkAdopt()"
                                id="bulk-adopt-btn">
                            <i class="bi bi-box-arrow-in-down me-1"></i> Adopt Selected
                        </button>
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group w-100">
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="bulkDelete(false)"
                                    title="Remove from orphan list only">
                                <i class="bi bi-trash me-1"></i> Remove Records
                            </button>
                            <button type="button" class="btn btn-sm btn-danger"
                                    onclick="bulkDelete(true)"
                                    title="Delete files from disk">
                                <i class="bi bi-trash-fill me-1"></i> Delete Files
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Result -->
    <div id="bulk-result" class="mb-4"></div>

    <!-- Orphans Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-sm table-hover">
                    <thead class="sticky-top bg-body">
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>File Path</th>
                            <th>Title (from filename)</th>
                            <th>Size</th>
                            <th>Hash (first 12)</th>
                            <th>Detected</th>
                            <th style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Data.Orphans }}
                        {{$orphanID := .ID}}
                        <tr id="orphan-row-{{ .ID }}">
                            <td>
                                <input type="checkbox" class="form-check-input orphan-checkbox"
                                       name="orphan_ids" value="{{ .ID }}">
                            </td>
                            <td>
                                <code class="small text-break" style="word-break: break-all;">{{ .FilePath }}</code>
                            </td>
                            <td>{{ .Title }}</td>
                            <td>{{ formatBytes .FileSize }}</td>
                            <td>
                                {{ if .ContentHash }}
                                <code class="small">{{ slice .ContentHash 0 12 }}...</code>
                                {{ else }}
                                <span class="text-muted">-</span>
                                {{ end }}
                            </td>
                            <td>
                                <small class="text-muted">{{ .DetectedAt.Format "Jan 2, 15:04" }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-success dropdown-toggle"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-box-arrow-in-down"></i> Adopt
                                    </button>
                                    <ul class="dropdown-menu">
                                        {{ range $.Data.StationList }}
                                        <li>
                                            <button type="button" class="dropdown-item"
                                                    hx-post="/dashboard/settings/orphans/{{ $orphanID }}/adopt"
                                                    hx-vals='{"station_id": "{{ .ID }}"}'
                                                    hx-target="#orphan-row-{{ $orphanID }}"
                                                    hx-swap="outerHTML">
                                                {{ .Name }}
                                            </button>
                                        </li>
                                        {{ end }}
                                    </ul>
                                    <button type="button" class="btn btn-outline-danger"
                                            hx-delete="/dashboard/settings/orphans/{{ .ID }}"
                                            hx-target="#orphan-row-{{ .ID }}"
                                            hx-swap="outerHTML"
                                            hx-confirm="Remove this orphan record? The file will remain on disk.">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger"
                                            hx-delete="/dashboard/settings/orphans/{{ .ID }}?delete_file=true"
                                            hx-target="#orphan-row-{{ .ID }}"
                                            hx-swap="outerHTML"
                                            hx-confirm="Delete this file from disk? This cannot be undone.">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {{ if gt .Data.TotalPages 1 }}
            <nav class="mt-3">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {{ if .Data.HasPrev }}
                    <li class="page-item">
                        <a class="page-link" href="/dashboard/settings/orphans?page={{ .Data.PrevPage }}">
                            <i class="bi bi-chevron-left"></i> Previous
                        </a>
                    </li>
                    {{ else }}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-left"></i> Previous</span>
                    </li>
                    {{ end }}

                    <li class="page-item disabled">
                        <span class="page-link">Page {{ .Data.Page }} of {{ .Data.TotalPages }}</span>
                    </li>

                    {{ if .Data.HasNext }}
                    <li class="page-item">
                        <a class="page-link" href="/dashboard/settings/orphans?page={{ .Data.NextPage }}">
                            Next <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {{ else }}
                    <li class="page-item disabled">
                        <span class="page-link">Next <i class="bi bi-chevron-right"></i></span>
                    </li>
                    {{ end }}
                </ul>
            </nav>
            {{ end }}
        </div>
    </div>
    {{ end }}
</div>

<script>
function selectAllOrphans(select) {
    document.querySelectorAll('.orphan-checkbox').forEach(cb => {
        cb.checked = select;
    });
}

function getSelectedOrphanIds() {
    const ids = [];
    document.querySelectorAll('.orphan-checkbox:checked').forEach(cb => {
        ids.push(cb.value);
    });
    return ids;
}

function bulkAdopt() {
    const ids = getSelectedOrphanIds();
    if (ids.length === 0) {
        alert('Please select at least one orphan');
        return;
    }

    const stationId = document.getElementById('bulk-station').value;
    if (!stationId) {
        alert('Please select a station');
        return;
    }

    if (!confirm('Adopt ' + ids.length + ' selected orphan(s) to the chosen station?')) {
        return;
    }

    const formData = new FormData();
    ids.forEach(id => formData.append('orphan_ids', id));
    formData.append('station_id', stationId);

    htmx.ajax('POST', '/dashboard/settings/orphans/bulk-adopt', {
        target: '#bulk-result',
        swap: 'innerHTML',
        values: Object.fromEntries(formData)
    });
}

function bulkDelete(deleteFiles) {
    const ids = getSelectedOrphanIds();
    if (ids.length === 0) {
        alert('Please select at least one orphan');
        return;
    }

    const action = deleteFiles ? 'delete ' + ids.length + ' file(s) from disk' : 'remove ' + ids.length + ' record(s)';
    if (!confirm('Are you sure you want to ' + action + '?')) {
        return;
    }

    const formData = new FormData();
    ids.forEach(id => formData.append('orphan_ids', id));
    if (deleteFiles) {
        formData.append('delete_files', 'true');
    }

    htmx.ajax('POST', '/dashboard/settings/orphans/bulk-delete', {
        target: '#bulk-result',
        swap: 'innerHTML',
        values: Object.fromEntries(formData)
    });
}

// Refresh page when an orphan is updated
document.body.addEventListener('orphan-updated', function() {
    setTimeout(() => location.reload(), 1000);
});
</script>
{{end}}
