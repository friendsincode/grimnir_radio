{{define "pages/dashboard/settings/migrations"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/settings">Settings</a></li>
        <li class="breadcrumb-item active">Migrations</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
{{$data := .Data}}
{{$sources := index $data "SupportedSources"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-box-arrow-in-down me-2"></i>Migrations & Import</h4>
    <div>
        <a href="/dashboard/settings/migrations/status" class="btn btn-outline-info me-2">
            <i class="bi bi-activity me-1"></i>View Status
        </a>
        <a href="/dashboard/settings" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back to Settings
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- AzuraCast Live API Import -->
    <div class="col-lg-8">
        <div class="card border-primary mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-cloud-download me-2"></i>AzuraCast Live API Import</h5>
            </div>
            <div class="card-body">
                <p class="text-body-secondary mb-4">
                    Connect directly to a running AzuraCast instance to import all stations, media, playlists, and schedules.
                    Media files are downloaded directly - no backup file needed.
                </p>
                <form method="POST" action="/dashboard/settings/migrations/azuracast-api"
                      hx-post="/dashboard/settings/migrations/azuracast-api"
                      hx-target="#azuracast-import-result"
                      hx-indicator="#azuracast-import-loading">

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">AzuraCast URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" name="azuracast_url"
                                   placeholder="https://azuracast.example.com" required>
                            <div class="form-text">The base URL of your AzuraCast installation.</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Authentication</label>
                            <ul class="nav nav-pills mb-2" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="apikey-tab" data-bs-toggle="pill" data-bs-target="#apikey-panel" type="button" role="tab">API Key</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="credentials-tab" data-bs-toggle="pill" data-bs-target="#credentials-panel" type="button" role="tab">Username/Password</button>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="apikey-panel" role="tabpanel">
                                    <input type="password" class="form-control" name="api_key"
                                           placeholder="Your AzuraCast API key">
                                    <div class="form-text">
                                        Generate an API key in AzuraCast: Profile &rarr; API Keys.
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="credentials-panel" role="tabpanel">
                                    <div class="mb-2">
                                        <input type="text" class="form-control" name="username"
                                               placeholder="AzuraCast username">
                                    </div>
                                    <div>
                                        <input type="password" class="form-control" name="password"
                                               placeholder="AzuraCast password">
                                    </div>
                                    <div class="form-text">
                                        Use your AzuraCast login credentials.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="skip_media" id="skipMedia">
                            <label class="form-check-label" for="skipMedia">
                                Skip media download (metadata only)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="skip_users" id="skipUsers">
                            <label class="form-check-label" for="skipUsers">
                                Skip streamer/DJ import
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="dry_run" id="dryRun">
                            <label class="form-check-label" for="dryRun">
                                Dry run (analyze only, don't import)
                            </label>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary"
                                hx-post="/dashboard/settings/migrations/azuracast-api/test"
                                hx-include="[name='azuracast_url'], [name='api_key']"
                                hx-target="#azuracast-import-result">
                            <i class="bi bi-plug me-1"></i>Test Connection
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-cloud-download me-1"></i>Start Import
                        </button>
                        <span id="azuracast-import-loading" class="htmx-indicator spinner-border spinner-border-sm text-primary ms-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </span>
                    </div>
                </form>
                <div id="azuracast-import-result" class="mt-3"></div>
            </div>
        </div>

        <!-- LibreTime Live API Import -->
        <div class="card border-success mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-cloud-download me-2"></i>LibreTime Live API Import</h5>
            </div>
            <div class="card-body">
                <p class="text-body-secondary mb-4">
                    Connect directly to a running LibreTime (v3.0+) instance to import media, playlists, and shows.
                    Media files are downloaded directly via the LibreTime API.
                </p>
                <form method="POST" action="/dashboard/settings/migrations/libretime-api"
                      hx-post="/dashboard/settings/migrations/libretime-api"
                      hx-target="#libretime-import-result"
                      hx-indicator="#libretime-import-loading">

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">LibreTime URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" name="libretime_url"
                                   placeholder="https://libretime.example.com" required>
                            <div class="form-text">The base URL of your LibreTime installation.</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">API Key <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="api_key"
                                   placeholder="Your LibreTime API key" required>
                            <div class="form-text">
                                Found in LibreTime's <code>/etc/libretime/config.yml</code> under <code>general.api_key</code>.
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Target Station</label>
                            <select class="form-select" name="target_station_id">
                                <option value="">Create new station</option>
                                {{range .Stations}}
                                <option value="{{.ID}}">{{.Name}}</option>
                                {{end}}
                            </select>
                            <div class="form-text">Import into an existing station or create a new one.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="skip_media" id="ltSkipMedia">
                            <label class="form-check-label" for="ltSkipMedia">
                                Skip media download (metadata only)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="dry_run" id="ltDryRun">
                            <label class="form-check-label" for="ltDryRun">
                                Dry run (analyze only, don't import)
                            </label>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary"
                                hx-post="/dashboard/settings/migrations/libretime-api/test"
                                hx-include="[name='libretime_url'], [name='api_key']"
                                hx-target="#libretime-import-result">
                            <i class="bi bi-plug me-1"></i>Test Connection
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-cloud-download me-1"></i>Start Import
                        </button>
                        <span id="libretime-import-loading" class="htmx-indicator spinner-border spinner-border-sm text-success ms-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </span>
                    </div>
                </form>
                <div id="libretime-import-result" class="mt-3"></div>
            </div>
        </div>

        <!-- File-based Import Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Import from Backup File</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/dashboard/settings/migrations/import"
                      enctype="multipart/form-data"
                      hx-post="/dashboard/settings/migrations/import"
                      hx-encoding="multipart/form-data"
                      hx-swap="none">

                    <div class="mb-4">
                        <label class="form-label">Import Source <span class="text-danger">*</span></label>
                        <select class="form-select" name="source_type" required>
                            <option value="">Select source...</option>
                            {{range $sources}}
                            <option value="{{lower .}}">{{.}}</option>
                            {{end}}
                        </select>
                        <div class="form-text">Choose the source system you're importing from.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Import File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" name="import_file" required
                               accept=".zip,.sql,.csv,.json,.xml,.tar.gz">
                        <div class="form-text">
                            Upload the export file from your source system.
                            Supported formats: ZIP, SQL, CSV, JSON, XML, TAR.GZ (depending on source).
                        </div>
                    </div>

                    <div class="alert alert-warning mb-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> Importing data may take time depending on the size of your library.
                        The import runs in the background - you can continue using the system.
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload me-1"></i>Start Import
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Supported Sources -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Supported Sources</h5>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <strong>LibreTime</strong>
                    <br><small class="text-body-secondary">Full database export (SQL or API dump)</small>
                </li>
                <li class="list-group-item">
                    <strong>AzuraCast</strong>
                    <br><small class="text-body-secondary">Station backup ZIP file</small>
                </li>
                <li class="list-group-item">
                    <strong>RadioBoss</strong>
                    <br><small class="text-body-secondary">Playlist and database export</small>
                </li>
                <li class="list-group-item">
                    <strong>PlayoutONE</strong>
                    <br><small class="text-body-secondary">Database backup</small>
                </li>
                <li class="list-group-item">
                    <strong>CSV Import</strong>
                    <br><small class="text-body-secondary">Generic media metadata CSV</small>
                </li>
            </ul>
        </div>

        <!-- Import Instructions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Help</h5>
            </div>
            <div class="card-body">
                <p class="small text-body-secondary mb-2">
                    <strong>What gets imported:</strong>
                </p>
                <ul class="small text-body-secondary mb-0">
                    <li>Media metadata (not the files themselves)</li>
                    <li>Playlists and smart blocks</li>
                    <li>Show schedules</li>
                    <li>User accounts (passwords reset)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{{end}}
