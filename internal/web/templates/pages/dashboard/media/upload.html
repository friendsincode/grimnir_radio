{{define "pages/dashboard/media/upload"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/media">Media Library</a></li>
        <li class="breadcrumb-item active">Upload</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <h4 class="mb-4"><i class="bi bi-upload me-2"></i>Upload Media</h4>

        <div class="card">
            <div class="card-body">
                <div class="upload-zone text-center" id="uploadZone">
                    <input type="file" class="d-none" id="fileInput"
                           accept=".mp3,.flac,.wav,.ogg,.m4a" multiple>

                    <i class="bi bi-cloud-upload fs-1 text-primary mb-3"></i>
                    <h5>Drag & Drop Files Here</h5>
                    <p class="text-body-secondary mb-3">
                        or click to browse
                    </p>
                    <p class="small text-body-secondary">
                        Supported formats: MP3, FLAC, WAV, OGG, M4A
                    </p>

                    <div class="progress d-none" id="uploadProgress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div id="uploadResults" class="mt-4"></div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Upload Tips</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Files will be automatically analyzed for loudness, BPM, and waveform data</li>
                    <li>Metadata (ID3 tags) will be extracted automatically</li>
                    <li>For best results, use high-quality source files (FLAC or WAV)</li>
                    <li>Maximum file size: 1GB per file</li>
                    <li>You can edit metadata after upload</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const progress = document.getElementById('uploadProgress');
const progressBar = progress.querySelector('.progress-bar');
const results = document.getElementById('uploadResults');

let isUploading = false;
let currentBatch = null;

uploadZone.addEventListener('click', (e) => {
    if (isUploading) return;
    fileInput.click();
});

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        handleFiles(fileInput.files);
    }
    // Clear input so the same file can be selected again if needed
    fileInput.value = '';
});

function handleFiles(files) {
    if (isUploading) return;

    const fileArray = Array.from(files);
    if (fileArray.length === 0) return;

    const dedupedFiles = dedupeBatchFiles(fileArray);
    const totalBytes = dedupedFiles.reduce((sum, file) => sum + (file.size || 0), 0);

    currentBatch = {
        files: dedupedFiles,
        totalBytes,
        completedBytes: 0,
        currentFileLoaded: 0,
        uploadedCount: 0,
        failedCount: 0
    };

    isUploading = true;
    uploadZone.classList.add('uploading');
    progress.classList.remove('d-none');
    updateProgressUI();
    uploadFilesSequentially();
}

function dedupeBatchFiles(files) {
    const seen = new Set();
    const deduped = [];

    for (const file of files) {
        const key = `${file.name}|${file.size}|${file.lastModified}`;
        if (seen.has(key)) {
            addResult(file.name, 'warning', 'Skipped duplicate in this batch');
            continue;
        }
        seen.add(key);
        deduped.push(file);
    }

    return deduped;
}

function uploadFilesSequentially() {
    const run = async () => {
        for (const file of currentBatch.files) {
            await uploadFile(file);
        }
        finishBatch();
    };
    run();
}

function updateProgressUI() {
    if (!currentBatch) return;

    const total = currentBatch.totalBytes;
    const loaded = currentBatch.completedBytes + currentBatch.currentFileLoaded;
    const percent = total > 0 ? Math.min(100, Math.round((loaded / total) * 100)) : 0;

    progressBar.style.width = `${percent}%`;
    progressBar.textContent = `${percent}% (${currentBatch.uploadedCount + currentBatch.failedCount}/${currentBatch.files.length} files)`;
}

function finishBatch() {
    if (!currentBatch) return;

    progressBar.style.width = '100%';
    progressBar.textContent = `100% (${currentBatch.files.length}/${currentBatch.files.length} files)`;

    isUploading = false;
    uploadZone.classList.remove('uploading');

    setTimeout(() => {
        progress.classList.add('d-none');
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
    }, 1200);

    currentBatch = null;
}

function uploadFile(file) {
    return new Promise((resolve) => {
        const fileSize = file.size || 0;
        let lastLoaded = 0;

        currentBatch.currentFileLoaded = 0;
        updateProgressUI();

        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/dashboard/media/upload');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.upload.addEventListener('progress', (e) => {
            if (!e.lengthComputable || !currentBatch) return;

            const clamped = Math.min(fileSize, Math.max(lastLoaded, e.loaded));
            lastLoaded = clamped;
            currentBatch.currentFileLoaded = clamped;
            updateProgressUI();
        });

        xhr.addEventListener('load', () => {
            const ok = xhr.status >= 200 && xhr.status < 300;

            currentBatch.completedBytes += fileSize;
            currentBatch.currentFileLoaded = 0;

            if (ok) {
                currentBatch.uploadedCount += 1;
                addResult(file.name, 'success', 'Uploaded successfully');
            } else if (xhr.status === 409) {
                currentBatch.failedCount += 1;
                addResult(file.name, 'warning', 'Skipped duplicate (already in library)');
            } else {
                currentBatch.failedCount += 1;
                addResult(file.name, 'danger', 'Upload failed: ' + (xhr.responseText || `HTTP ${xhr.status}`));
            }

            updateProgressUI();
            resolve();
        });

        xhr.addEventListener('error', () => {
            currentBatch.completedBytes += fileSize;
            currentBatch.currentFileLoaded = 0;
            currentBatch.failedCount += 1;
            addResult(file.name, 'danger', 'Upload failed - network error');
            updateProgressUI();
            resolve();
        });

        xhr.send(formData);
    });
}

function addResult(filename, status, message) {
    const icon = status === 'success'
        ? 'check-circle'
        : status === 'warning'
            ? 'exclamation-triangle'
            : 'exclamation-circle';
    const safeFilename = escapeHtml(filename);
    const safeMessage = escapeHtml(message);

    const div = document.createElement('div');
    div.className = `alert alert-${status} d-flex align-items-center`;
    div.innerHTML = `
        <i class="bi bi-${icon} me-2"></i>
        <div class="flex-grow-1">
            <strong>${safeFilename}</strong> - ${safeMessage}
        </div>
    `;
    results.prepend(div);
}

function escapeHtml(value) {
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}
</script>
{{end}}
