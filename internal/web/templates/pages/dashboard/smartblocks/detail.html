{{define "pages/dashboard/smartblocks/detail"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
{{$block := .Data}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/smart-blocks">Smart Blocks</a></li>
        <li class="breadcrumb-item active">{{$block.Name}}</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
{{$block := .Data}}
{{$rules := $block.Rules}}
{{$seq := $block.Sequence}}
<div class="row">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-1"><i class="bi bi-magic me-2"></i>{{$block.Name}}</h4>
                {{if $block.Description}}
                <p class="text-body-secondary mb-0">{{$block.Description}}</p>
                {{end}}
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary"
                        hx-post="/dashboard/smart-blocks/{{$block.ID}}/duplicate"
                        hx-swap="none">
                    <i class="bi bi-copy me-1"></i>Duplicate
                </button>
                <a href="/dashboard/smart-blocks/{{$block.ID}}/edit" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i>Edit
                </a>
                <button class="btn btn-outline-danger"
                        hx-delete="/dashboard/smart-blocks/{{$block.ID}}"
                        hx-confirm="Delete this smart block?">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>

        <!-- Core Settings -->
        <div class="card mb-3 border-primary">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-sliders me-2"></i>Core Settings
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Target Duration</label>
                        <p class="mb-0 fw-medium fs-5">
                            {{with index $rules "targetMinutes"}}
                            {{if ge . 1440}}{{div . 1440}} days{{else if ge . 60}}{{div . 60}}h {{mod . 60}}m{{else}}{{.}} min{{end}}
                            {{else}}<span class="text-body-secondary">Not set</span>{{end}}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Accuracy</label>
                        <p class="mb-0 fw-medium">
                            Â±{{with index $rules "durationAccuracy"}}{{.}}{{else}}2{{end}} seconds
                        </p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Selection Mode</label>
                        <p class="mb-0 fw-medium">
                            {{with $seq}}{{with index . "mode"}}
                            {{if eq . "random"}}<i class="bi bi-shuffle me-1"></i>Random{{end}}
                            {{if eq . "shuffle"}}<i class="bi bi-arrow-repeat me-1"></i>Shuffle{{end}}
                            {{if eq . "weighted"}}<i class="bi bi-bar-chart me-1"></i>Weighted{{end}}
                            {{else}}<i class="bi bi-shuffle me-1"></i>Random{{end}}
                            {{else}}<i class="bi bi-shuffle me-1"></i>Random{{end}}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Source Scope -->
        {{if or (index $rules "sourcePlaylists") (index $rules "includePublicArchive")}}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-collection-play me-2"></i>Source Scope
            </div>
            <div class="card-body">
                {{with index $rules "sourcePlaylists"}}
                <div class="d-flex flex-wrap gap-2">
                    {{range .}}
                    <span class="badge bg-secondary">{{.}}</span>
                    {{end}}
                </div>
                {{end}}
                {{if index $rules "includePublicArchive"}}
                <div class="mt-2">
                    <span class="badge bg-info text-dark"><i class="bi bi-globe me-1"></i>Includes Public Archive (Primary Selection)</span>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        <!-- Selection Filters -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-funnel me-2"></i>Selection Filters
            </div>
            <div class="card-body">
                {{if or (index $rules "genre") (index $rules "artist") (index $rules "mood") (index $rules "era") (index $rules "language") (index $rules "bpmRange") (index $rules "excludeExplicit")}}
                <div class="row g-3">
                    {{with index $rules "genre"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Genre</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index $rules "artist"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Artist</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index $rules "mood"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Mood</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index $rules "era"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Era</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index $rules "language"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Language</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index $rules "bpmRange"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">BPM Range</label>
                        <p class="mb-0 fw-medium">{{index . "min"}} - {{index . "max"}}</p>
                    </div>
                    {{end}}
                    {{if index $rules "excludeExplicit"}}
                    <div class="col-12">
                        <span class="badge bg-warning text-dark"><i class="bi bi-ban me-1"></i>Excludes explicit</span>
                    </div>
                    {{end}}
                </div>
                {{else}}
                <p class="text-body-secondary mb-0"><i class="bi bi-check-circle me-1"></i>Matches all media</p>
                {{end}}
            </div>
        </div>

        <!-- Repeat Prevention -->
        {{with index $rules "separation"}}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-clock-history me-2"></i>Repeat Prevention
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {{with index . "artist"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Artist</label>
                        <p class="mb-0 fw-medium">{{.}} min</p>
                    </div>
                    {{end}}
                    {{with index . "title"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Title</label>
                        <p class="mb-0 fw-medium">{{.}} min</p>
                    </div>
                    {{end}}
                    {{with index . "album"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Album</label>
                        <p class="mb-0 fw-medium">{{.}} min</p>
                    </div>
                    {{end}}
                    {{with index . "label"}}
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Label</label>
                        <p class="mb-0 fw-medium">{{.}} min</p>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}

        <!-- Priority Boosters -->
        {{with index $rules "weights"}}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-lightning-charge me-2"></i>Priority Boosters
                <span class="badge bg-warning text-dark ms-2">{{len .}}</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead><tr><th>Field</th><th>Value</th><th>Weight</th></tr></thead>
                    <tbody>
                        {{range .}}
                        <tr>
                            <td>{{index . "field"}}</td>
                            <td><strong>{{index . "value"}}</strong></td>
                            <td><span class="badge bg-success">+{{index . "weight"}}%</span></td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        <!-- Quotas -->
        {{with index $rules "quotas"}}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-pie-chart me-2"></i>Category Quotas
                <span class="badge bg-info ms-2">{{len .}}</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead><tr><th>Field</th><th>Value</th><th>Min %</th><th>Max %</th></tr></thead>
                    <tbody>
                        {{range .}}
                        <tr>
                            <td>{{index . "field"}}</td>
                            <td><strong>{{index . "value"}}</strong></td>
                            <td>{{index . "minPct"}}%</td>
                            <td>{{index . "maxPct"}}%</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        <!-- Ads / Interstitials -->
        {{with index $rules "interstitials"}}
        {{if index . "enabled"}}
        <div class="card mb-3 border-success">
            <div class="card-header bg-success text-white">
                <i class="bi bi-megaphone me-2"></i>Ads / Interstitials
            </div>
            <div class="card-body">
                {{$ads := .}}
                <div class="row g-3">
                    {{with index $ads "sources"}}
                    <div class="col-12">
                        <label class="form-label small text-body-secondary mb-1">Source Logic</label>
                        <p class="mb-2 fw-medium">{{if eq (index $ads "logic") "all"}}ALL (AND){{else}}ANY (OR){{end}}</p>
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead><tr><th>#</th><th>Type</th><th>Value</th></tr></thead>
                                <tbody>
                                    {{range $i, $src := .}}
                                    <tr>
                                        <td>{{add $i 1}}</td>
                                        <td>
                                            {{if eq (index $src "sourceType") "playlist"}}Playlist{{else if eq (index $src "sourceType") "genre"}}Genre{{else if eq (index $src "sourceType") "title"}}Title Contains{{else if eq (index $src "sourceType") "artist"}}Artist Contains{{else if eq (index $src "sourceType") "label"}}Label Contains{{else}}{{index $src "sourceType"}}{{end}}
                                        </td>
                                        <td>
                                            {{if index $src "playlistID"}}{{index $src "playlistID"}}{{else if index $src "genre"}}{{index $src "genre"}}{{else}}{{index $src "query"}}{{end}}
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {{else}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Source</label>
                        <p class="mb-0 fw-medium">
                            {{if eq (index . "sourceType") "playlist"}}Playlist{{else if eq (index . "sourceType") "genre"}}Genre{{else if eq (index . "sourceType") "title"}}Title Contains{{else if eq (index . "sourceType") "artist"}}Artist Contains{{else if eq (index . "sourceType") "label"}}Label Contains{{else}}{{index . "sourceType"}}{{end}}
                        </p>
                    </div>
                    {{with index . "playlistID"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Playlist ID</label>
                        <p class="mb-0 fw-medium text-truncate">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index . "genre"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Genre</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index . "query"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Query</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{end}}
                    {{if index . "includePublicArchive"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Archive Scope</label>
                        <p class="mb-0 fw-medium"><span class="badge bg-info text-dark"><i class="bi bi-globe me-1"></i>Public Archive (Ads only)</span></p>
                    </div>
                    {{end}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Frequency</label>
                        <p class="mb-0 fw-medium">Every {{index . "every"}} tracks</p>
                    </div>
                    {{with index . "perBreak"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Per Break</label>
                        <p class="mb-0 fw-medium">{{.}} ads</p>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
        {{end}}

        <!-- Bumpers -->
        {{with index $rules "bumpers"}}
        {{if index . "enabled"}}
        <div class="card mb-3 border-info">
            <div class="card-header bg-info text-dark">
                <i class="bi bi-signpost-split me-2"></i>Bumpers (Tail Fill)
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Source</label>
                        <p class="mb-0 fw-medium">
                            {{if eq (index . "sourceType") "playlist"}}Playlist{{else if eq (index . "sourceType") "genre"}}Genre{{else if eq (index . "sourceType") "title"}}Title Contains{{else if eq (index . "sourceType") "artist"}}Artist Contains{{else if eq (index . "sourceType") "label"}}Label Contains{{else}}{{index . "sourceType"}}{{end}}
                        </p>
                    </div>
                    {{with index . "query"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Query</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index . "playlistID"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Playlist ID</label>
                        <p class="mb-0 fw-medium text-truncate">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index . "genre"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Genre</label>
                        <p class="mb-0 fw-medium">{{.}}</p>
                    </div>
                    {{end}}
                    {{with index . "maxPerGap"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Max at End</label>
                        <p class="mb-0 fw-medium">{{.}} bumpers</p>
                    </div>
                    {{end}}
                    {{if index . "includePublicArchive"}}
                    <div class="col-md-4">
                        <label class="form-label small text-body-secondary mb-1">Archive Scope</label>
                        <p class="mb-0 fw-medium"><span class="badge bg-info text-dark"><i class="bi bi-globe me-1"></i>Public Archive (Bumpers only)</span></p>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
        {{end}}

        <!-- Fallbacks -->
        {{with index $rules "fallbacks"}}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-arrow-repeat me-2"></i>Fallback Blocks
                <span class="badge bg-secondary ms-2">{{len .}}</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead><tr><th>#</th><th>Block ID</th><th>Limit</th></tr></thead>
                    <tbody>
                        {{range $i, $f := .}}
                        <tr>
                            <td><span class="badge bg-secondary">{{add $i 1}}</span></td>
                            <td class="text-truncate" style="max-width: 250px;">{{index $f "blockID"}}</td>
                            <td>{{index $f "limit"}} tracks max</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        <!-- Energy Curve -->
        {{with index $seq "energyCurve"}}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-activity me-2"></i>Energy Curve
            </div>
            <div class="card-body">
                <div class="d-flex align-items-end justify-content-around" style="height: 80px;">
                    {{range $i, $v := .}}
                    <div class="text-center" style="flex: 1;">
                        <div class="bg-primary rounded" style="height: {{$v}}%; min-height: 4px; margin: 0 2px;"></div>
                        <small class="text-body-secondary">{{add $i 1}}</small>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}

        <!-- Meta Info -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>Details
            </div>
            <div class="card-body">
                <div class="row g-3 small">
                    <div class="col-md-4">
                        <label class="form-label text-body-secondary mb-0">ID</label>
                        <p class="mb-0 font-monospace text-truncate">{{$block.ID}}</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-body-secondary mb-0">Created</label>
                        <p class="mb-0">{{formatTime $block.CreatedAt}}</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-body-secondary mb-0">Updated</label>
                        <p class="mb-0">{{formatTime $block.UpdatedAt}}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 1rem;">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-eye me-2"></i>Preview</span>
                <button class="btn btn-sm btn-light"
                        hx-post="/dashboard/smart-blocks/{{$block.ID}}/preview"
                        hx-target="#previewResults"
                        hx-indicator="#previewSpinner">
                    <i class="bi bi-play-fill"></i> Generate
                </button>
            </div>
            <div class="card-body p-0">
                <div id="previewSpinner" class="htmx-indicator text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="small text-muted mt-2">Generating...</div>
                </div>
                <div id="previewResults" style="max-height: 500px; overflow-y: auto;">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-play-circle fs-1 d-block mb-2 opacity-50"></i>
                        <small>Click Generate to preview</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}
