{{define "pages/dashboard/schedule/calendar"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "head"}}
<!-- FullCalendar 6.x includes CSS in JS bundle -->
<style>
    #calendar {
        height: calc(100vh - 200px);
        min-height: 500px;
    }
    .fc-event {
        cursor: pointer;
        font-size: 0.85rem;
    }
    .fc-timegrid-slot {
        height: 2em;
    }
    /* Context Menu */
    .context-menu {
        position: fixed;
        z-index: 9999;
        min-width: 180px;
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        padding: 0.5rem 0;
        display: none;
    }
    .context-menu.show {
        display: block;
    }
    .context-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--bs-body-color);
        font-size: 0.875rem;
        transition: background 0.15s;
    }
    .context-menu-item:hover {
        background: var(--bs-tertiary-bg);
    }
    .context-menu-item i {
        width: 1.25rem;
        text-align: center;
        color: var(--bs-secondary);
    }
    .context-menu-item.danger {
        color: var(--bs-danger);
    }
    .context-menu-item.danger i {
        color: var(--bs-danger);
    }
    .context-menu-divider {
        border-top: 1px solid var(--bs-border-color);
        margin: 0.5rem 0;
    }
    /* Selection highlight */
    .fc-highlight {
        background: rgba(var(--bs-primary-rgb), 0.2) !important;
    }
    /* Source type colors - using CSS custom properties for theme support */
    :root {
        --calendar-color-media: #6366f1;
        --calendar-color-playlist: #10b981;
        --calendar-color-smartblock: #06b6d4;
        --calendar-color-live: #ef4444;
        --calendar-color-webstream: #f59e0b;
        --calendar-color-clock: #8b5cf6;
    }
    .fc-event.event-media { background: var(--calendar-color-media) !important; border-color: var(--calendar-color-media) !important; }
    .fc-event.event-playlist { background: var(--calendar-color-playlist) !important; border-color: var(--calendar-color-playlist) !important; }
    .fc-event.event-smart_block { background: var(--calendar-color-smartblock) !important; border-color: var(--calendar-color-smartblock) !important; }
    .fc-event.event-live { background: var(--calendar-color-live) !important; border-color: var(--calendar-color-live) !important; }
    .fc-event.event-webstream { background: var(--calendar-color-webstream) !important; border-color: var(--calendar-color-webstream) !important; color: var(--bs-dark) !important; }
    .fc-event.event-clock_template { background: var(--calendar-color-clock) !important; border-color: var(--calendar-color-clock) !important; }
    /* Badge for purple/clock type */
    .badge.bg-purple { background-color: var(--calendar-color-clock) !important; }
</style>
<script>
// Apply calendar color theme
(function() {
    const colorTheme = '{{index .Data "ColorTheme"}}' || 'default';
    const themes = {
        'default': { media: '#6366f1', playlist: '#10b981', smartblock: '#06b6d4', live: '#ef4444', webstream: '#f59e0b', clock: '#8b5cf6' },
        'ocean': { media: '#0ea5e9', playlist: '#14b8a6', smartblock: '#06b6d4', live: '#3b82f6', webstream: '#0891b2', clock: '#22d3ee' },
        'forest': { media: '#22c55e', playlist: '#10b981', smartblock: '#84cc16', live: '#16a34a', webstream: '#059669', clock: '#4ade80' },
        'sunset': { media: '#f97316', playlist: '#ef4444', smartblock: '#ec4899', live: '#f43f5e', webstream: '#fb923c', clock: '#e11d48' },
        'berry': { media: '#a855f7', playlist: '#8b5cf6', smartblock: '#d946ef', live: '#c026d3', webstream: '#9333ea', clock: '#e879f9' },
        'earth': { media: '#92400e', playlist: '#f59e0b', smartblock: '#78716c', live: '#b45309', webstream: '#d97706', clock: '#a16207' },
        'neon': { media: '#00ff88', playlist: '#ff0088', smartblock: '#00ffff', live: '#ffff00', webstream: '#ff00ff', clock: '#88ff00' },
        'pastel': { media: '#93c5fd', playlist: '#a5b4fc', smartblock: '#c4b5fd', live: '#f9a8d4', webstream: '#fca5a5', clock: '#fed7aa' }
    };
    const colors = themes[colorTheme] || themes['default'];
    const root = document.documentElement;
    root.style.setProperty('--calendar-color-media', colors.media);
    root.style.setProperty('--calendar-color-playlist', colors.playlist);
    root.style.setProperty('--calendar-color-smartblock', colors.smartblock);
    root.style.setProperty('--calendar-color-live', colors.live);
    root.style.setProperty('--calendar-color-webstream', colors.webstream);
    root.style.setProperty('--calendar-color-clock', colors.clock);
})();
</script>
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Schedule</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Schedule</h4>
    <div class="d-flex gap-2">
        <select class="form-select form-select-sm" id="mountFilter" style="width: 200px;">
            <option value="">All Mounts</option>
            {{range .Data.Mounts}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
        {{if roleAtLeast .User "manager"}}
        <button class="btn btn-outline-primary btn-sm"
                hx-post="/dashboard/schedule/refresh"
                hx-swap="none">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
        {{end}}
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div id="calendar"></div>
    </div>
</div>

<!-- Context Menu for Calendar -->
<div id="calendarContextMenu" class="context-menu">
    <div class="context-menu-item" data-action="add-media">
        <i class="bi bi-music-note"></i>
        <span>Add Media</span>
    </div>
    <div class="context-menu-item" data-action="add-playlist">
        <i class="bi bi-list-ul"></i>
        <span>Add Playlist</span>
    </div>
    <div class="context-menu-item" data-action="add-smartblock">
        <i class="bi bi-magic"></i>
        <span>Add Smart Block</span>
    </div>
    <div class="context-menu-item" data-action="add-clock">
        <i class="bi bi-clock-history"></i>
        <span>Add Clock Template</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="add-webstream">
        <i class="bi bi-globe"></i>
        <span>Add Webstream</span>
    </div>
    <div class="context-menu-item" data-action="add-live">
        <i class="bi bi-broadcast"></i>
        <span>Schedule Live Session</span>
    </div>
</div>

<!-- Context Menu for Events -->
<div id="eventContextMenu" class="context-menu">
    <div class="context-menu-item" data-action="event-details">
        <i class="bi bi-info-circle"></i>
        <span>View Details</span>
    </div>
    <div class="context-menu-item" data-action="event-edit">
        <i class="bi bi-pencil"></i>
        <span>Edit</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="event-duplicate">
        <i class="bi bi-copy"></i>
        <span>Duplicate</span>
    </div>
    <div class="context-menu-item" data-action="event-move">
        <i class="bi bi-arrows-move"></i>
        <span>Move to...</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" data-action="event-delete">
        <i class="bi bi-trash"></i>
        <span>Delete</span>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {{if roleAtLeast .User "manager"}}
                <button type="button" class="btn btn-danger" id="deleteEventBtn" title="Delete this event">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                {{end}}
            </div>
        </div>
    </div>
</div>

<!-- Add Schedule Entry Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Add to Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addScheduleForm">
                    <input type="hidden" id="scheduleStartTime" name="starts_at">
                    <input type="hidden" id="scheduleEndTime" name="ends_at">

                    <!-- Date Selection -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="scheduleStartDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="scheduleEndDate" required>
                        </div>
                    </div>

                    <!-- Time Selection -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Time</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="scheduleStartHour" style="width: 80px;">
                                    {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                                </select>
                                <span class="align-self-center">:</span>
                                <select class="form-select" id="scheduleStartMinute" style="width: 80px;">
                                    <option value="0">00</option>
                                    <option value="5">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="start" data-delta="-15" title="Subtract 15 minutes">-15m</button>
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="start" data-delta="15" title="Add 15 minutes">+15m</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Time</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="scheduleEndHour" style="width: 80px;">
                                    {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                                </select>
                                <span class="align-self-center">:</span>
                                <select class="form-select" id="scheduleEndMinute" style="width: 80px;">
                                    <option value="0">00</option>
                                    <option value="5">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="end" data-delta="-15" title="Subtract 15 minutes">-15m</button>
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="end" data-delta="15" title="Add 15 minutes">+15m</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Duration Buttons -->
                    <div class="mb-3">
                        <label class="form-label">Quick Duration</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="15">15 min</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="30">30 min</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="60">1 hour</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="120">2 hours</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="180">3 hours</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="240">4 hours</button>
                        </div>
                    </div>

                    <!-- Duration Display -->
                    <div class="alert alert-info py-2 mb-3" id="durationDisplay">
                        <i class="bi bi-clock me-2"></i>
                        <span id="durationText">Duration: --</span>
                    </div>

                    <hr>

                    <!-- Source Type Tabs -->
                    <ul class="nav nav-tabs" id="sourceTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="media-tab" data-bs-toggle="tab" data-bs-target="#mediaPane" type="button">
                                <i class="bi bi-music-note me-1"></i>Media
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="playlist-tab" data-bs-toggle="tab" data-bs-target="#playlistPane" type="button">
                                <i class="bi bi-list-ul me-1"></i>Playlist
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="smartblock-tab" data-bs-toggle="tab" data-bs-target="#smartblockPane" type="button">
                                <i class="bi bi-magic me-1"></i>Smart Block
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="clock-tab" data-bs-toggle="tab" data-bs-target="#clockPane" type="button">
                                <i class="bi bi-clock-history me-1"></i>Clock
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="webstream-tab" data-bs-toggle="tab" data-bs-target="#webstreamPane" type="button">
                                <i class="bi bi-globe me-1"></i>Webstream
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#livePane" type="button">
                                <i class="bi bi-broadcast me-1"></i>Live
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3" id="sourceTypeTabContent">
                        <!-- Media Search -->
                        <div class="tab-pane fade show active" id="mediaPane" role="tabpanel">
                            <input type="text" class="form-control mb-3" id="mediaSearchInput"
                                   placeholder="Search media by title, artist...">
                            <div id="mediaSearchResults" class="list-group" style="max-height: 300px; overflow-y: auto;">
                                <!-- Results populated by JS -->
                            </div>
                        </div>

                        <!-- Playlist Selection -->
                        <div class="tab-pane fade" id="playlistPane" role="tabpanel">
                            <select class="form-select" id="playlistSelect">
                                <option value="">Select a playlist...</option>
                            </select>
                        </div>

                        <!-- Smart Block Selection -->
                        <div class="tab-pane fade" id="smartblockPane" role="tabpanel">
                            <select class="form-select" id="smartBlockSelect">
                                <option value="">Select a smart block...</option>
                            </select>
                        </div>

                        <!-- Clock Template Selection -->
                        <div class="tab-pane fade" id="clockPane" role="tabpanel">
                            <select class="form-select mb-2" id="clockSelect">
                                <option value="">Select a clock template...</option>
                            </select>
                            <div id="clockInfo" class="small text-body-secondary d-none">
                                <i class="bi bi-info-circle me-1"></i>
                                <span id="clockInfoText"></span>
                            </div>
                        </div>

                        <!-- Webstream Selection -->
                        <div class="tab-pane fade" id="webstreamPane" role="tabpanel">
                            <select class="form-select" id="webstreamSelect">
                                <option value="">Select a webstream...</option>
                            </select>
                        </div>

                        <!-- Live Session -->
                        <div class="tab-pane fade" id="livePane" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Session Name</label>
                                <input type="text" class="form-control" id="liveSessionName" placeholder="e.g., DJ Set, Live Show">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="livePriority">
                                    <option value="0">Highest (0) - Immediate takeover</option>
                                    <option value="1">High (1) - After current track</option>
                                    <option value="2" selected>Normal (2) - Scheduled slot</option>
                                    <option value="3">Low (3) - Fallback only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Recurrence Options -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-arrow-repeat me-1"></i>Repeat</label>
                        <select class="form-select" id="recurrenceType">
                            <option value="">Does not repeat</option>
                            <option value="daily">Daily</option>
                            <option value="weekdays">Every weekday (Mon-Fri)</option>
                            <option value="weekly">Weekly on this day</option>
                            <option value="custom">Custom days...</option>
                        </select>
                    </div>

                    <!-- Custom days (shown when custom selected) -->
                    <div class="mb-3 d-none" id="customDaysContainer">
                        <label class="form-label">Repeat on</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="0" id="day-sun">
                                <label class="form-check-label" for="day-sun">Sun</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="day-mon">
                                <label class="form-check-label" for="day-mon">Mon</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="2" id="day-tue">
                                <label class="form-check-label" for="day-tue">Tue</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="3" id="day-wed">
                                <label class="form-check-label" for="day-wed">Wed</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="4" id="day-thu">
                                <label class="form-check-label" for="day-thu">Thu</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="5" id="day-fri">
                                <label class="form-check-label" for="day-fri">Fri</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="6" id="day-sat">
                                <label class="form-check-label" for="day-sat">Sat</label>
                            </div>
                        </div>
                    </div>

                    <!-- Recurrence end date (shown when any recurrence selected) -->
                    <div class="mb-3 d-none" id="recurrenceEndContainer">
                        <label class="form-label">End repeat</label>
                        <div class="d-flex gap-2 align-items-center">
                            <select class="form-select" id="recurrenceEndType" style="width: auto;">
                                <option value="never">Never</option>
                                <option value="date">On date</option>
                            </select>
                            <input type="date" class="form-control d-none" id="recurrenceEndDate" style="width: auto;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddSchedule">
                    <i class="bi bi-calendar-plus me-1"></i>Add to Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Entry Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Schedule Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEntryId">
                <input type="hidden" id="editIsRecurring" value="false">

                <!-- Recurring event notice -->
                <div class="alert alert-warning d-none" id="editRecurringNotice">
                    <i class="bi bi-arrow-repeat me-2"></i>
                    <strong>This is a recurring event.</strong>
                    <div class="mt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="editMode" id="editModeSingle" value="single">
                            <label class="form-check-label" for="editModeSingle">Edit only this occurrence</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="editMode" id="editModeAll" value="all" checked>
                            <label class="form-check-label" for="editModeAll">Edit all occurrences</label>
                        </div>
                    </div>
                </div>

                <!-- Current source info -->
                <div class="mb-3 p-3 bg-body-secondary rounded">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge" id="editEntryTypeBadge">-</span>
                        <span id="editEntryName" class="fw-medium">-</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" id="editChangeSourceBtn" title="Change source">
                            <i class="bi bi-pencil me-1"></i>Change
                        </button>
                    </div>
                </div>

                <!-- Source selection (hidden by default) -->
                <div class="d-none" id="editSourceSelection">
                    <div class="mb-3">
                        <label class="form-label">Source Type</label>
                        <select class="form-select" id="editSourceType">
                            <option value="media">Media File</option>
                            <option value="playlist">Playlist</option>
                            <option value="smart_block">Smart Block</option>
                            <option value="clock_template">Clock Template</option>
                            <option value="webstream">Webstream</option>
                            <option value="live">Live Session</option>
                        </select>
                    </div>
                    <!-- Media search for edit modal -->
                    <div class="mb-3 d-none" id="editMediaSearchContainer">
                        <label class="form-label">Search Media</label>
                        <input type="text" class="form-control mb-2" id="editMediaSearchInput"
                               placeholder="Search by title, artist...">
                        <div id="editMediaSearchResults" class="list-group" style="max-height: 200px; overflow-y: auto;">
                            <div class="list-group-item text-body-secondary">Type to search media...</div>
                        </div>
                    </div>
                    <div class="mb-3 d-none" id="editSourceSelectContainer">
                        <label class="form-label">Select Source</label>
                        <select class="form-select" id="editSourceSelect">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>

                <hr>

                <!-- Date Selection -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="editStartDate" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="editEndDate" required>
                    </div>
                </div>

                <!-- Time Selection -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Start Time</label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="editStartHour" style="width: 80px;">
                                {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                            </select>
                            <span class="align-self-center">:</span>
                            <select class="form-select" id="editStartMinute" style="width: 80px;">
                                <option value="0">00</option>
                                <option value="5">05</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="35">35</option>
                                <option value="40">40</option>
                                <option value="45">45</option>
                                <option value="50">50</option>
                                <option value="55">55</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Time</label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="editEndHour" style="width: 80px;">
                                {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                            </select>
                            <span class="align-self-center">:</span>
                            <select class="form-select" id="editEndMinute" style="width: 80px;">
                                <option value="0">00</option>
                                <option value="5">05</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="35">35</option>
                                <option value="40">40</option>
                                <option value="45">45</option>
                                <option value="50">50</option>
                                <option value="55">55</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Duration Display -->
                <div class="alert alert-info py-2 mb-3" id="editDurationDisplay">
                    <i class="bi bi-clock me-2"></i>
                    <span id="editDurationText">Duration: --</span>
                </div>

                <hr>

                <!-- Recurrence Options (shown for "all occurrences" mode) -->
                <div id="editRecurrenceSection">
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-arrow-repeat me-1"></i>Repeat</label>
                        <select class="form-select" id="editRecurrenceType">
                            <option value="">Does not repeat</option>
                            <option value="daily">Daily</option>
                            <option value="weekdays">Every weekday (Mon-Fri)</option>
                            <option value="weekly">Weekly on this day</option>
                            <option value="custom">Custom days...</option>
                        </select>
                    </div>

                    <!-- Custom days -->
                    <div class="mb-3 d-none" id="editCustomDaysContainer">
                        <label class="form-label">Repeat on</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="0" id="edit-day-sun">
                                <label class="form-check-label" for="edit-day-sun">Sun</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="edit-day-mon">
                                <label class="form-check-label" for="edit-day-mon">Mon</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="2" id="edit-day-tue">
                                <label class="form-check-label" for="edit-day-tue">Tue</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="3" id="edit-day-wed">
                                <label class="form-check-label" for="edit-day-wed">Wed</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="4" id="edit-day-thu">
                                <label class="form-check-label" for="edit-day-thu">Thu</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="5" id="edit-day-fri">
                                <label class="form-check-label" for="edit-day-fri">Fri</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="6" id="edit-day-sat">
                                <label class="form-check-label" for="edit-day-sat">Sat</label>
                            </div>
                        </div>
                    </div>

                    <!-- Recurrence end date -->
                    <div class="mb-3 d-none" id="editRecurrenceEndContainer">
                        <label class="form-label">End repeat</label>
                        <div class="d-flex gap-2 align-items-center">
                            <select class="form-select" id="editRecurrenceEndType" style="width: auto;">
                                <option value="never">Never</option>
                                <option value="date">On date</option>
                            </select>
                            <input type="date" class="form-control d-none" id="editRecurrenceEndDate" style="width: auto;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-danger" id="editDeleteBtn" title="Delete this entry">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmEditSchedule">
                        <i class="bi bi-check-lg me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<!-- FullCalendar JS -->
<script src="https://unpkg.com/fullcalendar@6.1.15/index.global.min.js"
        onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js';"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const mountFilter = document.getElementById('mountFilter');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const addScheduleModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    const editScheduleModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));

    // Context menu elements
    const calendarContextMenu = document.getElementById('calendarContextMenu');
    const eventContextMenu = document.getElementById('eventContextMenu');

    let selectedEvent = null;
    let selectedTimeRange = null;
    let contextMenuTarget = null;

    // Hide context menus on click outside
    document.addEventListener('click', hideAllContextMenus);
    document.addEventListener('contextmenu', (e) => {
        // Only hide if clicking outside menus
        if (!e.target.closest('.context-menu')) {
            hideAllContextMenus();
        }
    });

    function hideAllContextMenus() {
        calendarContextMenu.classList.remove('show');
        eventContextMenu.classList.remove('show');
    }

    function showContextMenu(menu, x, y) {
        hideAllContextMenus();

        // Show menu first so we can measure it
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        menu.classList.add('show');

        // Now adjust position if needed to stay in viewport
        const rect = menu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            menu.style.left = Math.max(0, x - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            menu.style.top = Math.max(0, y - rect.height) + 'px';
        }
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        slotDuration: '00:15:00',
        snapDuration: '00:05:00',
        allDaySlot: false,
        nowIndicator: true,
        navLinks: true, // Enable drill-down: month->week->day
        navLinkDayClick: 'timeGridDay', // Click day number goes to day view
        navLinkWeekClick: 'timeGridWeek', // Click week number goes to week view
        editable: {{if roleAtLeast .User "manager"}}true{{else}}false{{end}},
        eventResizableFromStart: true,
        selectable: {{if roleAtLeast .User "manager"}}true{{else}}false{{end}},
        selectMirror: true,
        unselectAuto: false,
        longPressDelay: 500,

        // Custom event class names based on source type
        eventClassNames: function(arg) {
            const type = arg.event.extendedProps.source_type;
            return ['event-' + (type || 'media')];
        },

        events: function(info, successCallback, failureCallback) {
            const mountId = mountFilter.value;
            let url = `/dashboard/schedule/events?start=${info.startStr}&end=${info.endStr}`;
            if (mountId) {
                url += `&mount_id=${mountId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => successCallback(data))
                .catch(error => failureCallback(error));
        },

        // Left click on event - open edit modal
        eventClick: function(info) {
            selectedEvent = info.event;
            openEditModal(info.event);
        },

        // Right click on event - show context menu
        eventDidMount: function(info) {
            info.el.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                selectedEvent = info.event;
                contextMenuTarget = 'event';
                showContextMenu(eventContextMenu, e.pageX, e.pageY);
            });
        },

        eventDrop: function(info) {
            updateEvent(info.event);
        },

        eventResize: function(info) {
            updateEvent(info.event);
        },

        // Time selection (drag only) - store the range and show context menu
        select: function(info) {
            // Only trigger if actual drag (selection > 5 minutes)
            const duration = info.end - info.start;
            if (duration <= 5 * 60 * 1000) {
                // Too short - likely a click, not a drag. Ignore.
                calendar.unselect();
                return;
            }

            selectedTimeRange = { start: info.start, end: info.end };

            // Show context menu at mouse position after selection
            setTimeout(() => {
                const evt = info.jsEvent;
                if (evt) {
                    contextMenuTarget = 'calendar';
                    showContextMenu(calendarContextMenu, evt.pageX, evt.pageY);
                }
            }, 50);
        },

        unselect: function() {
            // Keep the selection for context menu usage
        }
    });

    // Add right-click on calendar background (empty time slots)
    calendarEl.addEventListener('contextmenu', function(e) {
        const fcEvent = e.target.closest('.fc-event');
        if (fcEvent) return; // Event right-click handled above

        // Show context menu on any right-click within calendar
        e.preventDefault();
        e.stopPropagation();
        contextMenuTarget = 'calendar';
        showContextMenu(calendarContextMenu, e.pageX, e.pageY);
    });

    calendar.render();
    window.calendar = calendar;

    // Power features: click time axis for daily recurring, click date header for all-day
    calendarEl.addEventListener('click', function(e) {
        // Check if clicking on time axis label (left side in week/day view)
        const timeLabel = e.target.closest('.fc-timegrid-slot-label');
        if (timeLabel) {
            const timeText = timeLabel.getAttribute('data-time');
            if (timeText) {
                // Parse time like "09:00:00"
                const [hours, minutes] = timeText.split(':').map(Number);
                const start = new Date();
                start.setHours(hours, minutes, 0, 0);
                const end = new Date(start.getTime() + 60 * 60000); // 1 hour default

                selectedTimeRange = { start, end };
                // Pre-set daily recurrence
                openAddScheduleModal(start, end, 'media', 'daily');
                return;
            }
        }

        // Check if clicking on day header (top in week view)
        const dayHeader = e.target.closest('.fc-col-header-cell');
        if (dayHeader) {
            const dateAttr = dayHeader.getAttribute('data-date');
            if (dateAttr) {
                const date = new Date(dateAttr);
                // All day = midnight to midnight
                const start = new Date(date);
                start.setHours(0, 0, 0, 0);
                const end = new Date(date);
                end.setHours(23, 59, 0, 0);

                selectedTimeRange = { start, end };
                openAddScheduleModal(start, end, 'media', '');
                return;
            }
        }

        // Check if clicking on month day number
        const dayNumber = e.target.closest('.fc-daygrid-day-number');
        if (dayNumber) {
            const dayCell = dayNumber.closest('.fc-daygrid-day');
            if (dayCell) {
                const dateAttr = dayCell.getAttribute('data-date');
                if (dateAttr) {
                    const date = new Date(dateAttr);
                    const start = new Date(date);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(date);
                    end.setHours(23, 59, 0, 0);

                    selectedTimeRange = { start, end };
                    openAddScheduleModal(start, end, 'media', '');
                    return;
                }
            }
        }
    });

    // Context menu action handlers
    document.querySelectorAll('.context-menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const action = this.dataset.action;
            hideAllContextMenus();
            handleContextAction(action);
        });
    });

    function handleContextAction(action) {
        switch(action) {
            // Calendar context actions
            case 'add-media':
            case 'add-playlist':
            case 'add-smartblock':
            case 'add-clock':
            case 'add-webstream':
            case 'add-live':
                if (selectedTimeRange) {
                    openAddScheduleModal(selectedTimeRange.start, selectedTimeRange.end, action.replace('add-', ''));
                } else {
                    // Use current time if no selection
                    const now = new Date();
                    const end = new Date(now.getTime() + 60 * 60000);
                    openAddScheduleModal(now, end, action.replace('add-', ''));
                }
                break;

            // Event context actions
            case 'event-details':
                if (selectedEvent) showEventDetails(selectedEvent);
                break;
            case 'event-edit':
                if (selectedEvent) openEditModal(selectedEvent);
                break;
            case 'event-duplicate':
                if (selectedEvent) duplicateEvent(selectedEvent);
                break;
            case 'event-move':
                grimnirUtils.showToast('Drag the event to move it', 'info');
                break;
            case 'event-delete':
                if (selectedEvent) deleteEvent(selectedEvent);
                break;
        }
    }

    function showEventDetails(event) {
        const props = event.extendedProps;

        document.getElementById('eventModalTitle').textContent = event.title || 'Scheduled Item';

        let typeColor = {
            'media': 'primary',
            'playlist': 'success',
            'smart_block': 'info',
            'clock_template': 'purple',
            'live': 'danger',
            'webstream': 'warning'
        }[props.source_type] || 'secondary';

        let body = `
            <dl class="row mb-0">
                <dt class="col-4">Type</dt>
                <dd class="col-8"><span class="badge bg-${typeColor}">${props.source_type}</span></dd>

                <dt class="col-4">Start</dt>
                <dd class="col-8">${event.start.toLocaleString()}</dd>

                <dt class="col-4">End</dt>
                <dd class="col-8">${event.end.toLocaleString()}</dd>

                <dt class="col-4">Duration</dt>
                <dd class="col-8">${formatDuration((event.end - event.start) / 1000)}</dd>
        `;

        if (props.metadata) {
            if (props.metadata.artist) {
                body += `<dt class="col-4">Artist</dt><dd class="col-8">${props.metadata.artist}</dd>`;
            }
            if (props.metadata.album) {
                body += `<dt class="col-4">Album</dt><dd class="col-8">${props.metadata.album}</dd>`;
            }
        }

        body += '</dl>';
        document.getElementById('eventModalBody').innerHTML = body;
        eventModal.show();
    }

    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}h ${m}m`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    async function openAddScheduleModal(start, end, sourceType = 'media', recurrence = '') {
        const startDate = new Date(start);
        const endDate = new Date(end);

        // Set date inputs
        document.getElementById('scheduleStartDate').value = formatDateOnly(startDate);
        document.getElementById('scheduleEndDate').value = formatDateOnly(endDate);

        // Set time inputs - snap to nearest 5 minutes
        const startMinute = Math.round(startDate.getMinutes() / 5) * 5;
        const endMinute = Math.round(endDate.getMinutes() / 5) * 5;

        document.getElementById('scheduleStartHour').value = startDate.getHours();
        document.getElementById('scheduleStartMinute').value = startMinute >= 60 ? 55 : startMinute;
        document.getElementById('scheduleEndHour').value = endDate.getHours();
        document.getElementById('scheduleEndMinute').value = endMinute >= 60 ? 55 : endMinute;

        // Update duration display
        updateDurationDisplay();

        // Select the appropriate tab
        const tabMap = {
            'media': 'media-tab',
            'playlist': 'playlist-tab',
            'smartblock': 'smartblock-tab',
            'clock': 'clock-tab',
            'webstream': 'webstream-tab',
            'live': 'live-tab'
        };
        const tabId = tabMap[sourceType] || 'media-tab';
        document.getElementById(tabId)?.click();

        // Set recurrence if provided
        const recurrenceSelect = document.getElementById('recurrenceType');
        if (recurrenceSelect) {
            recurrenceSelect.value = recurrence || '';
            // Trigger change to show/hide custom days container
            recurrenceSelect.dispatchEvent(new Event('change'));
        }

        // Load data for dropdowns and media (await all to complete)
        await Promise.all([
            loadPlaylists(),
            loadSmartBlocks(),
            loadClockTemplates(),
            loadWebstreams(),
            loadInitialMedia()
        ]);

        addScheduleModal.show();
    }

    function formatDateOnly(date) {
        const d = new Date(date);
        const pad = n => n.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function getScheduleStartDateTime() {
        const date = document.getElementById('scheduleStartDate').value;
        const hour = parseInt(document.getElementById('scheduleStartHour').value);
        const minute = parseInt(document.getElementById('scheduleStartMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function getScheduleEndDateTime() {
        const date = document.getElementById('scheduleEndDate').value;
        const hour = parseInt(document.getElementById('scheduleEndHour').value);
        const minute = parseInt(document.getElementById('scheduleEndMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function setScheduleEndDateTime(dateTime) {
        document.getElementById('scheduleEndDate').value = formatDateOnly(dateTime);
        document.getElementById('scheduleEndHour').value = dateTime.getHours();
        // Snap to nearest 5 minutes
        const minute = Math.round(dateTime.getMinutes() / 5) * 5;
        document.getElementById('scheduleEndMinute').value = minute >= 60 ? 55 : minute;
    }

    function updateDurationDisplay() {
        const start = getScheduleStartDateTime();
        const end = getScheduleEndDateTime();
        const durationMs = end - start;

        if (durationMs <= 0) {
            document.getElementById('durationText').textContent = 'Invalid: End time must be after start time';
            document.getElementById('durationDisplay').classList.remove('alert-info');
            document.getElementById('durationDisplay').classList.add('alert-danger');
            return;
        }

        document.getElementById('durationDisplay').classList.remove('alert-danger');
        document.getElementById('durationDisplay').classList.add('alert-info');

        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));

        let text = 'Duration: ';
        if (hours > 0) text += `${hours}h `;
        if (minutes > 0 || hours === 0) text += `${minutes}m`;

        document.getElementById('durationText').textContent = text.trim();
    }

    // Time adjustment buttons
    document.querySelectorAll('.time-adjust').forEach(btn => {
        btn.addEventListener('click', function() {
            const target = this.dataset.target;
            const delta = parseInt(this.dataset.delta);

            if (target === 'start') {
                const current = getScheduleStartDateTime();
                current.setMinutes(current.getMinutes() + delta);
                document.getElementById('scheduleStartDate').value = formatDateOnly(current);
                document.getElementById('scheduleStartHour').value = current.getHours();
                const minute = Math.round(current.getMinutes() / 5) * 5;
                document.getElementById('scheduleStartMinute').value = minute >= 60 ? 55 : minute;
            } else {
                const current = getScheduleEndDateTime();
                current.setMinutes(current.getMinutes() + delta);
                setScheduleEndDateTime(current);
            }
            updateDurationDisplay();
        });
    });

    // Duration quick buttons
    document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const minutes = parseInt(this.dataset.minutes);
            const start = getScheduleStartDateTime();
            const end = new Date(start.getTime() + minutes * 60 * 1000);
            setScheduleEndDateTime(end);
            updateDurationDisplay();
        });
    });

    // Update duration on any time change
    ['scheduleStartDate', 'scheduleStartHour', 'scheduleStartMinute',
     'scheduleEndDate', 'scheduleEndHour', 'scheduleEndMinute'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateDurationDisplay);
    });

    // Load dropdown data
    async function loadPlaylists() {
        try {
            const response = await fetch('/dashboard/schedule/playlists.json');
            if (!response.ok) {
                console.error('Failed to load playlists:', response.status);
                return;
            }
            const data = await response.json();
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Select a playlist...</option>';
            const playlists = data.playlists || [];
            console.log('Loaded playlists:', playlists.length);
            playlists.forEach(p => {
                select.innerHTML += `<option value="${p.ID}">${p.Name}</option>`;
            });
        } catch (e) { console.error('Failed to load playlists:', e); }
    }

    async function loadSmartBlocks() {
        try {
            const response = await fetch('/dashboard/schedule/smart-blocks.json');
            if (!response.ok) {
                console.error('Failed to load smart blocks:', response.status);
                return;
            }
            const data = await response.json();
            const select = document.getElementById('smartBlockSelect');
            select.innerHTML = '<option value="">Select a smart block...</option>';
            const smartBlocks = data.smart_blocks || [];
            console.log('Loaded smart blocks:', smartBlocks.length);
            smartBlocks.forEach(sb => {
                select.innerHTML += `<option value="${sb.ID}">${sb.Name}</option>`;
            });
        } catch (e) { console.error('Failed to load smart blocks:', e); }
    }

    async function loadWebstreams() {
        try {
            const response = await fetch('/dashboard/schedule/webstreams.json');
            const data = await response.json();
            const select = document.getElementById('webstreamSelect');
            select.innerHTML = '<option value="">Select a webstream...</option>';
            (data.webstreams || []).forEach(ws => {
                select.innerHTML += `<option value="${ws.ID}">${ws.Name}</option>`;
            });
        } catch (e) { console.error('Failed to load webstreams:', e); }
    }

    async function loadClockTemplates() {
        try {
            const response = await fetch('/dashboard/schedule/clocks.json');
            const data = await response.json();
            const select = document.getElementById('clockSelect');
            const clockInfo = document.getElementById('clockInfo');
            const clockInfoText = document.getElementById('clockInfoText');

            select.innerHTML = '<option value="">Select a clock template...</option>';
            const clocks = data.clocks || [];
            clocks.forEach(clock => {
                const slotCount = clock.Slots?.length || 0;
                select.innerHTML += `<option value="${clock.ID}" data-slots="${slotCount}">${clock.Name} (${slotCount} slots)</option>`;
            });

            // Show clock info on selection
            select.addEventListener('change', function() {
                const option = this.selectedOptions[0];
                if (option && option.value) {
                    const slots = option.dataset.slots || 0;
                    clockInfoText.textContent = `This clock has ${slots} slot(s). Duration will expand to fill the scheduled time.`;
                    clockInfo.classList.remove('d-none');

                    // Auto-set end time to 1 hour after start
                    const start = getScheduleStartDateTime();
                    const end = new Date(start.getTime() + 60 * 60 * 1000); // 1 hour
                    setScheduleEndDateTime(end);
                    updateDurationDisplay();
                } else {
                    clockInfo.classList.add('d-none');
                }
            });
        } catch (e) { console.error('Failed to load clock templates:', e); }
    }

    // Load initial media items (without search query)
    async function loadInitialMedia() {
        try {
            const response = await fetch('/dashboard/schedule/media.json');
            const data = await response.json();
            displayMediaResults('mediaSearchResults', data.items || []);
        } catch (e) {
            console.error('Failed to load media:', e);
        }
    }

    // Shared function to display media results
    function displayMediaResults(containerId, items) {
        const results = document.getElementById(containerId);
        results.innerHTML = '';

        if (items.length === 0) {
            results.innerHTML = '<div class="list-group-item text-body-secondary">No media found. Try uploading some tracks first.</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('a');
            div.href = '#';
            div.className = 'list-group-item list-group-item-action';
            div.dataset.mediaId = item.id;
            div.dataset.duration = item.duration;
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.title}</strong><br>
                        <small class="text-body-secondary">${item.artist || 'Unknown'}  ${formatDuration(item.duration)}</small>
                    </div>
                    <i class="bi bi-plus-circle text-primary"></i>
                </div>
            `;
            div.addEventListener('click', (e) => {
                e.preventDefault();
                // Deselect others
                results.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
            });
            results.appendChild(div);
        });
    }

    // Media search
    let mediaSearchTimeout;
    document.getElementById('mediaSearchInput')?.addEventListener('input', function(e) {
        clearTimeout(mediaSearchTimeout);
        const query = e.target.value;

        if (query.length === 0) {
            // If search is cleared, reload initial media
            loadInitialMedia();
            return;
        }

        if (query.length < 2) return;

        mediaSearchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/dashboard/schedule/media.json?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                displayMediaResults('mediaSearchResults', data.items || []);
            } catch (e) { console.error('Media search failed:', e); }
        }, 300);
    });

    // Confirm add schedule
    document.getElementById('confirmAddSchedule')?.addEventListener('click', async function() {
        const startDateTime = getScheduleStartDateTime();
        const endDateTime = getScheduleEndDateTime();
        const activeTab = document.querySelector('#sourceTypeTabs .nav-link.active')?.id;

        // Validate times
        if (endDateTime <= startDateTime) {
            grimnirUtils.showToast('End time must be after start time', 'error');
            return;
        }

        let sourceType, sourceId, metadata = {};

        switch(activeTab) {
            case 'media-tab':
                const selectedMedia = document.querySelector('#mediaSearchResults .list-group-item.active');
                if (!selectedMedia) {
                    grimnirUtils.showToast('Please select a media item', 'warning');
                    return;
                }
                sourceType = 'media';
                sourceId = selectedMedia.dataset.mediaId;
                break;

            case 'playlist-tab':
                sourceId = document.getElementById('playlistSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a playlist', 'warning');
                    return;
                }
                sourceType = 'playlist';
                break;

            case 'smartblock-tab':
                sourceId = document.getElementById('smartBlockSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a smart block', 'warning');
                    return;
                }
                sourceType = 'smart_block';
                break;

            case 'clock-tab':
                sourceId = document.getElementById('clockSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a clock template', 'warning');
                    return;
                }
                sourceType = 'clock_template';
                break;

            case 'webstream-tab':
                sourceId = document.getElementById('webstreamSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a webstream', 'warning');
                    return;
                }
                sourceType = 'webstream';
                break;

            case 'live-tab':
                sourceType = 'live';
                sourceId = null;
                metadata = {
                    session_name: document.getElementById('liveSessionName').value || 'Live Session',
                    priority: parseInt(document.getElementById('livePriority').value)
                };
                break;
        }

        // Get recurrence settings
        const recurrenceType = document.getElementById('recurrenceType').value;
        let recurrenceDays = [];
        if (recurrenceType === 'custom') {
            document.querySelectorAll('#customDaysContainer input:checked').forEach(cb => {
                recurrenceDays.push(parseInt(cb.value));
            });
        }

        let recurrenceEndDate = null;
        if (recurrenceType && document.getElementById('recurrenceEndType').value === 'date') {
            recurrenceEndDate = document.getElementById('recurrenceEndDate').value;
        }

        try {
            const response = await fetch('/dashboard/schedule/entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    starts_at: startDateTime.toISOString(),
                    ends_at: endDateTime.toISOString(),
                    source_type: sourceType,
                    source_id: sourceId,
                    metadata: metadata,
                    recurrence_type: recurrenceType,
                    recurrence_days: recurrenceDays,
                    recurrence_end_date: recurrenceEndDate
                })
            });

            if (response.ok) {
                addScheduleModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast('Schedule entry added', 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to add entry', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to add entry', 'error');
        }
    });

    // Recurrence UI handlers for Add modal
    document.getElementById('recurrenceType')?.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('customDaysContainer').classList.toggle('d-none', type !== 'custom');
        document.getElementById('recurrenceEndContainer').classList.toggle('d-none', !type);
    });

    document.getElementById('recurrenceEndType')?.addEventListener('change', function() {
        document.getElementById('recurrenceEndDate').classList.toggle('d-none', this.value !== 'date');
    });

    // Recurrence UI handlers for Edit modal
    document.getElementById('editRecurrenceType')?.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('editCustomDaysContainer').classList.toggle('d-none', type !== 'custom');
        document.getElementById('editRecurrenceEndContainer').classList.toggle('d-none', !type);
    });

    document.getElementById('editRecurrenceEndType')?.addEventListener('change', function() {
        document.getElementById('editRecurrenceEndDate').classList.toggle('d-none', this.value !== 'date');
    });

    // Edit mode handlers
    document.querySelectorAll('input[name="editMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isSingle = this.value === 'single';
            document.getElementById('editRecurrenceSection').classList.toggle('d-none', isSingle);
        });
    });

    // Change source button
    document.getElementById('editChangeSourceBtn')?.addEventListener('click', function() {
        const container = document.getElementById('editSourceSelection');
        container.classList.toggle('d-none');
        if (!container.classList.contains('d-none')) {
            loadEditSourceOptions();
        }
    });

    // Edit source type change
    document.getElementById('editSourceType')?.addEventListener('change', function() {
        loadEditSourceOptions();
    });

    // Edit modal media search
    let editMediaSearchTimeout;
    document.getElementById('editMediaSearchInput')?.addEventListener('input', function(e) {
        clearTimeout(editMediaSearchTimeout);
        const query = e.target.value;
        const results = document.getElementById('editMediaSearchResults');

        if (query.length < 2) {
            results.innerHTML = '<div class="list-group-item text-body-secondary">Type at least 2 characters to search...</div>';
            return;
        }

        results.innerHTML = '<div class="list-group-item text-body-secondary">Searching...</div>';

        editMediaSearchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/dashboard/schedule/media.json?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                results.innerHTML = '';

                if (!data.items || data.items.length === 0) {
                    results.innerHTML = '<div class="list-group-item text-body-secondary">No results found</div>';
                    return;
                }

                data.items.forEach(item => {
                    const div = document.createElement('a');
                    div.href = '#';
                    div.className = 'list-group-item list-group-item-action';
                    div.dataset.mediaId = item.id;
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.title}</strong><br>
                                <small class="text-body-secondary">${item.artist || 'Unknown'}  ${formatDuration(item.duration)}</small>
                            </div>
                            <i class="bi bi-plus-circle text-primary"></i>
                        </div>
                    `;
                    div.addEventListener('click', (e) => {
                        e.preventDefault();
                        // Deselect others
                        results.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                    });
                    results.appendChild(div);
                });
            } catch (e) {
                results.innerHTML = '<div class="list-group-item text-danger">Search failed</div>';
            }
        }, 300);
    });

    async function loadEditSourceOptions() {
        const sourceType = document.getElementById('editSourceType').value;
        const select = document.getElementById('editSourceSelect');
        const mediaSearchContainer = document.getElementById('editMediaSearchContainer');
        const selectContainer = document.getElementById('editSourceSelectContainer');

        // Reset visibility
        mediaSearchContainer.classList.add('d-none');
        selectContainer.classList.add('d-none');

        select.innerHTML = '<option value="">Loading...</option>';

        let url, dataKey, nameKey;
        switch (sourceType) {
            case 'media':
                // Show media search instead of dropdown
                mediaSearchContainer.classList.remove('d-none');
                document.getElementById('editMediaSearchInput').value = '';
                document.getElementById('editMediaSearchResults').innerHTML =
                    '<div class="list-group-item text-body-secondary">Type to search media...</div>';
                return;
            case 'playlist':
                url = '/dashboard/schedule/playlists.json';
                dataKey = 'playlists';
                nameKey = 'Name';
                break;
            case 'smart_block':
                url = '/dashboard/schedule/smart-blocks.json';
                dataKey = 'smart_blocks';
                nameKey = 'Name';
                break;
            case 'clock_template':
                url = '/dashboard/schedule/clocks.json';
                dataKey = 'clocks';
                nameKey = 'Name';
                break;
            case 'webstream':
                url = '/dashboard/schedule/webstreams.json';
                dataKey = 'webstreams';
                nameKey = 'Name';
                break;
            case 'live':
                // Live doesn't need source selection
                return;
        }

        selectContainer.classList.remove('d-none');

        try {
            const response = await fetch(url);
            const data = await response.json();
            select.innerHTML = '<option value="">Select...</option>';
            (data[dataKey] || []).forEach(item => {
                select.innerHTML += `<option value="${item.ID}">${item[nameKey]}</option>`;
            });
        } catch (e) {
            select.innerHTML = '<option value="">Error loading options</option>';
        }
    }

    function updateEvent(event) {
        fetch(`/dashboard/schedule/entries/${event.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                starts_at: event.start.toISOString(),
                ends_at: event.end.toISOString()
            })
        }).then(response => {
            if (response.ok) {
                grimnirUtils.showToast('Schedule updated', 'success');
            } else {
                calendar.refetchEvents();
                grimnirUtils.showToast('Failed to update', 'error');
            }
        });
    }

    function deleteEvent(event) {
        if (!confirm('Delete this schedule entry?')) return;

        fetch(`/dashboard/schedule/entries/${event.id}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                event.remove();
                eventModal.hide();
                grimnirUtils.showToast('Entry deleted', 'success');
            }
        });
    }

    async function duplicateEvent(event) {
        try {
            const response = await fetch(`/dashboard/schedule/entries/${event.id}/duplicate`, {
                method: 'POST'
            });
            if (response.ok) {
                calendar.refetchEvents();
                grimnirUtils.showToast('Event duplicated', 'success');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to duplicate', 'error');
        }
    }

    // Edit modal functions
    function openEditModal(event) {
        const props = event.extendedProps;
        const startDate = event.start;
        const endDate = event.end;

        // Store event ID
        document.getElementById('editEntryId').value = event.id;

        // Reset source selection
        document.getElementById('editSourceSelection').classList.add('d-none');

        // Set type badge and name
        const typeColors = {
            'media': 'bg-primary',
            'playlist': 'bg-success',
            'smart_block': 'bg-info',
            'clock_template': 'bg-purple',
            'live': 'bg-danger',
            'webstream': 'bg-warning text-dark'
        };
        const badge = document.getElementById('editEntryTypeBadge');
        badge.className = 'badge ' + (typeColors[props.source_type] || 'bg-secondary');
        badge.textContent = props.source_label || props.source_type;

        document.getElementById('editEntryName').textContent = props.source_name || event.title;

        // Store source type/id for potential changes
        document.getElementById('editSourceType').value = props.source_type;

        // Check if recurring
        const isRecurring = props.recurrence && props.recurrence.type;
        const isInstance = props.is_instance;
        document.getElementById('editIsRecurring').value = isRecurring ? 'true' : 'false';

        // Show/hide recurring notice
        const recurringNotice = document.getElementById('editRecurringNotice');
        if (isRecurring || isInstance) {
            recurringNotice.classList.remove('d-none');
            document.getElementById('editModeAll').checked = true;
            document.getElementById('editRecurrenceSection').classList.remove('d-none');
        } else {
            recurringNotice.classList.add('d-none');
        }

        // Set recurrence fields
        if (props.recurrence) {
            document.getElementById('editRecurrenceType').value = props.recurrence.type || '';

            // Show/hide containers based on type
            document.getElementById('editCustomDaysContainer').classList.toggle('d-none', props.recurrence.type !== 'custom');
            document.getElementById('editRecurrenceEndContainer').classList.toggle('d-none', !props.recurrence.type);

            // Set custom days
            if (props.recurrence.days) {
                document.querySelectorAll('#editCustomDaysContainer input').forEach(cb => {
                    cb.checked = props.recurrence.days.includes(parseInt(cb.value));
                });
            }

            // Set end date
            if (props.recurrence.end_date) {
                document.getElementById('editRecurrenceEndType').value = 'date';
                document.getElementById('editRecurrenceEndDate').value = props.recurrence.end_date;
                document.getElementById('editRecurrenceEndDate').classList.remove('d-none');
            } else {
                document.getElementById('editRecurrenceEndType').value = 'never';
                document.getElementById('editRecurrenceEndDate').classList.add('d-none');
            }
        } else {
            document.getElementById('editRecurrenceType').value = '';
            document.getElementById('editCustomDaysContainer').classList.add('d-none');
            document.getElementById('editRecurrenceEndContainer').classList.add('d-none');
        }

        // Set date inputs
        document.getElementById('editStartDate').value = formatDateOnly(startDate);
        document.getElementById('editEndDate').value = formatDateOnly(endDate);

        // Set time inputs
        document.getElementById('editStartHour').value = startDate.getHours();
        const startMin = Math.round(startDate.getMinutes() / 5) * 5;
        document.getElementById('editStartMinute').value = startMin >= 60 ? 55 : startMin;

        document.getElementById('editEndHour').value = endDate.getHours();
        const endMin = Math.round(endDate.getMinutes() / 5) * 5;
        document.getElementById('editEndMinute').value = endMin >= 60 ? 55 : endMin;

        updateEditDurationDisplay();
        editScheduleModal.show();
    }

    function getEditStartDateTime() {
        const date = document.getElementById('editStartDate').value;
        const hour = parseInt(document.getElementById('editStartHour').value);
        const minute = parseInt(document.getElementById('editStartMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function getEditEndDateTime() {
        const date = document.getElementById('editEndDate').value;
        const hour = parseInt(document.getElementById('editEndHour').value);
        const minute = parseInt(document.getElementById('editEndMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function updateEditDurationDisplay() {
        const start = getEditStartDateTime();
        const end = getEditEndDateTime();
        const durationMs = end - start;

        if (durationMs <= 0) {
            document.getElementById('editDurationText').textContent = 'Invalid: End time must be after start time';
            document.getElementById('editDurationDisplay').classList.remove('alert-info');
            document.getElementById('editDurationDisplay').classList.add('alert-danger');
            return;
        }

        document.getElementById('editDurationDisplay').classList.remove('alert-danger');
        document.getElementById('editDurationDisplay').classList.add('alert-info');

        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));

        let text = 'Duration: ';
        if (hours > 0) text += `${hours}h `;
        if (minutes > 0 || hours === 0) text += `${minutes}m`;

        document.getElementById('editDurationText').textContent = text.trim();
    }

    // Edit modal time change listeners
    ['editStartDate', 'editStartHour', 'editStartMinute',
     'editEndDate', 'editEndHour', 'editEndMinute'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateEditDurationDisplay);
    });

    // Confirm edit
    document.getElementById('confirmEditSchedule')?.addEventListener('click', async function() {
        const entryId = document.getElementById('editEntryId').value;
        const startDateTime = getEditStartDateTime();
        const endDateTime = getEditEndDateTime();

        if (endDateTime <= startDateTime) {
            grimnirUtils.showToast('End time must be after start time', 'error');
            return;
        }

        // Build update payload
        const payload = {
            starts_at: startDateTime.toISOString(),
            ends_at: endDateTime.toISOString()
        };

        // Check if source changed
        const sourceSelection = document.getElementById('editSourceSelection');
        if (!sourceSelection.classList.contains('d-none')) {
            const newSourceType = document.getElementById('editSourceType').value;
            let newSourceId;

            if (newSourceType === 'media') {
                // Get selected media from search results
                const selectedMedia = document.querySelector('#editMediaSearchResults .list-group-item.active');
                if (selectedMedia) {
                    newSourceId = selectedMedia.dataset.mediaId;
                }
            } else if (newSourceType !== 'live') {
                newSourceId = document.getElementById('editSourceSelect').value;
            }

            if (newSourceId) {
                payload.source_type = newSourceType;
                payload.source_id = newSourceId;
            } else if (newSourceType === 'live') {
                payload.source_type = 'live';
                payload.source_id = '';
            }
        }

        // Get edit mode for recurring events
        const isRecurring = document.getElementById('editIsRecurring').value === 'true';
        if (isRecurring) {
            payload.edit_mode = document.querySelector('input[name="editMode"]:checked')?.value || 'all';
        }

        // Get recurrence settings (only if editing all occurrences)
        if (!isRecurring || payload.edit_mode === 'all') {
            const recurrenceType = document.getElementById('editRecurrenceType').value;
            payload.recurrence_type = recurrenceType;

            if (recurrenceType === 'custom') {
                const days = [];
                document.querySelectorAll('#editCustomDaysContainer input:checked').forEach(cb => {
                    days.push(parseInt(cb.value));
                });
                payload.recurrence_days = days;
            }

            if (recurrenceType && document.getElementById('editRecurrenceEndType').value === 'date') {
                payload.recurrence_end_date = document.getElementById('editRecurrenceEndDate').value;
            } else {
                payload.recurrence_end_date = '';
            }
        }

        try {
            const response = await fetch(`/dashboard/schedule/entries/${entryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                editScheduleModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast('Schedule entry updated', 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to update entry', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to update entry', 'error');
        }
    });

    // Delete from edit modal
    document.getElementById('editDeleteBtn')?.addEventListener('click', function() {
        const entryId = document.getElementById('editEntryId').value;
        if (!confirm('Delete this schedule entry?')) return;

        fetch(`/dashboard/schedule/entries/${entryId}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                editScheduleModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast('Entry deleted', 'success');
            } else {
                grimnirUtils.showToast('Failed to delete entry', 'error');
            }
        });
    });

    // Mount filter
    mountFilter.addEventListener('change', () => {
        calendar.refetchEvents();
    });

    // Delete event button in modal
    document.getElementById('deleteEventBtn')?.addEventListener('click', () => {
        if (selectedEvent) deleteEvent(selectedEvent);
    });

    // WebSocket updates
    window.grimnirWS.on('schedule_update', () => {
        calendar.refetchEvents();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // N - New entry (if time selected)
        if (e.key === 'n' && selectedTimeRange) {
            openAddScheduleModal(selectedTimeRange.start, selectedTimeRange.end);
        }

        // Delete/Backspace - Delete selected event
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedEvent) {
            deleteEvent(selectedEvent);
        }

        // Escape - Deselect and close menus
        if (e.key === 'Escape') {
            hideAllContextMenus();
            calendar.unselect();
            selectedEvent = null;
            selectedTimeRange = null;
        }
    });
});
</script>
{{end}}
