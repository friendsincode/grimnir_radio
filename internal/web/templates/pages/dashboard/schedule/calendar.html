{{define "pages/dashboard/schedule/calendar"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "head"}}
<!-- FullCalendar 6.x includes CSS in JS bundle -->
<style>
    #calendar {
        height: calc(100vh - 280px);
        min-height: 500px;
    }
    .fc-event {
        cursor: pointer;
        font-size: 0.85rem;
    }
    .fc-timegrid-slot {
        height: 2em;
    }
    /* Context Menu */
    .context-menu {
        position: fixed;
        z-index: 9999;
        min-width: 180px;
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        padding: 0.5rem 0;
        display: none;
    }
    .context-menu.show {
        display: block;
    }
    .context-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--bs-body-color);
        font-size: 0.875rem;
        transition: background 0.15s;
    }
    .context-menu-item:hover {
        background: var(--bs-tertiary-bg);
    }
    .context-menu-item i {
        width: 1.25rem;
        text-align: center;
        color: var(--bs-secondary);
    }
    .context-menu-item.danger {
        color: var(--bs-danger);
    }
    .context-menu-item.danger i {
        color: var(--bs-danger);
    }
    .context-menu-divider {
        border-top: 1px solid var(--bs-border-color);
        margin: 0.5rem 0;
    }
    /* Selection highlight */
    .fc-highlight {
        background: rgba(var(--bs-primary-rgb), 0.2) !important;
    }
    /* Source type colors - using CSS custom properties for theme support */
    :root {
        --calendar-color-media: #6366f1;
        --calendar-color-playlist: #10b981;
        --calendar-color-smartblock: #06b6d4;
        --calendar-color-live: #ef4444;
        --calendar-color-webstream: #f59e0b;
        --calendar-color-clock: #8b5cf6;
        --calendar-color-show: #ec4899;
    }
    .fc-event.event-media { background: var(--calendar-color-media) !important; border-color: var(--calendar-color-media) !important; }
    .fc-event.event-playlist { background: var(--calendar-color-playlist) !important; border-color: var(--calendar-color-playlist) !important; }
    .fc-event.event-smart_block { background: var(--calendar-color-smartblock) !important; border-color: var(--calendar-color-smartblock) !important; }
    .fc-event.event-live { background: var(--calendar-color-live) !important; border-color: var(--calendar-color-live) !important; }
    .fc-event.event-webstream { background: var(--calendar-color-webstream) !important; border-color: var(--calendar-color-webstream) !important; color: var(--bs-dark) !important; }
    .fc-event.event-clock_template { background: var(--calendar-color-clock) !important; border-color: var(--calendar-color-clock) !important; }
    /* Show events - uses show's custom color if set */
    .fc-event.event-show { border-width: 2px !important; }
    .fc-event.event-show.event-cancelled { opacity: 0.5; text-decoration: line-through; }
    .fc-event.event-show.event-exception { border-style: dashed !important; }
    .fc-event.event-orphaned {
        background: #dc3545 !important;
        border-color: #a71d2a !important;
        color: #fff !important;
        background-image: repeating-linear-gradient(
            45deg, transparent, transparent 5px, rgba(0,0,0,0.1) 5px, rgba(0,0,0,0.1) 10px
        ) !important;
    }
    .fc-event.event-overlap {
        background: var(--bs-danger) !important;
        border-color: #8b1a1a !important;
        color: #fff !important;
        box-shadow: 0 0 0 2px rgba(var(--bs-danger-rgb), 0.35);
    }
    /* Badge for purple/clock type */
    .badge.bg-purple { background-color: var(--calendar-color-clock) !important; }
    .badge.bg-pink { background-color: var(--calendar-color-show) !important; }
    /* Validation styles */
    .validation-error { border-left: 3px solid var(--bs-danger) !important; }
    .validation-warning { border-left: 3px solid var(--bs-warning) !important; }
    .validation-info { border-left: 3px solid var(--bs-info) !important; }
    .validation-result-item {
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
    }
    .validation-result-item.error { background-color: rgba(var(--bs-danger-rgb), 0.1); border-left: 3px solid var(--bs-danger); }
    .validation-result-item.warning { background-color: rgba(var(--bs-warning-rgb), 0.1); border-left: 3px solid var(--bs-warning); }
    .validation-result-item.info { background-color: rgba(var(--bs-info-rgb), 0.1); border-left: 3px solid var(--bs-info); }
    .validation-badge { font-size: 0.65rem; vertical-align: middle; }
    .validation-detail-list { margin-top: 0.5rem; margin-bottom: 0; padding-left: 1rem; }
    .irt-list .irt-item { border-bottom: 1px solid var(--bs-border-color); }
    .irt-list .irt-item:last-child { border-bottom: 0; }
    .irt-now-pill { font-size: 0.68rem; }
    .irt-upcoming-scroll {
        max-height: 140px;
        overflow-y: auto;
    }
</style>
<script>
// Apply calendar color theme
(function() {
    const colorTheme = '{{index .Data "ColorTheme"}}' || 'default';
    const themes = {
        'default': { media: '#6366f1', playlist: '#10b981', smartblock: '#06b6d4', live: '#ef4444', webstream: '#f59e0b', clock: '#8b5cf6', show: '#ec4899' },
        'ocean': { media: '#0ea5e9', playlist: '#14b8a6', smartblock: '#06b6d4', live: '#3b82f6', webstream: '#0891b2', clock: '#22d3ee', show: '#06b6d4' },
        'forest': { media: '#22c55e', playlist: '#10b981', smartblock: '#84cc16', live: '#16a34a', webstream: '#059669', clock: '#4ade80', show: '#15803d' },
        'sunset': { media: '#f97316', playlist: '#ef4444', smartblock: '#ec4899', live: '#f43f5e', webstream: '#fb923c', clock: '#e11d48', show: '#be185d' },
        'berry': { media: '#a855f7', playlist: '#8b5cf6', smartblock: '#d946ef', live: '#c026d3', webstream: '#9333ea', clock: '#e879f9', show: '#a21caf' },
        'earth': { media: '#92400e', playlist: '#f59e0b', smartblock: '#78716c', live: '#b45309', webstream: '#d97706', clock: '#a16207', show: '#854d0e' },
        'neon': { media: '#00ff88', playlist: '#ff0088', smartblock: '#00ffff', live: '#ffff00', webstream: '#ff00ff', clock: '#88ff00', show: '#ff0088' },
        'pastel': { media: '#93c5fd', playlist: '#a5b4fc', smartblock: '#c4b5fd', live: '#f9a8d4', webstream: '#fca5a5', clock: '#fed7aa', show: '#fbcfe8' }
    };
    const colors = themes[colorTheme] || themes['default'];
    const root = document.documentElement;
    root.style.setProperty('--calendar-color-media', colors.media);
    root.style.setProperty('--calendar-color-playlist', colors.playlist);
    root.style.setProperty('--calendar-color-smartblock', colors.smartblock);
    root.style.setProperty('--calendar-color-live', colors.live);
    root.style.setProperty('--calendar-color-webstream', colors.webstream);
    root.style.setProperty('--calendar-color-clock', colors.clock);
    root.style.setProperty('--calendar-color-show', colors.show);
})();
</script>
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Schedule</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Schedule</h4>
    <div class="d-flex gap-2">
        <select class="form-select form-select-sm" id="mountFilter" style="width: 200px;">
            <option value="">All Mounts</option>
            {{range .Data.Mounts}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
        <button class="btn btn-outline-secondary btn-sm" id="validateScheduleBtn" title="Validate schedule for conflicts">
            <i class="bi bi-shield-check me-1"></i>Validate
            <span class="badge bg-danger validation-badge d-none" id="validationBadge">0</span>
        </button>
        {{if roleAtLeast .User "manager"}}
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" title="Templates & History">
                <i class="bi bi-collection me-1"></i>Templates
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" id="saveTemplateBtn"><i class="bi bi-save me-2"></i>Save as Template</a></li>
                <li><a class="dropdown-item" href="#" id="loadTemplateBtn"><i class="bi bi-folder2-open me-2"></i>Load Template</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="viewHistoryBtn"><i class="bi bi-clock-history me-2"></i>Version History</a></li>
            </ul>
        </div>
        <button class="btn btn-outline-primary btn-sm"
                hx-post="/dashboard/schedule/refresh"
                hx-swap="none">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
        {{end}}
    </div>
</div>

<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-broadcast me-2"></i>Now Playing (IRT)</h6>
        <button class="btn btn-sm btn-outline-secondary" id="irtRefreshBtn"><i class="bi bi-arrow-clockwise"></i></button>
    </div>
    <div class="card-body py-2">
        <div id="irtNowPlaying" class="mb-2 text-body-secondary small">Loading current playback...</div>
        <div class="irt-upcoming-scroll">
            <div id="irtUpcomingList" class="irt-list"></div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div id="calendar"></div>
    </div>
</div>

<!-- Context Menu for Calendar -->
<div id="calendarContextMenu" class="context-menu">
    <div class="context-menu-item" data-action="add-media">
        <i class="bi bi-music-note"></i>
        <span>Add Media</span>
    </div>
    <div class="context-menu-item" data-action="add-playlist">
        <i class="bi bi-list-ul"></i>
        <span>Add Playlist</span>
    </div>
    <div class="context-menu-item" data-action="add-smartblock">
        <i class="bi bi-magic"></i>
        <span>Add Smart Block</span>
    </div>
    <div class="context-menu-item" data-action="add-clock">
        <i class="bi bi-clock-history"></i>
        <span>Add Clock Template</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="add-webstream">
        <i class="bi bi-globe"></i>
        <span>Add Webstream</span>
    </div>
    <div class="context-menu-item" data-action="add-live">
        <i class="bi bi-broadcast"></i>
        <span>Schedule Live Session</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="add-show">
        <i class="bi bi-calendar-event"></i>
        <span>Schedule Show</span>
    </div>
</div>

<!-- Context Menu for Events -->
<div id="eventContextMenu" class="context-menu">
    <div class="context-menu-item" data-action="event-details">
        <i class="bi bi-info-circle"></i>
        <span>View Details</span>
    </div>
    <div class="context-menu-item" data-action="event-edit">
        <i class="bi bi-pencil"></i>
        <span>Edit</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="event-duplicate">
        <i class="bi bi-copy"></i>
        <span>Duplicate</span>
    </div>
    <div class="context-menu-item" data-action="event-move">
        <i class="bi bi-arrows-move"></i>
        <span>Move to...</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" data-action="event-delete">
        <i class="bi bi-trash"></i>
        <span>Delete</span>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer justify-content-between">
                <div id="eventModalLinks">
                    <!-- Populated by JS with links to clock/playlist/etc -->
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    {{if roleAtLeast .User "manager"}}
                    <button type="button" class="btn btn-outline-primary" id="editEventBtn" title="Edit this event">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteEventBtn" title="Delete this event">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Schedule Entry Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Add to Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addScheduleForm">
                    <input type="hidden" id="scheduleStartTime" name="starts_at">
                    <input type="hidden" id="scheduleEndTime" name="ends_at">

                    <!-- Date Selection -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="scheduleStartDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="scheduleEndDate" required>
                        </div>
                    </div>

                    <!-- Time Selection -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Time</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="scheduleStartHour" style="width: 80px;">
                                    {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                                </select>
                                <span class="align-self-center">:</span>
                                <select class="form-select" id="scheduleStartMinute" style="width: 80px;">
                                    <option value="0">00</option>
                                    <option value="5">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="start" data-delta="-15" title="Subtract 15 minutes">-15m</button>
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="start" data-delta="15" title="Add 15 minutes">+15m</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Time</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="scheduleEndHour" style="width: 80px;">
                                    {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                                </select>
                                <span class="align-self-center">:</span>
                                <select class="form-select" id="scheduleEndMinute" style="width: 80px;">
                                    <option value="0">00</option>
                                    <option value="5">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="end" data-delta="-15" title="Subtract 15 minutes">-15m</button>
                                    <button type="button" class="btn btn-outline-secondary time-adjust" data-target="end" data-delta="15" title="Add 15 minutes">+15m</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Duration Buttons -->
                    <div class="mb-3">
                        <label class="form-label">Quick Duration</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="60">1 hour</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="120">2 hours</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="180">3 hours</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="240">4 hours</button>
                            <button type="button" class="btn btn-sm btn-outline-primary duration-btn" data-minutes="300">5 hours</button>
                        </div>
                    </div>

                    <!-- Duration Display -->
                    <div class="alert alert-info py-2 mb-3" id="durationDisplay">
                        <i class="bi bi-clock me-2"></i>
                        <span id="durationText">Duration: --</span>
                    </div>

                    <hr>

                    <!-- Source Type Tabs -->
                    <ul class="nav nav-tabs" id="sourceTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="media-tab" data-bs-toggle="tab" data-bs-target="#mediaPane" type="button">
                                <i class="bi bi-music-note me-1"></i>Media
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="playlist-tab" data-bs-toggle="tab" data-bs-target="#playlistPane" type="button">
                                <i class="bi bi-list-ul me-1"></i>Playlist
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="smartblock-tab" data-bs-toggle="tab" data-bs-target="#smartblockPane" type="button">
                                <i class="bi bi-magic me-1"></i>Smart Block
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="clock-tab" data-bs-toggle="tab" data-bs-target="#clockPane" type="button">
                                <i class="bi bi-clock-history me-1"></i>Clock
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="webstream-tab" data-bs-toggle="tab" data-bs-target="#webstreamPane" type="button">
                                <i class="bi bi-globe me-1"></i>Webstream
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#livePane" type="button">
                                <i class="bi bi-broadcast me-1"></i>Live
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="show-tab" data-bs-toggle="tab" data-bs-target="#showPane" type="button">
                                <i class="bi bi-calendar-event me-1"></i>Show
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3" id="sourceTypeTabContent">
                        <!-- Media Search -->
                        <div class="tab-pane fade show active" id="mediaPane" role="tabpanel">
                            <input type="text" class="form-control mb-2" id="mediaSearchInput"
                                   placeholder="Search media by title, artist...">
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="includeArchiveMedia">
                                <label class="form-check-label small" for="includeArchiveMedia">
                                    <i class="bi bi-globe me-1"></i>Include public archive from other stations
                                </label>
                            </div>
                            <div id="mediaSearchResults" class="list-group" style="max-height: 300px; overflow-y: auto;">
                                <!-- Results populated by JS -->
                            </div>
                        </div>

                        <!-- Playlist Selection -->
                        <div class="tab-pane fade" id="playlistPane" role="tabpanel">
                            <select class="form-select" id="playlistSelect">
                                <option value="">Select a playlist...</option>
                            </select>
                        </div>

                        <!-- Smart Block Selection -->
                        <div class="tab-pane fade" id="smartblockPane" role="tabpanel">
                            <select class="form-select" id="smartBlockSelect">
                                <option value="">Select a smart block...</option>
                            </select>
                        </div>

                        <!-- Clock Template Selection -->
                        <div class="tab-pane fade" id="clockPane" role="tabpanel">
                            <select class="form-select mb-2" id="clockSelect">
                                <option value="">Select a clock template...</option>
                            </select>
                            <div id="clockInfo" class="small text-body-secondary d-none">
                                <i class="bi bi-info-circle me-1"></i>
                                <span id="clockInfoText"></span>
                            </div>
                        </div>

                        <!-- Webstream Selection -->
                        <div class="tab-pane fade" id="webstreamPane" role="tabpanel">
                            <select class="form-select" id="webstreamSelect">
                                <option value="">Select a webstream...</option>
                            </select>
                        </div>

                        <!-- Live Session -->
                        <div class="tab-pane fade" id="livePane" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Session Name</label>
                                <input type="text" class="form-control" id="liveSessionName" placeholder="e.g., DJ Set, Live Show">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="livePriority">
                                    <option value="0">Highest (0) - Immediate takeover</option>
                                    <option value="1">High (1) - After current track</option>
                                    <option value="2" selected>Normal (2) - Scheduled slot</option>
                                    <option value="3">Low (3) - Fallback only</option>
                                </select>
                            </div>
                        </div>

                        <!-- Show (Recurring Program) -->
                        <div class="tab-pane fade" id="showPane" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Select Existing Show</label>
                                <select class="form-select" id="showSelect">
                                    <option value="">Select a show...</option>
                                </select>
                            </div>
                            <div class="text-center my-3">
                                <span class="text-body-secondary">or</span>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Create New Show</label>
                                <input type="text" class="form-control mb-2" id="newShowName" placeholder="Show name">
                                <textarea class="form-control mb-2" id="newShowDescription" rows="2" placeholder="Description (optional)"></textarea>
                                <div class="row g-2">
                                    <div class="col">
                                        <label class="form-label small">Duration (minutes)</label>
                                        <input type="number" class="form-control" id="newShowDuration" value="60" min="15" max="480">
                                    </div>
                                    <div class="col">
                                        <label class="form-label small">Color</label>
                                        <input type="color" class="form-control form-control-color" id="newShowColor" value="#ec4899">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info py-2 small">
                                <i class="bi bi-info-circle me-1"></i>
                                Shows support RRULE recurrence patterns. Set the repeat options below to define when this show airs.
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Recurrence Options -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-arrow-repeat me-1"></i>Repeat</label>
                        <select class="form-select" id="recurrenceType">
                            <option value="">Does not repeat</option>
                            <option value="daily">Daily</option>
                            <option value="weekdays">Every weekday (Mon-Fri)</option>
                            <option value="weekly">Weekly on this day</option>
                            <option value="custom">Custom days...</option>
                        </select>
                    </div>

                    <!-- Custom days (shown when custom selected) -->
                    <div class="mb-3 d-none" id="customDaysContainer">
                        <label class="form-label">Repeat on</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="0" id="day-sun">
                                <label class="form-check-label" for="day-sun">Sun</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="day-mon">
                                <label class="form-check-label" for="day-mon">Mon</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="2" id="day-tue">
                                <label class="form-check-label" for="day-tue">Tue</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="3" id="day-wed">
                                <label class="form-check-label" for="day-wed">Wed</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="4" id="day-thu">
                                <label class="form-check-label" for="day-thu">Thu</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="5" id="day-fri">
                                <label class="form-check-label" for="day-fri">Fri</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="6" id="day-sat">
                                <label class="form-check-label" for="day-sat">Sat</label>
                            </div>
                        </div>
                    </div>

                    <!-- Recurrence end date (shown when any recurrence selected) -->
                    <div class="mb-3 d-none" id="recurrenceEndContainer">
                        <label class="form-label">End repeat</label>
                        <div class="d-flex gap-2 align-items-center">
                            <select class="form-select" id="recurrenceEndType" style="width: auto;">
                                <option value="never">Never</option>
                                <option value="date">On date</option>
                            </select>
                            <input type="date" class="form-control d-none" id="recurrenceEndDate" style="width: auto;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddSchedule">
                    <i class="bi bi-calendar-plus me-1"></i>Add to Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Entry Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Schedule Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEntryId">
                <input type="hidden" id="editIsRecurring" value="false">

                <!-- Recurring event notice -->
                <div class="alert alert-warning d-none" id="editRecurringNotice">
                    <i class="bi bi-arrow-repeat me-2"></i>
                    <strong>This is a recurring event.</strong>
                    <div class="mt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="editMode" id="editModeSingle" value="single">
                            <label class="form-check-label" for="editModeSingle">Edit only this occurrence</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="editMode" id="editModeAll" value="all" checked>
                            <label class="form-check-label" for="editModeAll">Edit all occurrences</label>
                        </div>
                    </div>
                </div>

                <!-- Orphaned source warning -->
                <div class="alert alert-danger d-none mb-3" id="editOrphanedWarning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Broken reference!</strong> The source this entry points to has been deleted.
                    Change the source to fix it, or delete this entry.
                </div>

                <!-- Current source info -->
                <div class="mb-3 p-3 bg-body-secondary rounded">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge" id="editEntryTypeBadge">-</span>
                        <span id="editEntryName" class="fw-medium">-</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" id="editChangeSourceBtn" title="Change source">
                            <i class="bi bi-pencil me-1"></i>Change
                        </button>
                    </div>
                </div>

                <!-- Source selection (hidden by default) -->
                <div class="d-none" id="editSourceSelection">
                    <div class="mb-3">
                        <label class="form-label">Source Type</label>
                        <select class="form-select" id="editSourceType">
                            <option value="media">Media File</option>
                            <option value="playlist">Playlist</option>
                            <option value="smart_block">Smart Block</option>
                            <option value="clock_template">Clock Template</option>
                            <option value="webstream">Webstream</option>
                            <option value="live">Live Session</option>
                        </select>
                    </div>
                    <!-- Media search for edit modal -->
                    <div class="mb-3 d-none" id="editMediaSearchContainer">
                        <label class="form-label">Search Media</label>
                        <input type="text" class="form-control mb-2" id="editMediaSearchInput"
                               placeholder="Search by title, artist...">
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="editIncludeArchiveMedia">
                            <label class="form-check-label small" for="editIncludeArchiveMedia">
                                <i class="bi bi-globe me-1"></i>Include public archive
                            </label>
                        </div>
                        <div id="editMediaSearchResults" class="list-group" style="max-height: 200px; overflow-y: auto;">
                            <div class="list-group-item text-body-secondary">Type to search media...</div>
                        </div>
                    </div>
                    <div class="mb-3 d-none" id="editSourceSelectContainer">
                        <label class="form-label">Select Source</label>
                        <select class="form-select" id="editSourceSelect">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>

                <hr>

                <!-- Date Selection -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="editStartDate" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="editEndDate" required>
                    </div>
                </div>

                <!-- Time Selection -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Start Time</label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="editStartHour" style="width: 80px;">
                                {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                            </select>
                            <span class="align-self-center">:</span>
                            <select class="form-select" id="editStartMinute" style="width: 80px;">
                                <option value="0">00</option>
                                <option value="5">05</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="35">35</option>
                                <option value="40">40</option>
                                <option value="45">45</option>
                                <option value="50">50</option>
                                <option value="55">55</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Time</label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="editEndHour" style="width: 80px;">
                                {{range $i := iterate 24}}<option value="{{$i}}">{{printf "%02d" $i}}</option>{{end}}
                            </select>
                            <span class="align-self-center">:</span>
                            <select class="form-select" id="editEndMinute" style="width: 80px;">
                                <option value="0">00</option>
                                <option value="5">05</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="35">35</option>
                                <option value="40">40</option>
                                <option value="45">45</option>
                                <option value="50">50</option>
                                <option value="55">55</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Duration Display -->
                <div class="alert alert-info py-2 mb-3" id="editDurationDisplay">
                    <i class="bi bi-clock me-2"></i>
                    <span id="editDurationText">Duration: --</span>
                </div>

                <!-- Crossfade -->
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-music-note-beamed me-1"></i>Crossfade</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="editCrossfadeOverride">
                        <label class="form-check-label" for="editCrossfadeOverride">
                            Override station crossfade for this entry
                        </label>
                    </div>
                    <div class="row g-2 align-items-end" id="editCrossfadeFields">
                        <div class="col-md-4">
                            <label class="form-label small mb-1" for="editCrossfadeEnabled">Enabled</label>
                            <select class="form-select form-select-sm" id="editCrossfadeEnabled">
                                <option value="inherit" selected>Inherit station default</option>
                                <option value="on">On</option>
                                <option value="off">Off</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1" for="editCrossfadeDurationMs">Duration (ms)</label>
                            <input type="number" class="form-control form-control-sm" id="editCrossfadeDurationMs"
                                   min="0" max="30000" step="250" value="0">
                        </div>
                    </div>
                    <div class="form-text">Crossfade overlaps and fades between items at schedule transitions.</div>
                </div>

                <hr>

                <!-- Recurrence Options (shown for "all occurrences" mode) -->
                <div id="editRecurrenceSection">
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-arrow-repeat me-1"></i>Repeat</label>
                        <select class="form-select" id="editRecurrenceType">
                            <option value="">Does not repeat</option>
                            <option value="daily">Daily</option>
                            <option value="weekdays">Every weekday (Mon-Fri)</option>
                            <option value="weekly">Weekly on this day</option>
                            <option value="custom">Custom days...</option>
                        </select>
                    </div>

                    <!-- Custom days -->
                    <div class="mb-3 d-none" id="editCustomDaysContainer">
                        <label class="form-label">Repeat on</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="0" id="edit-day-sun">
                                <label class="form-check-label" for="edit-day-sun">Sun</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="edit-day-mon">
                                <label class="form-check-label" for="edit-day-mon">Mon</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="2" id="edit-day-tue">
                                <label class="form-check-label" for="edit-day-tue">Tue</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="3" id="edit-day-wed">
                                <label class="form-check-label" for="edit-day-wed">Wed</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="4" id="edit-day-thu">
                                <label class="form-check-label" for="edit-day-thu">Thu</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="5" id="edit-day-fri">
                                <label class="form-check-label" for="edit-day-fri">Fri</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="6" id="edit-day-sat">
                                <label class="form-check-label" for="edit-day-sat">Sat</label>
                            </div>
                        </div>
                    </div>

                    <!-- Recurrence end date -->
                    <div class="mb-3 d-none" id="editRecurrenceEndContainer">
                        <label class="form-label">End repeat</label>
                        <div class="d-flex gap-2 align-items-center">
                            <select class="form-select" id="editRecurrenceEndType" style="width: auto;">
                                <option value="never">Never</option>
                                <option value="date">On date</option>
                            </select>
                            <input type="date" class="form-control d-none" id="editRecurrenceEndDate" style="width: auto;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-danger" id="editDeleteBtn" title="Delete this entry">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmEditSchedule">
                        <i class="bi bi-check-lg me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Validation Results Modal -->
<div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>Schedule Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <div id="validationLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-body-secondary">Validating schedule...</p>
                </div>
                <div id="validationResults" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-success me-1" id="validStatusBadge">Valid</span>
                            <small class="text-body-secondary">Checked: <span id="validationCheckedAt">-</span></small>
                        </div>
                        <div class="text-body-secondary small">
                            <span id="validationRange">-</span>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h5 class="mb-0 text-danger" id="errorCount">0</h5>
                                    <small class="text-body-secondary">Errors</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h5 class="mb-0 text-warning" id="warningCount">0</h5>
                                    <small class="text-body-secondary">Warnings</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h5 class="mb-0 text-info" id="infoCount">0</h5>
                                    <small class="text-body-secondary">Info</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error list -->
                    <div id="errorsList" class="mb-3 d-none">
                        <h6 class="text-danger"><i class="bi bi-x-circle me-1"></i>Errors</h6>
                        <div id="errorsContainer"></div>
                    </div>

                    <!-- Warning list -->
                    <div id="warningsList" class="mb-3 d-none">
                        <h6 class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Warnings</h6>
                        <div id="warningsContainer"></div>
                    </div>

                    <!-- Info list -->
                    <div id="infoList" class="d-none">
                        <h6 class="text-info"><i class="bi bi-info-circle me-1"></i>Info</h6>
                        <div id="infoContainer"></div>
                    </div>

                    <!-- All valid message -->
                    <div id="allValidMessage" class="text-center py-4 d-none">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <p class="mt-2 mb-0 text-success fw-bold">Schedule is valid!</p>
                        <p class="text-body-secondary small">No conflicts or issues found.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="revalidateBtn">
                    <i class="bi bi-arrow-clockwise me-1"></i>Re-validate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Save Template Modal -->
<div class="modal fade" id="saveTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-save me-2"></i>Save as Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-body-secondary small">Save the current week's schedule as a reusable template.</p>
                <div class="mb-3">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-control" id="templateName" placeholder="e.g., Standard Week, Holiday Schedule">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-control" id="templateDescription" rows="2" placeholder="Brief description of this template"></textarea>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="templateStartDate">
                    </div>
                    <div class="col-6">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="templateEndDate">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveTemplate">
                    <i class="bi bi-save me-1"></i>Save Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Load Template Modal -->
<div class="modal fade" id="loadTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-folder2-open me-2"></i>Load Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <div id="templateListLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="templateListEmpty" class="text-center py-4 d-none">
                    <i class="bi bi-collection text-body-secondary" style="font-size: 3rem;"></i>
                    <p class="mt-2 text-body-secondary">No templates saved yet.</p>
                </div>
                <div id="templateList" class="d-none">
                    <div class="list-group" id="templateListItems">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <hr class="my-3 d-none" id="applyTemplateHr">
                <div id="applyTemplateSection" class="d-none">
                    <h6>Apply Template</h6>
                    <p class="text-body-secondary small">Selected: <strong id="selectedTemplateName">-</strong></p>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Target Week Start</label>
                            <input type="date" class="form-control" id="applyTargetDate">
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="clearExisting">
                                <label class="form-check-label" for="clearExisting">
                                    Clear existing entries in target week
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-danger d-none" id="deleteTemplateBtn">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary d-none" id="confirmApplyTemplate">
                        <i class="bi bi-check-lg me-1"></i>Apply Template
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div class="modal fade" id="versionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Version History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <div id="versionListLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="versionListEmpty" class="text-center py-4 d-none">
                    <i class="bi bi-clock-history text-body-secondary" style="font-size: 3rem;"></i>
                    <p class="mt-2 text-body-secondary">No version history available.</p>
                </div>
                <div id="versionList" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Version</th>
                                    <th>Change</th>
                                    <th>By</th>
                                    <th>Date</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="versionListItems">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Version Diff Modal -->
<div class="modal fade" id="versionDiffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-diff me-2"></i>Version Diff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <div id="diffLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="diffContent" class="d-none">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Version <strong id="diffFromVersion">-</strong></span>
                        <i class="bi bi-arrow-right"></i>
                        <span>Version <strong id="diffToVersion">-</strong></span>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-plus-circle me-1"></i>Added (<span id="diffAddedCount">0</span>)
                                </div>
                                <div class="card-body p-2" id="diffAddedList" style="max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <i class="bi bi-dash-circle me-1"></i>Removed (<span id="diffRemovedCount">0</span>)
                                </div>
                                <div class="card-body p-2" id="diffRemovedList" style="max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <i class="bi bi-pencil me-1"></i>Modified (<span id="diffModifiedCount">0</span>)
                                </div>
                                <div class="card-body p-2" id="diffModifiedList" style="max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-warning d-none" id="restoreVersionBtn">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Restore This Version
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<!-- FullCalendar JS -->
<script src="https://unpkg.com/fullcalendar@6.1.15/index.global.min.js"
        onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js';"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const mountFilter = document.getElementById('mountFilter');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const addScheduleModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    const editScheduleModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));

    // Context menu elements
    const calendarContextMenu = document.getElementById('calendarContextMenu');
    const eventContextMenu = document.getElementById('eventContextMenu');

    let selectedEvent = null;
    let selectedTimeRange = null;
    let contextMenuTarget = null;
    let overlapEventIDs = new Set();

    // Hide context menus on click outside
    document.addEventListener('click', hideAllContextMenus);
    document.addEventListener('contextmenu', (e) => {
        // Keep custom menus open for calendar-originated right clicks.
        if (e.target.closest('.context-menu')) return;
        if (e.target.closest('#calendar')) return;
        hideAllContextMenus();
    });

    function hideAllContextMenus() {
        calendarContextMenu.classList.remove('show');
        eventContextMenu.classList.remove('show');
    }

    function showContextMenu(menu, x, y) {
        hideAllContextMenus();

        // Show menu first so we can measure it
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        menu.classList.add('show');

        // Now adjust position if needed to stay in viewport
        const rect = menu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            menu.style.left = Math.max(0, x - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            menu.style.top = Math.max(0, y - rect.height) + 'px';
        }
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        slotDuration: '00:15:00',
        snapDuration: '00:05:00',
        allDaySlot: false,
        nowIndicator: true,
        navLinks: true, // Enable drill-down: month->week->day
        navLinkDayClick: 'timeGridDay', // Click day number goes to day view
        navLinkWeekClick: 'timeGridWeek', // Click week number goes to week view
        editable: {{if roleAtLeast .User "manager"}}true{{else}}false{{end}},
        eventResizableFromStart: true,
        selectable: {{if roleAtLeast .User "manager"}}true{{else}}false{{end}},
        selectMirror: true,
        unselectAuto: false,
        longPressDelay: 500,

        // Custom event class names based on source type or show type
        eventClassNames: function(arg) {
            const props = arg.event.extendedProps;
            if (props.type === 'show') {
                let classes = ['event-show'];
                if (props.status === 'cancelled') classes.push('event-cancelled');
                if (props.exception_type) classes.push('event-exception');
                if (props.overlap_highlight || overlapEventIDs.has(arg.event.id)) classes.push('event-overlap');
                return classes;
            }
            const type = props.source_type;
            const classes = ['event-' + (type || 'media')];
            if (props.overlap_highlight || overlapEventIDs.has(arg.event.id)) classes.push('event-overlap');
            return classes;
        },

        // Use multiple event sources: schedule entries + shows
        eventSources: [
            // Schedule entries
            {
                id: 'schedule',
                events: function(info, successCallback, failureCallback) {
                    const mountId = mountFilter.value;
                    let url = `/dashboard/schedule/events?start=${info.startStr}&end=${info.endStr}`;
                    if (mountId) {
                        url += `&mount_id=${mountId}`;
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => successCallback(data))
                        .catch(error => failureCallback(error));
                }
            },
            // Show instances
            {
                id: 'shows',
                events: function(info, successCallback, failureCallback) {
                    let url = `/dashboard/schedule/show-events?start=${info.startStr}&end=${info.endStr}`;
                    fetch(url)
                        .then(response => response.json())
                        .then(data => successCallback(data))
                        .catch(error => {
                            console.warn('Failed to load show events:', error);
                            successCallback([]); // Don't fail calendar on show fetch error
                        });
                }
            }
        ],

        // Left click on event - open edit modal or show details
        eventClick: function(info) {
            selectedEvent = info.event;
            const props = info.event.extendedProps;
            if (props.type === 'show') {
                showShowInstanceDetails(info.event);
            } else {
                openEditModal(info.event);
            }
        },

        // Right click on event - show context menu
        eventDidMount: function(info) {
            info.el.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                selectedEvent = info.event;
                contextMenuTarget = 'event';
                showContextMenu(eventContextMenu, e.pageX, e.pageY);
            });
        },

        eventDrop: function(info) {
            const props = info.event.extendedProps;
            if (props.type === 'show') {
                updateShowInstance(info.event);
            } else {
                updateEvent(info.event);
            }
        },

        eventResize: function(info) {
            const props = info.event.extendedProps;
            if (props.type === 'show') {
                updateShowInstance(info.event);
            } else {
                updateEvent(info.event);
            }
        },

        // Time selection (drag only) - store the range and show context menu
        select: function(info) {
            // Only trigger if actual drag (selection > 5 minutes)
            const duration = info.end - info.start;
            if (duration <= 5 * 60 * 1000) {
                // Too short - likely a click, not a drag. Ignore.
                calendar.unselect();
                return;
            }

            selectedTimeRange = { start: info.start, end: info.end };

            // Show context menu at mouse position after selection
            setTimeout(() => {
                const evt = info.jsEvent;
                if (evt) {
                    contextMenuTarget = 'calendar';
                    showContextMenu(calendarContextMenu, evt.pageX, evt.pageY);
                }
            }, 50);
        },

        unselect: function() {
            // Keep the selection for context menu usage
        }
    });

    // Add right-click on calendar background (empty time slots)
    calendarEl.addEventListener('contextmenu', function(e) {
        const fcEvent = e.target.closest('.fc-event');
        if (fcEvent) return; // Event right-click handled above

        // Show context menu on any right-click within calendar
        e.preventDefault();
        e.stopPropagation();
        contextMenuTarget = 'calendar';
        showContextMenu(calendarContextMenu, e.pageX, e.pageY);
    });

    calendar.render();
    window.calendar = calendar;

    // Power features: click time axis for daily recurring, click date header for all-day
    calendarEl.addEventListener('click', function(e) {
        // Check if clicking on time axis label (left side in week/day view)
        const timeLabel = e.target.closest('.fc-timegrid-slot-label');
        if (timeLabel) {
            const timeText = timeLabel.getAttribute('data-time');
            if (timeText) {
                // Parse time like "09:00:00"
                const [hours, minutes] = timeText.split(':').map(Number);
                const start = new Date();
                start.setHours(hours, minutes, 0, 0);
                const end = new Date(start.getTime() + 60 * 60000); // 1 hour default

                selectedTimeRange = { start, end };
                // Pre-set daily recurrence
                openAddScheduleModal(start, end, 'media', 'daily');
                return;
            }
        }

        // Check if clicking on day header (top in week view)
        const dayHeader = e.target.closest('.fc-col-header-cell');
        if (dayHeader) {
            const dateAttr = dayHeader.getAttribute('data-date');
            if (dateAttr) {
                const date = new Date(dateAttr);
                // All day = midnight to midnight
                const start = new Date(date);
                start.setHours(0, 0, 0, 0);
                const end = new Date(date);
                end.setHours(23, 59, 0, 0);

                selectedTimeRange = { start, end };
                openAddScheduleModal(start, end, 'media', '');
                return;
            }
        }

        // Check if clicking on month day number
        const dayNumber = e.target.closest('.fc-daygrid-day-number');
        if (dayNumber) {
            const dayCell = dayNumber.closest('.fc-daygrid-day');
            if (dayCell) {
                const dateAttr = dayCell.getAttribute('data-date');
                if (dateAttr) {
                    const date = new Date(dateAttr);
                    const start = new Date(date);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(date);
                    end.setHours(23, 59, 0, 0);

                    selectedTimeRange = { start, end };
                    openAddScheduleModal(start, end, 'media', '');
                    return;
                }
            }
        }
    });

    // Context menu action handlers
    document.querySelectorAll('.context-menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const action = this.dataset.action;
            hideAllContextMenus();
            handleContextAction(action);
        });
    });

    function handleContextAction(action) {
        switch(action) {
            // Calendar context actions
            case 'add-media':
            case 'add-playlist':
            case 'add-smartblock':
            case 'add-clock':
            case 'add-webstream':
            case 'add-live':
            case 'add-show':
                if (selectedTimeRange) {
                    openAddScheduleModal(selectedTimeRange.start, selectedTimeRange.end, action.replace('add-', ''));
                } else {
                    // Use current time if no selection
                    const now = new Date();
                    const end = new Date(now.getTime() + 60 * 60000);
                    openAddScheduleModal(now, end, action.replace('add-', ''));
                }
                break;

            // Event context actions
            case 'event-details':
                if (selectedEvent) {
                    const props = selectedEvent.extendedProps;
                    if (props.type === 'show') {
                        showShowInstanceDetails(selectedEvent);
                    } else {
                        showEventDetails(selectedEvent);
                    }
                }
                break;
            case 'event-edit':
                if (selectedEvent) {
                    const props = selectedEvent.extendedProps;
                    if (props.type === 'show') {
                        showShowInstanceDetails(selectedEvent);
                    } else {
                        openEditModal(selectedEvent);
                    }
                }
                break;
            case 'event-duplicate':
                if (selectedEvent) duplicateEvent(selectedEvent);
                break;
            case 'event-move':
                grimnirUtils.showToast('Drag the event to move it', 'info');
                break;
            case 'event-delete':
                if (selectedEvent) {
                    const props = selectedEvent.extendedProps;
                    if (props.type === 'show') {
                        cancelShowInstance(selectedEvent);
                    } else {
                        deleteEvent(selectedEvent);
                    }
                }
                break;
        }
    }

    async function showEventDetails(event) {
        const props = event.extendedProps;
        const modalBody = document.getElementById('eventModalBody');

        document.getElementById('eventModalTitle').textContent = event.title || 'Scheduled Item';

        // Show loading state
        modalBody.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Loading details...</div>';
        eventModal.show();

        let typeColor = {
            'media': 'primary',
            'playlist': 'success',
            'smart_block': 'info',
            'clock_template': 'purple',
            'live': 'danger',
            'webstream': 'warning',
            'show': 'secondary'
        }[props.source_type] || 'secondary';

        let typeLabel = {
            'media': 'Track',
            'playlist': 'Playlist',
            'smart_block': 'Smart Block',
            'clock_template': 'Clock Template',
            'live': 'Live',
            'webstream': 'Webstream',
            'show': 'Show'
        }[props.source_type] || props.source_type;

        // Fetch detailed info from API
        let details = null;
        try {
            const resp = await fetch(`/dashboard/schedule/entries/${event.id}/details`);
            if (resp.ok) {
                details = await resp.json();
            }
        } catch (e) {
            console.warn('Failed to fetch entry details:', e);
        }

        const sourceName = getSourceDisplayName(details, props, event);
        const sourceURL = getSourceURL(props.source_type, props.source_id);

        let body = `
            <dl class="row mb-3">
                <dt class="col-4">Type</dt>
                <dd class="col-8"><span class="badge bg-${typeColor}">${typeLabel}</span></dd>

                <dt class="col-4">Source</dt>
                <dd class="col-8">${
                    sourceURL
                        ? `<a href="${sourceURL}" target="_blank" rel="noopener">${escapeHtml(sourceName)}</a>`
                        : escapeHtml(sourceName)
                }</dd>

                <dt class="col-4">Start</dt>
                <dd class="col-8">${event.start.toLocaleString()}</dd>

                <dt class="col-4">End</dt>
                <dd class="col-8">${event.end.toLocaleString()}</dd>

                <dt class="col-4">Duration</dt>
                <dd class="col-8">${formatDuration((event.end - event.start) / 1000)}</dd>
            </dl>
        `;

        // Add detailed content section
        if (details) {
            body += renderDetailsContent(details, props.source_type);
        }

        modalBody.innerHTML = body;

        // Populate links in footer
        const linksContainer = document.getElementById('eventModalLinks');
        if (linksContainer) {
            linksContainer.innerHTML = renderSourceLinks(details, props.source_type);
        }
    }

    function renderSourceLinks(details, sourceType) {
        if (!details) return '';

        switch (sourceType) {
        case 'clock_template':
            if (details.clock) {
                return `<a href="/dashboard/clocks/${details.clock.id}" class="btn btn-sm btn-outline-secondary" target="_blank">
                    <i class="bi bi-clock me-1"></i>View Clock Template
                </a>`;
            }
            break;
        case 'playlist':
            if (details.playlist) {
                return `<a href="/dashboard/playlists/${details.playlist.id}" class="btn btn-sm btn-outline-secondary" target="_blank">
                    <i class="bi bi-music-note-list me-1"></i>View Playlist
                </a>`;
            }
            break;
        case 'smart_block':
            if (details.smart_block) {
                return `<a href="/dashboard/smart-blocks/${details.smart_block.id}" class="btn btn-sm btn-outline-secondary" target="_blank">
                    <i class="bi bi-lightning me-1"></i>View Smart Block
                </a>`;
            }
            break;
        case 'media':
            if (details.media) {
                return `<a href="/dashboard/media/${details.media.id}" class="btn btn-sm btn-outline-secondary" target="_blank">
                    <i class="bi bi-file-music me-1"></i>View Media
                </a>`;
            }
            break;
        case 'webstream':
            if (details.webstream) {
                return `<a href="/dashboard/webstreams/${details.webstream.id}" class="btn btn-sm btn-outline-secondary" target="_blank">
                    <i class="bi bi-broadcast me-1"></i>View Webstream
                </a>`;
            }
            break;
        }
        return '';
    }

    function getSourceDisplayName(details, props, event) {
        if (details?.playlist?.name) return details.playlist.name;
        if (details?.smart_block?.name) return details.smart_block.name;
        if (details?.clock?.name) return details.clock.name;
        if (details?.webstream?.name) return details.webstream.name;
        if (details?.media?.title) {
            return details.media.artist
                ? `${details.media.artist} - ${details.media.title}`
                : details.media.title;
        }
        return props?.source_name || event?.title || 'Scheduled Item';
    }

    function getSourceURL(sourceType, sourceID) {
        if (!sourceID) return null;
        switch (sourceType) {
        case 'clock_template':
            return `/dashboard/clocks/${encodeURIComponent(sourceID)}`;
        case 'playlist':
            return `/dashboard/playlists/${encodeURIComponent(sourceID)}`;
        case 'smart_block':
            return `/dashboard/smart-blocks/${encodeURIComponent(sourceID)}`;
        case 'media':
            return `/dashboard/media/${encodeURIComponent(sourceID)}`;
        case 'webstream':
            return `/dashboard/webstreams/${encodeURIComponent(sourceID)}`;
        default:
            return null;
        }
    }

    function renderDetailsContent(details, sourceType) {
        let html = '';

        switch (sourceType) {
        case 'clock_template':
            if (details.clock) {
                html += `<div class="border-top pt-3">
                    <h6 class="mb-2"><i class="bi bi-clock me-2"></i>Clock: ${escapeHtml(details.clock.name)}</h6>
                    <div class="small text-body-secondary mb-2">Clock -> Slot source -> Media trace for this scheduled window.</div>`;

                if (details.clock_trace) {
                    html += renderClockTrace(details.clock_trace);
                } else if (details.slots && details.slots.length > 0) {
                    html += `<div class="small text-body-secondary mb-2">${details.slots.length} slot(s) configured</div>`;
                    for (const slot of details.slots) html += renderSlotContent(slot);
                } else {
                    html += `<div class="text-body-secondary small">No slots configured</div>`;
                }
                html += `</div>`;
            }
            break;

        case 'playlist':
            if (details.playlist) {
                html += `<div class="border-top pt-3">
                    <h6 class="mb-2"><i class="bi bi-music-note-list me-2"></i>Playlist: ${escapeHtml(details.playlist.name)}</h6>
                    <div class="small text-body-secondary mb-2">${details.playlist.track_count} tracks, ${formatDuration(details.playlist.total_duration)}</div>`;
                html += renderTrackList(details.playlist.tracks);
                html += `</div>`;
            }
            break;

        case 'smart_block':
            if (details.smart_block) {
                html += `<div class="border-top pt-3">
                    <h6 class="mb-2"><i class="bi bi-lightning me-2"></i>Smart Block: ${escapeHtml(details.smart_block.name)}</h6>
                    <div class="small text-body-secondary mb-2">Rule-driven selection for this scheduled time window.</div>
                    ${renderSmartBlockPreview(details.smart_block_preview)}
                </div>`;
            }
            break;

        case 'media':
            if (details.media) {
                html += `<div class="border-top pt-3">
                    <h6 class="mb-2"><i class="bi bi-file-music me-2"></i>Track Details</h6>
                    <dl class="row mb-0 small">
                        <dt class="col-4">Title</dt><dd class="col-8">${escapeHtml(details.media.title || '-')}</dd>
                        <dt class="col-4">Artist</dt><dd class="col-8">${escapeHtml(details.media.artist || '-')}</dd>
                        <dt class="col-4">Album</dt><dd class="col-8">${escapeHtml(details.media.album || '-')}</dd>
                        <dt class="col-4">Genre</dt><dd class="col-8">${escapeHtml(details.media.genre || '-')}</dd>
                        <dt class="col-4">Duration</dt><dd class="col-8">${formatDuration(details.media.duration)}</dd>
                    </dl>
                </div>`;
            }
            break;

        case 'webstream':
            if (details.webstream) {
                html += `<div class="border-top pt-3">
                    <h6 class="mb-2"><i class="bi bi-broadcast me-2"></i>Webstream: ${escapeHtml(details.webstream.name)}</h6>
                    <div class="small text-body-secondary text-truncate">${escapeHtml(details.webstream.url)}</div>
                </div>`;
            }
            break;
        }

        return html;
    }

    function renderSmartBlockPreview(preview) {
        if (!preview) {
            return '<div class="text-body-secondary small">No generated selection is available for this entry yet.</div>';
        }

        if (preview.status === 'pending_materialization') {
            const expected = preview.expected_at ? new Date(preview.expected_at).toLocaleString() : 'later';
            return `
                <div class="alert alert-info py-2 mb-0 small">
                    <div><strong>This section has not been created yet.</strong></div>
                    <div class="mt-1">Expected build time: ${escapeHtml(expected)}.</div>
                    <div class="mt-1">${escapeHtml(preview.help || 'Please check back after that time.')}</div>
                </div>
            `;
        }

        if (preview.error) {
            return `
                <div class="alert alert-warning py-2 mb-0 small">
                    <div><strong>Could not generate selection for this window.</strong></div>
                    <div class="mt-1">Possible cause: rules are too strict or there is not enough matching media.</div>
                    ${preview.cause ? `<div class="text-body-secondary mt-1">Technical: ${escapeHtml(preview.cause)}</div>` : ''}
                </div>
            `;
        }

        const tracks = preview.tracks || [];
        let html = `
            <div class="small text-body-secondary mb-2">
                ${tracks.length} selected track(s), target ${formatDuration(preview.target_duration_s || 0)}, total ${formatDuration(preview.total_duration_s || 0)}
            </div>
        `;
        html += renderTrackList(tracks, 15);

        if (preview.warnings && preview.warnings.length > 0) {
            html += `<div class="small text-warning mt-2">${escapeHtml(preview.warnings.join(' | '))}</div>`;
        }
        return html;
    }

    function renderSlotContent(slot) {
        let html = `<div class="card card-body p-2 mb-2 bg-body-secondary">`;

        if (slot.playlist) {
            html += `<div class="d-flex justify-content-between align-items-center mb-1">
                <span><i class="bi bi-music-note-list me-1"></i><strong>${escapeHtml(slot.playlist.name)}</strong></span>
                <span class="badge bg-success">${slot.playlist.track_count} tracks</span>
            </div>`;
            html += renderTrackList(slot.playlist.tracks, 5);
        } else if (slot.smart_block) {
            html += `<div><i class="bi bi-lightning me-1"></i><strong>${escapeHtml(slot.smart_block.name)}</strong></div>`;
        } else {
            html += `<div class="text-body-secondary">Slot type: ${slot.type}</div>`;
        }

        html += `</div>`;
        return html;
    }

    function renderClockTrace(trace) {
        let html = '';
        const played = trace.played_tracks || [];
        const queued = trace.queued_slots || [];

        html += `<div class="mb-3">
            <h6 class="mb-2"><i class="bi bi-clock-history me-2"></i>Played In This Window</h6>`;
        if (played.length === 0) {
            html += `<div class="text-body-secondary small">No recorded playback for this clock window yet.</div>`;
        } else {
            html += renderTrackList(played, 20);
        }
        html += `</div>`;

        html += `<div class="mb-1">
            <h6 class="mb-2"><i class="bi bi-list-task me-2"></i>Queued / Planned Trace</h6>`;
        if (queued.length === 0) {
            html += `<div class="text-body-secondary small">No slot trace available for this window.</div>`;
        } else {
            for (const slot of queued) {
                const slotStart = slot.starts_at ? new Date(slot.starts_at).toLocaleString() : '-';
                const slotEnd = slot.ends_at ? new Date(slot.ends_at).toLocaleString() : '-';
                html += `<div class="card card-body p-2 mb-2 bg-body-secondary">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            <strong>Slot #${slot.position ?? '-'}</strong>
                            <span class="badge bg-secondary ms-2">${escapeHtml(slot.type || 'unknown')}</span>
                        </div>
                        <small class="text-body-secondary">${slotStart} - ${slotEnd}</small>
                    </div>
                    <div class="small text-body-secondary mb-2">Clock -> ${renderSlotSourceLabel(slot)}</div>
                    ${renderSlotSourceDetails(slot)}
                </div>`;
            }
        }
        html += `</div>`;

        return html;
    }

    function renderSlotSourceLabel(slot) {
        if (slot.playlist) return `Playlist: ${escapeHtml(slot.playlist.name || 'Unknown')}`;
        if (slot.smart_block) return `Smart Block: ${escapeHtml(slot.smart_block.name || 'Unknown')}`;
        if (slot.media) return `Hard Item: ${escapeHtml(slot.media.title || 'Unknown')}`;
        if (slot.webstream) return `Webstream: ${escapeHtml(slot.webstream.name || 'Unknown')}`;
        return escapeHtml(slot.type || 'Unknown source');
    }

    function renderSlotSourceDetails(slot) {
        if (slot.playlist) {
            return `
                <div class="small text-body-secondary mb-1">${slot.playlist.track_count || 0} track(s)</div>
                ${renderTrackList(slot.playlist.tracks || [], 10)}
            `;
        }
        if (slot.smart_block) {
            return `
                <div class="small text-body-secondary mb-1">Smart Block selection for this scheduled clock entry:</div>
                ${renderSmartBlockPreview(slot.smart_block_preview)}
            `;
        }
        if (slot.media) {
            return renderTrackList([slot.media], 1);
        }
        if (slot.webstream) {
            return `<div class="small">${escapeHtml(slot.webstream.name || 'Webstream')}<div class="text-body-secondary text-truncate">${escapeHtml(slot.webstream.url || '')}</div></div>`;
        }
        return `<div class="text-body-secondary small">No source details available.</div>`;
    }

    function renderTrackList(tracks, limit = 10) {
        if (!tracks || tracks.length === 0) {
            return '<div class="text-body-secondary small">No tracks</div>';
        }

        let html = '<div class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;">';
        const displayTracks = tracks.slice(0, limit);

        for (const track of displayTracks) {
            const title = escapeHtml(track.title || 'Unknown');
            const titleHTML = track.media_id
                ? `<a href="/dashboard/media/${encodeURIComponent(track.media_id)}" target="_blank" rel="noopener"><strong>${title}</strong></a>`
                : `<strong>${title}</strong>`;
            html += `<div class="list-group-item py-1 px-2 d-flex justify-content-between">
                <span class="text-truncate" style="max-width: 70%;">
                    ${titleHTML}
                    ${track.artist ? `<span class="text-body-secondary"> - ${escapeHtml(track.artist)}</span>` : ''}
                </span>
                <span class="text-body-secondary">${formatDuration(track.duration)}</span>
            </div>`;
        }

        if (tracks.length > limit) {
            html += `<div class="list-group-item py-1 px-2 text-body-secondary text-center">
                ... and ${tracks.length - limit} more tracks
            </div>`;
        }

        html += '</div>';
        return html;
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}h ${m}m`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    async function openAddScheduleModal(start, end, sourceType = 'media', recurrence = '') {
        const startDate = new Date(start);
        const endDate = new Date(end);

        // Set date inputs
        document.getElementById('scheduleStartDate').value = formatDateOnly(startDate);
        document.getElementById('scheduleEndDate').value = formatDateOnly(endDate);

        // Set time inputs - snap to nearest 5 minutes
        const startMinute = Math.round(startDate.getMinutes() / 5) * 5;
        const endMinute = Math.round(endDate.getMinutes() / 5) * 5;

        document.getElementById('scheduleStartHour').value = startDate.getHours();
        document.getElementById('scheduleStartMinute').value = startMinute >= 60 ? 55 : startMinute;
        document.getElementById('scheduleEndHour').value = endDate.getHours();
        document.getElementById('scheduleEndMinute').value = endMinute >= 60 ? 55 : endMinute;

        // Update duration display
        updateDurationDisplay();

        // Select the appropriate tab
        const tabMap = {
            'media': 'media-tab',
            'playlist': 'playlist-tab',
            'smartblock': 'smartblock-tab',
            'clock': 'clock-tab',
            'webstream': 'webstream-tab',
            'live': 'live-tab',
            'show': 'show-tab'
        };
        const tabId = tabMap[sourceType] || 'media-tab';
        document.getElementById(tabId)?.click();

        // Set recurrence if provided
        const recurrenceSelect = document.getElementById('recurrenceType');
        if (recurrenceSelect) {
            recurrenceSelect.value = recurrence || '';
            // Trigger change to show/hide custom days container
            recurrenceSelect.dispatchEvent(new Event('change'));
        }

        // Load data for dropdowns and media (await all to complete)
        await Promise.all([
            loadPlaylists(),
            loadSmartBlocks(),
            loadClockTemplates(),
            loadWebstreams(),
            loadInitialMedia(),
            loadShows()
        ]);

        addScheduleModal.show();
    }

    function formatDateOnly(date) {
        const d = new Date(date);
        const pad = n => n.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function getScheduleStartDateTime() {
        const date = document.getElementById('scheduleStartDate').value;
        const hour = parseInt(document.getElementById('scheduleStartHour').value);
        const minute = parseInt(document.getElementById('scheduleStartMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function getScheduleEndDateTime() {
        const date = document.getElementById('scheduleEndDate').value;
        const hour = parseInt(document.getElementById('scheduleEndHour').value);
        const minute = parseInt(document.getElementById('scheduleEndMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function setScheduleEndDateTime(dateTime) {
        document.getElementById('scheduleEndDate').value = formatDateOnly(dateTime);
        document.getElementById('scheduleEndHour').value = dateTime.getHours();
        // Snap to nearest 5 minutes
        const minute = Math.round(dateTime.getMinutes() / 5) * 5;
        document.getElementById('scheduleEndMinute').value = minute >= 60 ? 55 : minute;
    }

    function updateDurationDisplay() {
        const start = getScheduleStartDateTime();
        const end = getScheduleEndDateTime();
        const durationMs = end - start;

        if (durationMs <= 0) {
            document.getElementById('durationText').textContent = 'Invalid: End time must be after start time';
            document.getElementById('durationDisplay').classList.remove('alert-info');
            document.getElementById('durationDisplay').classList.add('alert-danger');
            return;
        }

        document.getElementById('durationDisplay').classList.remove('alert-danger');
        document.getElementById('durationDisplay').classList.add('alert-info');

        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));

        let text = 'Duration: ';
        if (hours > 0) text += `${hours}h `;
        if (minutes > 0 || hours === 0) text += `${minutes}m`;

        document.getElementById('durationText').textContent = text.trim();
    }

    // Time adjustment buttons
    document.querySelectorAll('.time-adjust').forEach(btn => {
        btn.addEventListener('click', function() {
            const target = this.dataset.target;
            const delta = parseInt(this.dataset.delta);

            if (target === 'start') {
                const current = getScheduleStartDateTime();
                current.setMinutes(current.getMinutes() + delta);
                document.getElementById('scheduleStartDate').value = formatDateOnly(current);
                document.getElementById('scheduleStartHour').value = current.getHours();
                const minute = Math.round(current.getMinutes() / 5) * 5;
                document.getElementById('scheduleStartMinute').value = minute >= 60 ? 55 : minute;
            } else {
                const current = getScheduleEndDateTime();
                current.setMinutes(current.getMinutes() + delta);
                setScheduleEndDateTime(current);
            }
            updateDurationDisplay();
        });
    });

    // Duration quick buttons
    document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const minutes = parseInt(this.dataset.minutes);
            const start = getScheduleStartDateTime();
            const end = new Date(start.getTime() + minutes * 60 * 1000);
            setScheduleEndDateTime(end);
            updateDurationDisplay();
        });
    });

    // Update duration on any time change
    ['scheduleStartDate', 'scheduleStartHour', 'scheduleStartMinute',
     'scheduleEndDate', 'scheduleEndHour', 'scheduleEndMinute'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateDurationDisplay);
    });

    // Load dropdown data
    async function loadPlaylists() {
        try {
            const response = await fetch('/dashboard/schedule/playlists.json');
            if (!response.ok) {
                console.error('Failed to load playlists:', response.status);
                return;
            }
            const data = await response.json();
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Select a playlist...</option>';
            const playlists = data.playlists || [];
            console.log('Loaded playlists:', playlists.length);
            playlists.forEach(p => {
                select.innerHTML += `<option value="${p.ID}">${p.Name}</option>`;
            });
        } catch (e) { console.error('Failed to load playlists:', e); }
    }

    async function loadSmartBlocks() {
        try {
            const response = await fetch('/dashboard/schedule/smart-blocks.json');
            if (!response.ok) {
                console.error('Failed to load smart blocks:', response.status);
                return;
            }
            const data = await response.json();
            const select = document.getElementById('smartBlockSelect');
            select.innerHTML = '<option value="">Select a smart block...</option>';
            const smartBlocks = data.smart_blocks || [];
            console.log('Loaded smart blocks:', smartBlocks.length);
            smartBlocks.forEach(sb => {
                select.innerHTML += `<option value="${sb.ID}">${sb.Name}</option>`;
            });
        } catch (e) { console.error('Failed to load smart blocks:', e); }
    }

    async function loadWebstreams() {
        try {
            const response = await fetch('/dashboard/schedule/webstreams.json');
            const data = await response.json();
            const select = document.getElementById('webstreamSelect');
            select.innerHTML = '<option value="">Select a webstream...</option>';
            (data.webstreams || []).forEach(ws => {
                select.innerHTML += `<option value="${ws.ID}">${ws.Name}</option>`;
            });
        } catch (e) { console.error('Failed to load webstreams:', e); }
    }

    async function loadClockTemplates() {
        try {
            const response = await fetch('/dashboard/schedule/clocks.json');
            const data = await response.json();
            const select = document.getElementById('clockSelect');
            const clockInfo = document.getElementById('clockInfo');
            const clockInfoText = document.getElementById('clockInfoText');

            select.innerHTML = '<option value="">Select a clock template...</option>';
            const clocks = data.clocks || [];
            clocks.forEach(clock => {
                const slotCount = clock.Slots?.length || 0;
                select.innerHTML += `<option value="${clock.ID}" data-slots="${slotCount}">${clock.Name} (${slotCount} slots)</option>`;
            });

            // Show clock info on selection
            select.addEventListener('change', function() {
                const option = this.selectedOptions[0];
                if (option && option.value) {
                    const slots = option.dataset.slots || 0;
                    clockInfoText.textContent = `This clock has ${slots} slot(s). Duration will expand to fill the scheduled time.`;
                    clockInfo.classList.remove('d-none');

                    // Auto-set end time to 1 hour after start
                    const start = getScheduleStartDateTime();
                    const end = new Date(start.getTime() + 60 * 60 * 1000); // 1 hour
                    setScheduleEndDateTime(end);
                    updateDurationDisplay();
                } else {
                    clockInfo.classList.add('d-none');
                }
            });
        } catch (e) { console.error('Failed to load clock templates:', e); }
    }

    // Load initial media items (without search query)
    // Helper to get include archive setting
    function getIncludeArchive() {
        return document.getElementById('includeArchiveMedia')?.checked || false;
    }

    async function loadInitialMedia() {
        try {
            const includeArchive = getIncludeArchive();
            const url = `/dashboard/schedule/media.json${includeArchive ? '?include_archive=true' : ''}`;
            const response = await fetch(url);
            const data = await response.json();
            displayMediaResults('mediaSearchResults', data.items || []);
        } catch (e) {
            console.error('Failed to load media:', e);
        }
    }

    // Shared function to display media results
    function displayMediaResults(containerId, items) {
        const results = document.getElementById(containerId);
        results.innerHTML = '';

        if (items.length === 0) {
            results.innerHTML = '<div class="list-group-item text-body-secondary">No media found. Try uploading some tracks first.</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('a');
            div.href = '#';
            div.className = 'list-group-item list-group-item-action';
            div.dataset.mediaId = item.id;
            div.dataset.duration = item.duration;

            // Show station badge for archive items
            const stationBadge = item.is_archive && item.station_name
                ? `<span class="badge bg-info text-dark ms-1" title="From ${item.station_name}"><i class="bi bi-globe"></i></span>`
                : '';
            const stationInfo = item.is_archive && item.station_name
                ? ` <span class="text-info">via ${item.station_name}</span>`
                : '';

            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.title}</strong>${stationBadge}<br>
                        <small class="text-body-secondary">${item.artist || 'Unknown'}${stationInfo}  ${formatDuration(item.duration)}</small>
                    </div>
                    <i class="bi bi-plus-circle text-primary"></i>
                </div>
            `;
            div.addEventListener('click', (e) => {
                e.preventDefault();
                // Deselect others
                results.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
            });
            results.appendChild(div);
        });
    }

    // Re-search when archive toggle changes
    document.getElementById('includeArchiveMedia')?.addEventListener('change', function() {
        const searchInput = document.getElementById('mediaSearchInput');
        if (searchInput && searchInput.value.length >= 2) {
            searchInput.dispatchEvent(new Event('input'));
        } else {
            loadInitialMedia();
        }
    });

    // Media search
    let mediaSearchTimeout;
    document.getElementById('mediaSearchInput')?.addEventListener('input', function(e) {
        clearTimeout(mediaSearchTimeout);
        const query = e.target.value;

        if (query.length === 0) {
            // If search is cleared, reload initial media
            loadInitialMedia();
            return;
        }

        if (query.length < 2) return;

        mediaSearchTimeout = setTimeout(async () => {
            try {
                const includeArchive = getIncludeArchive();
                const archiveParam = includeArchive ? '&include_archive=true' : '';
                const response = await fetch(`/dashboard/schedule/media.json?q=${encodeURIComponent(query)}${archiveParam}`);
                const data = await response.json();
                displayMediaResults('mediaSearchResults', data.items || []);
            } catch (e) { console.error('Media search failed:', e); }
        }, 300);
    });

    // Confirm add schedule
    document.getElementById('confirmAddSchedule')?.addEventListener('click', async function() {
        const startDateTime = getScheduleStartDateTime();
        const endDateTime = getScheduleEndDateTime();
        const activeTab = document.querySelector('#sourceTypeTabs .nav-link.active')?.id;

        // Validate times
        if (endDateTime <= startDateTime) {
            grimnirUtils.showToast('End time must be after start time', 'error');
            return;
        }

        let sourceType, sourceId, metadata = {};

        switch(activeTab) {
            case 'media-tab':
                const selectedMedia = document.querySelector('#mediaSearchResults .list-group-item.active');
                if (!selectedMedia) {
                    grimnirUtils.showToast('Please select a media item', 'warning');
                    return;
                }
                sourceType = 'media';
                sourceId = selectedMedia.dataset.mediaId;
                break;

            case 'playlist-tab':
                sourceId = document.getElementById('playlistSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a playlist', 'warning');
                    return;
                }
                sourceType = 'playlist';
                break;

            case 'smartblock-tab':
                sourceId = document.getElementById('smartBlockSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a smart block', 'warning');
                    return;
                }
                sourceType = 'smart_block';
                break;

            case 'clock-tab':
                sourceId = document.getElementById('clockSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a clock template', 'warning');
                    return;
                }
                sourceType = 'clock_template';
                break;

            case 'webstream-tab':
                sourceId = document.getElementById('webstreamSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a webstream', 'warning');
                    return;
                }
                sourceType = 'webstream';
                break;

            case 'live-tab':
                sourceType = 'live';
                sourceId = null;
                metadata = {
                    session_name: document.getElementById('liveSessionName').value || 'Live Session',
                    priority: parseInt(document.getElementById('livePriority').value)
                };
                break;

            case 'show-tab':
                // Handle show scheduling
                const existingShowId = document.getElementById('showSelect').value;
                const newShowName = document.getElementById('newShowName').value;

                if (!existingShowId && !newShowName) {
                    grimnirUtils.showToast('Please select or create a show', 'warning');
                    return;
                }

                // Get recurrence settings
                const showRecurrenceType = document.getElementById('recurrenceType').value;
                let showRRule = '';
                if (showRecurrenceType) {
                    showRRule = buildRRule(showRecurrenceType, startDateTime);
                }

                if (newShowName) {
                    // Create new show
                    const showData = {
                        name: newShowName,
                        description: document.getElementById('newShowDescription').value,
                        default_duration_minutes: parseInt(document.getElementById('newShowDuration').value) || 60,
                        color: document.getElementById('newShowColor').value,
                        dtstart: startDateTime.toISOString(),
                        rrule: showRRule,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    };

                    try {
                        const showResp = await fetch('/dashboard/shows/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(showData)
                        });

                        if (showResp.ok) {
                            addScheduleModal.hide();
                            calendar.refetchEvents();
                            grimnirUtils.showToast('Show created and scheduled', 'success');
                        } else {
                            const err = await showResp.json();
                            grimnirUtils.showToast(err.error || 'Failed to create show', 'error');
                        }
                    } catch (e) {
                        grimnirUtils.showToast('Failed to create show', 'error');
                    }
                    return;
                } else {
                    // Materialize instances for existing show
                    const endRange = new Date(startDateTime);
                    endRange.setDate(endRange.getDate() + 90); // 90 days

                    try {
                        const matResp = await fetch(`/dashboard/shows/${existingShowId}/materialize`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                start: startDateTime.toISOString(),
                                end: endRange.toISOString()
                            })
                        });

                        if (matResp.ok) {
                            addScheduleModal.hide();
                            calendar.refetchEvents();
                            grimnirUtils.showToast('Show instances created', 'success');
                        } else {
                            grimnirUtils.showToast('Failed to materialize show instances', 'error');
                        }
                    } catch (e) {
                        grimnirUtils.showToast('Failed to schedule show', 'error');
                    }
                    return;
                }
        }

        // Get recurrence settings
        const recurrenceType = document.getElementById('recurrenceType').value;
        let recurrenceDays = [];
        if (recurrenceType === 'custom') {
            document.querySelectorAll('#customDaysContainer input:checked').forEach(cb => {
                recurrenceDays.push(parseInt(cb.value));
            });
        }

        let recurrenceEndDate = null;
        if (recurrenceType && document.getElementById('recurrenceEndType').value === 'date') {
            recurrenceEndDate = document.getElementById('recurrenceEndDate').value;
        }

        try {
            const response = await fetch('/dashboard/schedule/entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    starts_at: startDateTime.toISOString(),
                    ends_at: endDateTime.toISOString(),
                    source_type: sourceType,
                    source_id: sourceId,
                    metadata: metadata,
                    recurrence_type: recurrenceType,
                    recurrence_days: recurrenceDays,
                    recurrence_end_date: recurrenceEndDate
                })
            });

            if (response.ok) {
                addScheduleModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast('Schedule entry added', 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to add entry', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to add entry', 'error');
        }
    });

    // Recurrence UI handlers for Add modal
    document.getElementById('recurrenceType')?.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('customDaysContainer').classList.toggle('d-none', type !== 'custom');
        document.getElementById('recurrenceEndContainer').classList.toggle('d-none', !type);
    });

    document.getElementById('recurrenceEndType')?.addEventListener('change', function() {
        document.getElementById('recurrenceEndDate').classList.toggle('d-none', this.value !== 'date');
    });

    // Recurrence UI handlers for Edit modal
    document.getElementById('editRecurrenceType')?.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('editCustomDaysContainer').classList.toggle('d-none', type !== 'custom');
        document.getElementById('editRecurrenceEndContainer').classList.toggle('d-none', !type);
    });

    document.getElementById('editRecurrenceEndType')?.addEventListener('change', function() {
        document.getElementById('editRecurrenceEndDate').classList.toggle('d-none', this.value !== 'date');
    });

    // Edit mode handlers
    document.querySelectorAll('input[name="editMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isSingle = this.value === 'single';
            document.getElementById('editRecurrenceSection').classList.toggle('d-none', isSingle);
        });
    });

    // Change source button
    document.getElementById('editChangeSourceBtn')?.addEventListener('click', function() {
        const container = document.getElementById('editSourceSelection');
        container.classList.toggle('d-none');
        if (!container.classList.contains('d-none')) {
            loadEditSourceOptions();
        }
    });

    // Edit source type change
    document.getElementById('editSourceType')?.addEventListener('change', function() {
        loadEditSourceOptions();
    });

    // Edit modal media search
    let editMediaSearchTimeout;
    document.getElementById('editMediaSearchInput')?.addEventListener('input', function(e) {
        clearTimeout(editMediaSearchTimeout);
        const query = e.target.value;
        const results = document.getElementById('editMediaSearchResults');

        if (query.length < 2) {
            results.innerHTML = '<div class="list-group-item text-body-secondary">Type at least 2 characters to search...</div>';
            return;
        }

        results.innerHTML = '<div class="list-group-item text-body-secondary">Searching...</div>';

        editMediaSearchTimeout = setTimeout(async () => {
            try {
                const editIncludeArchive = document.getElementById('editIncludeArchiveMedia')?.checked || false;
                const archiveParam = editIncludeArchive ? '&include_archive=true' : '';
                const response = await fetch(`/dashboard/schedule/media.json?q=${encodeURIComponent(query)}${archiveParam}`);
                const data = await response.json();
                results.innerHTML = '';

                if (!data.items || data.items.length === 0) {
                    results.innerHTML = '<div class="list-group-item text-body-secondary">No results found</div>';
                    return;
                }

                data.items.forEach(item => {
                    const div = document.createElement('a');
                    div.href = '#';
                    div.className = 'list-group-item list-group-item-action';
                    div.dataset.mediaId = item.id;

                    // Show station badge for archive items
                    const stationBadge = item.is_archive && item.station_name
                        ? `<span class="badge bg-info text-dark ms-1" title="From ${item.station_name}"><i class="bi bi-globe"></i></span>`
                        : '';
                    const stationInfo = item.is_archive && item.station_name
                        ? ` <span class="text-info">via ${item.station_name}</span>`
                        : '';

                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.title}</strong>${stationBadge}<br>
                                <small class="text-body-secondary">${item.artist || 'Unknown'}${stationInfo}  ${formatDuration(item.duration)}</small>
                            </div>
                            <i class="bi bi-plus-circle text-primary"></i>
                        </div>
                    `;
                    div.addEventListener('click', (e) => {
                        e.preventDefault();
                        // Deselect others
                        results.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                    });
                    results.appendChild(div);
                });
            } catch (e) {
                results.innerHTML = '<div class="list-group-item text-danger">Search failed</div>';
            }
        }, 300);
    });

    async function loadEditSourceOptions() {
        const sourceType = document.getElementById('editSourceType').value;
        const select = document.getElementById('editSourceSelect');
        const mediaSearchContainer = document.getElementById('editMediaSearchContainer');
        const selectContainer = document.getElementById('editSourceSelectContainer');

        // Reset visibility
        mediaSearchContainer.classList.add('d-none');
        selectContainer.classList.add('d-none');

        select.innerHTML = '<option value="">Loading...</option>';

        let url, dataKey, nameKey;
        switch (sourceType) {
            case 'media':
                // Show media search instead of dropdown
                mediaSearchContainer.classList.remove('d-none');
                document.getElementById('editMediaSearchInput').value = '';
                document.getElementById('editMediaSearchResults').innerHTML =
                    '<div class="list-group-item text-body-secondary">Type to search media...</div>';
                return;
            case 'playlist':
                url = '/dashboard/schedule/playlists.json';
                dataKey = 'playlists';
                nameKey = 'Name';
                break;
            case 'smart_block':
                url = '/dashboard/schedule/smart-blocks.json';
                dataKey = 'smart_blocks';
                nameKey = 'Name';
                break;
            case 'clock_template':
                url = '/dashboard/schedule/clocks.json';
                dataKey = 'clocks';
                nameKey = 'Name';
                break;
            case 'webstream':
                url = '/dashboard/schedule/webstreams.json';
                dataKey = 'webstreams';
                nameKey = 'Name';
                break;
            case 'live':
                // Live doesn't need source selection
                return;
        }

        selectContainer.classList.remove('d-none');

        try {
            const response = await fetch(url);
            const data = await response.json();
            select.innerHTML = '<option value="">Select...</option>';
            (data[dataKey] || []).forEach(item => {
                select.innerHTML += `<option value="${item.ID}">${item[nameKey]}</option>`;
            });
        } catch (e) {
            select.innerHTML = '<option value="">Error loading options</option>';
        }
    }

    function updateEvent(event) {
        fetch(`/dashboard/schedule/entries/${event.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                starts_at: event.start.toISOString(),
                ends_at: event.end.toISOString()
            })
        }).then(response => {
            if (response.ok) {
                grimnirUtils.showToast('Schedule updated', 'success');
            } else {
                calendar.refetchEvents();
                grimnirUtils.showToast('Failed to update', 'error');
            }
        });
    }

    function deleteEvent(event) {
        if (!confirm('Delete this schedule entry?')) return;

        fetch(`/dashboard/schedule/entries/${event.id}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                event.remove();
                eventModal.hide();
                grimnirUtils.showToast('Entry deleted', 'success');
            }
        });
    }

    async function duplicateEvent(event) {
        try {
            const response = await fetch(`/dashboard/schedule/entries/${event.id}/duplicate`, {
                method: 'POST'
            });
            if (response.ok) {
                calendar.refetchEvents();
                grimnirUtils.showToast('Event duplicated', 'success');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to duplicate', 'error');
        }
    }

    // Edit modal functions
    function openEditModal(event) {
        const props = event.extendedProps;
        const startDate = event.start;
        const endDate = event.end;

        // Store event ID
        document.getElementById('editEntryId').value = event.id;

        // Reset source selection
        document.getElementById('editSourceSelection').classList.add('d-none');

        // Set type badge and name
        const typeColors = {
            'media': 'bg-primary',
            'playlist': 'bg-success',
            'smart_block': 'bg-info',
            'clock_template': 'bg-purple',
            'live': 'bg-danger',
            'webstream': 'bg-warning text-dark'
        };
        const badge = document.getElementById('editEntryTypeBadge');
        badge.className = 'badge ' + (typeColors[props.source_type] || 'bg-secondary');
        badge.textContent = props.source_label || props.source_type;

        document.getElementById('editEntryName').textContent = props.source_name || event.title;

        // Show/hide orphaned source warning
        const orphanWarning = document.getElementById('editOrphanedWarning');
        if (props.orphaned) {
            orphanWarning.classList.remove('d-none');
            badge.className = 'badge bg-danger';
            badge.textContent = 'MISSING ' + (props.source_label || props.source_type);
        } else {
            orphanWarning.classList.add('d-none');
        }

        // Populate crossfade controls from metadata (if present)
        const md = props.metadata || {};
        const cf = md.crossfade || {};
        const override = !!cf.override;
        const overrideEl = document.getElementById('editCrossfadeOverride');
        if (overrideEl) overrideEl.checked = override;
        const enabledEl = document.getElementById('editCrossfadeEnabled');
        if (enabledEl) enabledEl.value = (typeof cf.enabled === 'string') ? cf.enabled : 'inherit';
        const durEl = document.getElementById('editCrossfadeDurationMs');
        if (durEl) durEl.value = (typeof cf.duration_ms === 'number') ? cf.duration_ms : 0;
        updateEditCrossfadeUI();

        // Store source type/id for potential changes
        document.getElementById('editSourceType').value = props.source_type;

        // Check if recurring
        const isRecurring = props.recurrence && props.recurrence.type;
        const isInstance = props.is_instance;
        document.getElementById('editIsRecurring').value = isRecurring ? 'true' : 'false';

        // Show/hide recurring notice
        const recurringNotice = document.getElementById('editRecurringNotice');
        if (isRecurring || isInstance) {
            recurringNotice.classList.remove('d-none');
            document.getElementById('editModeAll').checked = true;
            document.getElementById('editRecurrenceSection').classList.remove('d-none');
        } else {
            recurringNotice.classList.add('d-none');
        }

        // Set recurrence fields
        if (props.recurrence) {
            document.getElementById('editRecurrenceType').value = props.recurrence.type || '';

            // Show/hide containers based on type
            document.getElementById('editCustomDaysContainer').classList.toggle('d-none', props.recurrence.type !== 'custom');
            document.getElementById('editRecurrenceEndContainer').classList.toggle('d-none', !props.recurrence.type);

            // Set custom days
            if (props.recurrence.days) {
                document.querySelectorAll('#editCustomDaysContainer input').forEach(cb => {
                    cb.checked = props.recurrence.days.includes(parseInt(cb.value));
                });
            }

            // Set end date
            if (props.recurrence.end_date) {
                document.getElementById('editRecurrenceEndType').value = 'date';
                document.getElementById('editRecurrenceEndDate').value = props.recurrence.end_date;
                document.getElementById('editRecurrenceEndDate').classList.remove('d-none');
            } else {
                document.getElementById('editRecurrenceEndType').value = 'never';
                document.getElementById('editRecurrenceEndDate').classList.add('d-none');
            }
        } else {
            document.getElementById('editRecurrenceType').value = '';
            document.getElementById('editCustomDaysContainer').classList.add('d-none');
            document.getElementById('editRecurrenceEndContainer').classList.add('d-none');
        }

        // Set date inputs
        document.getElementById('editStartDate').value = formatDateOnly(startDate);
        document.getElementById('editEndDate').value = formatDateOnly(endDate);

        // Set time inputs
        document.getElementById('editStartHour').value = startDate.getHours();
        const startMin = Math.round(startDate.getMinutes() / 5) * 5;
        document.getElementById('editStartMinute').value = startMin >= 60 ? 55 : startMin;

        document.getElementById('editEndHour').value = endDate.getHours();
        const endMin = Math.round(endDate.getMinutes() / 5) * 5;
        document.getElementById('editEndMinute').value = endMin >= 60 ? 55 : endMin;

        updateEditDurationDisplay();
        editScheduleModal.show();
    }

    function getEditStartDateTime() {
        const date = document.getElementById('editStartDate').value;
        const hour = parseInt(document.getElementById('editStartHour').value);
        const minute = parseInt(document.getElementById('editStartMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function getEditEndDateTime() {
        const date = document.getElementById('editEndDate').value;
        const hour = parseInt(document.getElementById('editEndHour').value);
        const minute = parseInt(document.getElementById('editEndMinute').value);
        return new Date(`${date}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`);
    }

    function updateEditDurationDisplay() {
        const start = getEditStartDateTime();
        const end = getEditEndDateTime();
        const durationMs = end - start;

        if (durationMs <= 0) {
            document.getElementById('editDurationText').textContent = 'Invalid: End time must be after start time';
            document.getElementById('editDurationDisplay').classList.remove('alert-info');
            document.getElementById('editDurationDisplay').classList.add('alert-danger');
            return;
        }

        document.getElementById('editDurationDisplay').classList.remove('alert-danger');
        document.getElementById('editDurationDisplay').classList.add('alert-info');

        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));

        let text = 'Duration: ';
        if (hours > 0) text += `${hours}h `;
        if (minutes > 0 || hours === 0) text += `${minutes}m`;

        document.getElementById('editDurationText').textContent = text.trim();
    }

    // Edit modal time change listeners
    ['editStartDate', 'editStartHour', 'editStartMinute',
     'editEndDate', 'editEndHour', 'editEndMinute'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateEditDurationDisplay);
    });

    // Confirm edit
    document.getElementById('confirmEditSchedule')?.addEventListener('click', async function() {
        const entryId = document.getElementById('editEntryId').value;
        const startDateTime = getEditStartDateTime();
        const endDateTime = getEditEndDateTime();

        if (endDateTime <= startDateTime) {
            grimnirUtils.showToast('End time must be after start time', 'error');
            return;
        }

        // Build update payload
        const payload = {
            starts_at: startDateTime.toISOString(),
            ends_at: endDateTime.toISOString()
        };

        // Check if source changed
        const sourceSelection = document.getElementById('editSourceSelection');
        if (!sourceSelection.classList.contains('d-none')) {
            const newSourceType = document.getElementById('editSourceType').value;
            let newSourceId;

            if (newSourceType === 'media') {
                // Get selected media from search results
                const selectedMedia = document.querySelector('#editMediaSearchResults .list-group-item.active');
                if (selectedMedia) {
                    newSourceId = selectedMedia.dataset.mediaId;
                }
            } else if (newSourceType !== 'live') {
                newSourceId = document.getElementById('editSourceSelect').value;
            }

            if (newSourceId) {
                payload.source_type = newSourceType;
                payload.source_id = newSourceId;
            } else if (newSourceType === 'live') {
                payload.source_type = 'live';
                payload.source_id = '';
            }
        }

        // Get edit mode for recurring events
        const isRecurring = document.getElementById('editIsRecurring').value === 'true';
        if (isRecurring) {
            payload.edit_mode = document.querySelector('input[name="editMode"]:checked')?.value || 'all';
        }

        // Get recurrence settings (only if editing all occurrences)
        if (!isRecurring || payload.edit_mode === 'all') {
            const recurrenceType = document.getElementById('editRecurrenceType').value;
            payload.recurrence_type = recurrenceType;

            if (recurrenceType === 'custom') {
                const days = [];
                document.querySelectorAll('#editCustomDaysContainer input:checked').forEach(cb => {
                    days.push(parseInt(cb.value));
                });
                payload.recurrence_days = days;
            }

            if (recurrenceType && document.getElementById('editRecurrenceEndType').value === 'date') {
                payload.recurrence_end_date = document.getElementById('editRecurrenceEndDate').value;
            } else {
                payload.recurrence_end_date = '';
            }
        }

        // Crossfade override (stored in metadata.crossfade)
        const baseMetadata = (selectedEvent && selectedEvent.extendedProps && selectedEvent.extendedProps.metadata)
            ? JSON.parse(JSON.stringify(selectedEvent.extendedProps.metadata))
            : {};

        const override = document.getElementById('editCrossfadeOverride')?.checked;
        if (override) {
            const enabledSel = document.getElementById('editCrossfadeEnabled')?.value || 'inherit';
            const durMs = parseInt(document.getElementById('editCrossfadeDurationMs')?.value || '0', 10) || 0;
            baseMetadata.crossfade = {
                override: true,
                enabled: enabledSel,
                duration_ms: Math.max(0, Math.min(30000, durMs))
            };
        } else {
            if (baseMetadata && baseMetadata.crossfade) {
                delete baseMetadata.crossfade;
            }
        }
        payload.metadata = baseMetadata;
        if (selectedEvent && selectedEvent.extendedProps) {
            selectedEvent.setExtendedProp('metadata', baseMetadata);
        }

        try {
            const response = await fetch(`/dashboard/schedule/entries/${entryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                editScheduleModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast('Schedule entry updated', 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to update entry', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to update entry', 'error');
        }
    });

    // Crossfade UI toggle
    function updateEditCrossfadeUI() {
        const override = document.getElementById('editCrossfadeOverride');
        const fields = document.getElementById('editCrossfadeFields');
        if (!override || !fields) return;
        fields.querySelectorAll('input,select').forEach(el => {
            el.disabled = !override.checked;
        });
    }
    document.getElementById('editCrossfadeOverride')?.addEventListener('change', updateEditCrossfadeUI);

    // Delete from edit modal
    document.getElementById('editDeleteBtn')?.addEventListener('click', function() {
        const entryId = document.getElementById('editEntryId').value;
        if (!confirm('Delete this schedule entry?')) return;

        fetch(`/dashboard/schedule/entries/${entryId}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                editScheduleModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast('Entry deleted', 'success');
            } else {
                grimnirUtils.showToast('Failed to delete entry', 'error');
            }
        });
    });

    // Mount filter
    mountFilter.addEventListener('change', () => {
        calendar.refetchEvents();
    });

    // Delete event button in modal
    document.getElementById('deleteEventBtn')?.addEventListener('click', () => {
        if (selectedEvent) deleteEvent(selectedEvent);
    });

    // Edit event button in modal
    document.getElementById('editEventBtn')?.addEventListener('click', () => {
        if (selectedEvent) {
            eventModal.hide();
            openEditModal(selectedEvent);
        }
    });

    // WebSocket updates
    window.grimnirWS.on('schedule_update', () => {
        calendar.refetchEvents();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // N - New entry (if time selected)
        if (e.key === 'n' && selectedTimeRange) {
            openAddScheduleModal(selectedTimeRange.start, selectedTimeRange.end);
        }

        // Delete/Backspace - Delete selected event
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedEvent) {
            const props = selectedEvent.extendedProps;
            if (props.type === 'show') {
                cancelShowInstance(selectedEvent);
            } else {
                deleteEvent(selectedEvent);
            }
        }

        // Escape - Deselect and close menus
        if (e.key === 'Escape') {
            hideAllContextMenus();
            calendar.unselect();
            selectedEvent = null;
            selectedTimeRange = null;
        }
    });

    // ===== Show Functions =====

    // Load shows for dropdown
    async function loadShows() {
        try {
            const response = await fetch('/dashboard/shows/?active=true');
            const data = await response.json();
            const select = document.getElementById('showSelect');
            select.innerHTML = '<option value="">Select a show...</option>';
            (data.shows || []).forEach(show => {
                select.innerHTML += `<option value="${show.ID}">${show.Name}</option>`;
            });
        } catch (e) {
            console.error('Failed to load shows:', e);
        }
    }

    // Build RRULE from recurrence settings
    function buildRRule(recurrenceType, startDate) {
        const dayMap = {0: 'SU', 1: 'MO', 2: 'TU', 3: 'WE', 4: 'TH', 5: 'FR', 6: 'SA'};
        const startDay = dayMap[startDate.getDay()];

        switch (recurrenceType) {
            case 'daily':
                return 'FREQ=DAILY';
            case 'weekdays':
                return 'FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR';
            case 'weekly':
                return `FREQ=WEEKLY;BYDAY=${startDay}`;
            case 'custom':
                const days = [];
                document.querySelectorAll('#customDaysContainer input:checked').forEach(cb => {
                    days.push(dayMap[parseInt(cb.value)]);
                });
                if (days.length === 0) return '';
                return `FREQ=WEEKLY;BYDAY=${days.join(',')}`;
            default:
                return '';
        }
    }

    // Show details for a show instance
    function showShowInstanceDetails(event) {
        const props = event.extendedProps;

        document.getElementById('eventModalTitle').textContent = event.title;

        let statusBadge = '';
        if (props.status === 'cancelled') {
            statusBadge = '<span class="badge bg-danger ms-2">Cancelled</span>';
        } else if (props.exception_type) {
            const exLabels = {
                'rescheduled': 'Rescheduled',
                'substitute': 'Substitute Host',
                'cancelled': 'Cancelled'
            };
            statusBadge = `<span class="badge bg-warning text-dark ms-2">${exLabels[props.exception_type] || props.exception_type}</span>`;
        }

        let body = `
            <dl class="row mb-0">
                <dt class="col-4">Type</dt>
                <dd class="col-8"><span class="badge bg-pink">Show</span>${statusBadge}</dd>

                <dt class="col-4">Start</dt>
                <dd class="col-8">${event.start.toLocaleString()}</dd>

                <dt class="col-4">End</dt>
                <dd class="col-8">${event.end.toLocaleString()}</dd>

                <dt class="col-4">Duration</dt>
                <dd class="col-8">${formatDuration((event.end - event.start) / 1000)}</dd>
        `;

        if (props.host_name) {
            body += `<dt class="col-4">Host</dt><dd class="col-8">${props.host_name}</dd>`;
        }

        if (props.exception_note) {
            body += `<dt class="col-4">Note</dt><dd class="col-8">${props.exception_note}</dd>`;
        }

        if (props.is_virtual) {
            body += `<dt class="col-4 text-body-secondary">Status</dt><dd class="col-8 text-body-secondary"><em>Not yet materialized</em></dd>`;
        }

        body += '</dl>';
        document.getElementById('eventModalBody').innerHTML = body;
        eventModal.show();
    }

    // Update a show instance (drag/resize)
    function updateShowInstance(event) {
        const props = event.extendedProps;
        const instanceId = props.instance_id;

        fetch(`/dashboard/shows/instances/${instanceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                starts_at: event.start.toISOString(),
                ends_at: event.end.toISOString()
            })
        }).then(response => {
            if (response.ok) {
                grimnirUtils.showToast('Show instance updated', 'success');
            } else {
                calendar.refetchEvents();
                grimnirUtils.showToast('Failed to update show instance', 'error');
            }
        }).catch(() => {
            calendar.refetchEvents();
            grimnirUtils.showToast('Failed to update show instance', 'error');
        });
    }

    // Cancel a show instance
    function cancelShowInstance(event) {
        const props = event.extendedProps;
        const instanceId = props.instance_id;

        if (!confirm('Cancel this show instance?')) return;

        fetch(`/dashboard/shows/instances/${instanceId}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                calendar.refetchEvents();
                eventModal.hide();
                grimnirUtils.showToast('Show instance cancelled', 'success');
            } else {
                grimnirUtils.showToast('Failed to cancel show instance', 'error');
            }
        }).catch(() => {
            grimnirUtils.showToast('Failed to cancel show instance', 'error');
        });
    }

    // ===== Schedule Validation =====

    const validationModal = new bootstrap.Modal(document.getElementById('validationModal'));
    const stationID = '{{.Data.StationID}}';
    const canManageIRT = {{if roleAtLeast .User "manager"}}true{{else}}false{{end}};
    let irtRefreshTimer = null;
    let pendingEditEntryId = new URLSearchParams(window.location.search).get('edit_entry');

    // Validate schedule button
    document.getElementById('validateScheduleBtn')?.addEventListener('click', function() {
        validationModal.show();
        runValidation();
    });
    document.getElementById('irtRefreshBtn')?.addEventListener('click', refreshIRTPanel);

    // Re-validate button
    document.getElementById('revalidateBtn')?.addEventListener('click', function() {
        runValidation();
    });

    async function runValidation() {
        const loadingEl = document.getElementById('validationLoading');
        const resultsEl = document.getElementById('validationResults');

        loadingEl.classList.remove('d-none');
        resultsEl.classList.add('d-none');

        // Get current calendar view range or default to next 7 days
        const view = calendar.view;
        let start = view.activeStart || new Date();
        let end = view.activeEnd || new Date(start.getTime() + 7 * 24 * 60 * 60 * 1000);

        try {
            const response = await fetch(`/dashboard/schedule/validate?start=${start.toISOString()}&end=${end.toISOString()}`);
            if (!response.ok) {
                throw new Error('Validation failed');
            }
            const result = await response.json();
            displayValidationResults(result);
        } catch (e) {
            console.error('Validation error:', e);
            applyOverlapHighlights([]);
            loadingEl.classList.add('d-none');
            resultsEl.classList.remove('d-none');
            document.getElementById('errorsContainer').innerHTML =
                '<div class="validation-result-item error">Failed to validate schedule. Please try again.</div>';
            document.getElementById('errorsList').classList.remove('d-none');
        }
    }

    function displayValidationResults(result) {
        const loadingEl = document.getElementById('validationLoading');
        const resultsEl = document.getElementById('validationResults');

        loadingEl.classList.add('d-none');
        resultsEl.classList.remove('d-none');

        // Update status badge
        const statusBadge = document.getElementById('validStatusBadge');
        if (result.valid) {
            statusBadge.textContent = 'Valid';
            statusBadge.className = 'badge bg-success me-1';
        } else {
            statusBadge.textContent = 'Issues Found';
            statusBadge.className = 'badge bg-danger me-1';
        }

        // Update checked time and range
        document.getElementById('validationCheckedAt').textContent =
            new Date(result.checked_at).toLocaleString();
        document.getElementById('validationRange').textContent =
            `${new Date(result.range_start).toLocaleDateString()} - ${new Date(result.range_end).toLocaleDateString()}`;

        // Update counts
        const errors = result.errors || [];
        const warnings = result.warnings || [];
        const info = result.info || [];
        applyOverlapHighlights(errors);

        document.getElementById('errorCount').textContent = errors.length;
        document.getElementById('warningCount').textContent = warnings.length;
        document.getElementById('infoCount').textContent = info.length;

        // Update validation badge in toolbar
        const badge = document.getElementById('validationBadge');
        const totalIssues = errors.length + warnings.length;
        if (totalIssues > 0) {
            badge.textContent = totalIssues;
            badge.classList.remove('d-none');
            badge.className = errors.length > 0 ? 'badge bg-danger validation-badge' : 'badge bg-warning validation-badge';
        } else {
            badge.classList.add('d-none');
        }

        // Display errors
        const errorsListEl = document.getElementById('errorsList');
        const errorsContainer = document.getElementById('errorsContainer');
        if (errors.length > 0) {
            errorsListEl.classList.remove('d-none');
            errorsContainer.innerHTML = errors.map(v => renderViolation(v, 'error')).join('');
        } else {
            errorsListEl.classList.add('d-none');
        }

        // Display warnings
        const warningsListEl = document.getElementById('warningsList');
        const warningsContainer = document.getElementById('warningsContainer');
        if (warnings.length > 0) {
            warningsListEl.classList.remove('d-none');
            warningsContainer.innerHTML = warnings.map(v => renderViolation(v, 'warning')).join('');
        } else {
            warningsListEl.classList.add('d-none');
        }

        // Display info
        const infoListEl = document.getElementById('infoList');
        const infoContainer = document.getElementById('infoContainer');
        if (info.length > 0) {
            infoListEl.classList.remove('d-none');
            infoContainer.innerHTML = info.map(v => renderViolation(v, 'info')).join('');
        } else {
            infoListEl.classList.add('d-none');
        }

        // Show all-valid message
        const allValidMsg = document.getElementById('allValidMessage');
        if (errors.length === 0 && warnings.length === 0 && info.length === 0) {
            allValidMsg.classList.remove('d-none');
        } else {
            allValidMsg.classList.add('d-none');
        }
    }

    function renderViolation(violation, severity) {
        const ruleTypeLabels = {
            'overlap': 'Overlap',
            'gap': 'Gap',
            'dj_double_booking': 'Double Booking',
            'min_duration': 'Min Duration',
            'max_duration': 'Max Duration',
            'max_consecutive': 'Max Consecutive',
            'station_id_interval': 'Station ID',
            'content_restriction': 'Content Restriction',
            'required_break': 'Required Break'
        };

        const ruleLabel = ruleTypeLabels[violation.rule_type] || violation.rule_type;
        const startTime = new Date(violation.starts_at).toLocaleString();
        const endTime = new Date(violation.ends_at).toLocaleString();

        return `
            <div class="validation-result-item ${severity}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${violation.rule_name || ruleLabel}</strong>
                        <span class="badge bg-secondary ms-1">${ruleLabel}</span>
                    </div>
                    <small class="text-body-secondary">${startTime}</small>
                </div>
                <p class="mb-1 mt-1">${violation.message}</p>
                <small class="text-body-secondary">
                    <i class="bi bi-clock me-1"></i>${startTime} - ${endTime}
                </small>
                ${renderViolationDetails(violation)}
            </div>
        `;
    }

    function applyOverlapHighlights(errors) {
        const nextIDs = new Set();
        errors.filter(v => v.rule_type === 'overlap').forEach(v => {
            (v.affected_ids || []).forEach(id => nextIDs.add(id));
        });
        overlapEventIDs = nextIDs;
        calendar.getEvents().forEach(event => {
            event.setExtendedProp('overlap_highlight', overlapEventIDs.has(event.id));
        });
    }

    function renderViolationDetails(violation) {
        if (!violation || !violation.details) return '';
        const details = violation.details;

        if (violation.rule_type === 'overlap') {
            const itemA = details.item_a || {};
            const itemB = details.item_b || {};
            const overlapMinutes = details.overlap_minutes;
            const overlapStart = details.overlap_start ? new Date(details.overlap_start).toLocaleString() : null;
            const overlapEnd = details.overlap_end ? new Date(details.overlap_end).toLocaleString() : null;
            return `
                <ul class="validation-detail-list small text-body-secondary">
                    <li><strong>Conflicting item A:</strong> ${renderConflictItemLink(itemA)}</li>
                    <li><strong>Conflicting item B:</strong> ${renderConflictItemLink(itemB)}</li>
                    ${overlapStart && overlapEnd ? `<li><strong>Overlap window:</strong> ${overlapStart} to ${overlapEnd}</li>` : ''}
                    ${overlapMinutes != null ? `<li><strong>Overlap duration:</strong> ${overlapMinutes} minute(s)</li>` : ''}
                    <li><strong>How to fix:</strong> Move or shorten one of these items so they no longer overlap.</li>
                </ul>
            `;
        }
        return '';
    }

    function renderConflictItemLink(item) {
        if (!item) return 'Unknown';
        const label = escapeHtml(item.label || item.id || 'Unknown');
        if (!item.id) return label;
        const itemType = (item.type || '').replace(/'/g, '');
        const itemID = String(item.id).replace(/'/g, '');
        const startsAt = item.starts_at ? String(item.starts_at).replace(/'/g, '') : '';
        return `
            <button type="button" class="btn btn-link btn-sm p-0 align-baseline"
                onclick="openConflictItem('${itemID}', '${itemType}', '${startsAt}')">
                ${label}
            </button>
        `;
    }

    // Auto-validate on calendar date change (optional, runs in background)
    calendar.on('datesSet', function(info) {
        // Silently update validation badge after a delay
        setTimeout(async () => {
            try {
                const response = await fetch(`/dashboard/schedule/validate?start=${info.startStr}&end=${info.endStr}`);
                if (response.ok) {
                    const result = await response.json();
                    const badge = document.getElementById('validationBadge');
                    const errors = (result.errors || []).length;
                    const warnings = (result.warnings || []).length;
                    const totalIssues = errors + warnings;
                    if (totalIssues > 0) {
                        badge.textContent = totalIssues;
                        badge.classList.remove('d-none');
                        badge.className = errors > 0 ? 'badge bg-danger validation-badge' : 'badge bg-warning validation-badge';
                    } else {
                        badge.classList.add('d-none');
                    }
                }
            } catch (e) {
                // Silent fail for background validation
            }
        }, 1000);
    });

    async function refreshIRTPanel() {
        const nowPlayingEl = document.getElementById('irtNowPlaying');
        const upcomingEl = document.getElementById('irtUpcomingList');
        if (!nowPlayingEl || !upcomingEl) return;

        try {
            const now = new Date();
            const start = new Date(now.getTime() - 5 * 60 * 1000);
            const end = new Date(now.getTime() + 24 * 60 * 60 * 1000);

            const [npResp, eventsResp] = await Promise.all([
                fetch(`/api/v1/analytics/now-playing?station_id=${stationID}`),
                fetch(`/dashboard/schedule/events?start=${start.toISOString()}&end=${end.toISOString()}`),
            ]);
            const np = npResp.ok ? await npResp.json() : { status: 'idle' };
            const entries = eventsResp.ok ? await eventsResp.json() : [];

            nowPlayingEl.innerHTML = renderNowPlaying(np);
            upcomingEl.innerHTML = renderIRTEntries(entries);

            if (pendingEditEntryId) {
                openEntryForEdit(pendingEditEntryId);
            }
        } catch (err) {
            nowPlayingEl.innerHTML = '<span class="text-danger">Failed to load IRT state.</span>';
        }
    }

    function renderNowPlaying(np) {
        if (!np || np.status !== 'playing') {
            return '<i class="bi bi-music-note me-1"></i>No active playback right now.';
        }
        const source = np.is_live_dj ? 'Live DJ' : 'Automation';
        const title = escapeHtml(np.title || 'Unknown Title');
        const artist = escapeHtml(np.artist || 'Unknown Artist');
        return `
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="fw-semibold">${artist} - ${title}</div>
                    <small class="text-body-secondary">${source}</small>
                </div>
                <span class="badge bg-success">LIVE</span>
            </div>
        `;
    }

    function renderIRTEntries(entries) {
        const now = new Date();
        const sorted = (entries || []).slice().sort((a, b) => new Date(a.start) - new Date(b.start));
        if (sorted.length === 0) {
            return '<div class="text-body-secondary small">No scheduled entries found in the near window.</div>';
        }

        const nowEntry = sorted.find(entry => {
            const start = new Date(entry.start);
            const end = new Date(entry.end);
            return start <= now && end > now;
        });
        const nextEntry = sorted.find(entry => new Date(entry.start) > now);

        const summaryEntries = [];
        if (nowEntry) summaryEntries.push({ entry: nowEntry, tag: 'NOW', tagClass: 'bg-danger' });
        if (nextEntry) summaryEntries.push({ entry: nextEntry, tag: 'NEXT', tagClass: 'bg-primary' });
        if (summaryEntries.length === 0) {
            return '<div class="text-body-secondary small">No current or upcoming scheduled entries.</div>';
        }

        return summaryEntries.map(({ entry, tag, tagClass }) => {
            const start = new Date(entry.start);
            const end = new Date(entry.end);
            const title = escapeHtml(entry.title || entry.extendedProps?.source_name || 'Untitled');
            const source = escapeHtml(entry.extendedProps?.source_label || entry.extendedProps?.source_type || 'Scheduled');
            const editBtn = canManageIRT
                ? `<button class="btn btn-sm btn-outline-primary" onclick="openEntryForEdit('${entry.id}')"><i class="bi bi-pencil"></i></button>`
                : '';
            const removeBtn = canManageIRT
                ? `<button class="btn btn-sm btn-outline-danger" onclick="removeIRTEntry('${entry.id}')"><i class="bi bi-trash"></i></button>`
                : '';
            return `
                <div class="irt-item py-2 d-flex align-items-center justify-content-between gap-2">
                    <div class="flex-grow-1">
                        <div class="fw-medium">${title} <span class="badge ${tagClass} irt-now-pill">${tag}</span></div>
                        <div class="small text-body-secondary">${source}  ${start.toLocaleTimeString()} - ${end.toLocaleTimeString()}</div>
                    </div>
                    <div class="d-flex gap-1">${editBtn}${removeBtn}</div>
                </div>
            `;
        }).join('');
    }

    window.openEntryForEdit = function(entryID, targetStart = null) {
        const event = calendar.getEventById(entryID);
        if (!event) {
            pendingEditEntryId = entryID;
            if (targetStart) {
                const date = new Date(targetStart);
                if (!isNaN(date.getTime())) {
                    calendar.gotoDate(date);
                }
            }
            calendar.refetchEvents();
            return;
        }
        pendingEditEntryId = null;
        openEditModal(event);
    };

    window.openConflictItem = function(itemID, itemType, startsAt = '') {
        validationModal.hide();

        if (itemType === 'schedule_entry') {
            openEntryForEdit(itemID, startsAt);
            return;
        }

        if (itemType === 'show_instance') {
            const event = calendar.getEventById(itemID);
            if (event) {
                showShowInstanceDetails(event);
                return;
            }
            if (startsAt) {
                const date = new Date(startsAt);
                if (!isNaN(date.getTime())) {
                    calendar.gotoDate(date);
                }
            }
            calendar.refetchEvents();
            grimnirUtils.showToast('Show conflict item loaded on calendar. Click it to edit details.', 'info');
            return;
        }

        grimnirUtils.showToast('Unable to open this conflict item directly.', 'warning');
    };

    window.removeIRTEntry = async function(entryID) {
        if (!confirm('Remove this scheduled entry from the IRT list?')) return;
        try {
            const resp = await fetch(`/dashboard/schedule/entries/${entryID}`, { method: 'DELETE' });
            if (!resp.ok) throw new Error('delete_failed');
            grimnirUtils.showToast('Entry removed', 'success');
            calendar.refetchEvents();
            refreshIRTPanel();
        } catch (err) {
            grimnirUtils.showToast('Failed to remove entry', 'error');
        }
    };

    const originalRefetchEvents = calendar.refetchEvents.bind(calendar);
    calendar.refetchEvents = function() {
        originalRefetchEvents();
        setTimeout(refreshIRTPanel, 300);
    };

    refreshIRTPanel();
    irtRefreshTimer = setInterval(refreshIRTPanel, 10000);

    // ===== Template Management =====

    const saveTemplateModal = new bootstrap.Modal(document.getElementById('saveTemplateModal'));
    const loadTemplateModal = new bootstrap.Modal(document.getElementById('loadTemplateModal'));
    const versionHistoryModal = new bootstrap.Modal(document.getElementById('versionHistoryModal'));
    const versionDiffModal = new bootstrap.Modal(document.getElementById('versionDiffModal'));

    let selectedTemplateId = null;
    let selectedVersionId = null;

    // Save Template button
    document.getElementById('saveTemplateBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        // Set default dates to current week
        const view = calendar.view;
        const start = view.activeStart || new Date();
        const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
        document.getElementById('templateStartDate').value = start.toISOString().split('T')[0];
        document.getElementById('templateEndDate').value = end.toISOString().split('T')[0];
        document.getElementById('templateName').value = '';
        document.getElementById('templateDescription').value = '';
        saveTemplateModal.show();
    });

    // Confirm save template
    document.getElementById('confirmSaveTemplate')?.addEventListener('click', async function() {
        const name = document.getElementById('templateName').value.trim();
        if (!name) {
            grimnirUtils.showToast('Please enter a template name', 'error');
            return;
        }

        const data = {
            station_id: stationID,
            name: name,
            description: document.getElementById('templateDescription').value.trim(),
            start_date: document.getElementById('templateStartDate').value,
            end_date: document.getElementById('templateEndDate').value
        };

        try {
            const response = await fetch('/api/v1/schedule-templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                saveTemplateModal.hide();
                grimnirUtils.showToast('Template saved successfully', 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to save template', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to save template', 'error');
        }
    });

    // Load Template button
    document.getElementById('loadTemplateBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadTemplatesList();
        loadTemplateModal.show();
    });

    async function loadTemplatesList() {
        const loading = document.getElementById('templateListLoading');
        const empty = document.getElementById('templateListEmpty');
        const list = document.getElementById('templateList');
        const items = document.getElementById('templateListItems');
        const applySection = document.getElementById('applyTemplateSection');
        const applyHr = document.getElementById('applyTemplateHr');

        loading.classList.remove('d-none');
        empty.classList.add('d-none');
        list.classList.add('d-none');
        applySection.classList.add('d-none');
        applyHr.classList.add('d-none');
        document.getElementById('confirmApplyTemplate').classList.add('d-none');
        document.getElementById('deleteTemplateBtn').classList.add('d-none');
        selectedTemplateId = null;

        try {
            const response = await fetch(`/api/v1/schedule-templates?station_id=${stationID}`);
            const data = await response.json();
            const templates = data.templates || [];

            loading.classList.add('d-none');

            if (templates.length === 0) {
                empty.classList.remove('d-none');
                return;
            }

            items.innerHTML = templates.map(t => `
                <a href="#" class="list-group-item list-group-item-action template-item" data-id="${t.id}" data-name="${t.name}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${t.name}</strong>
                            ${t.description ? `<br><small class="text-body-secondary">${t.description}</small>` : ''}
                        </div>
                        <small class="text-body-secondary">${new Date(t.created_at).toLocaleDateString()}</small>
                    </div>
                </a>
            `).join('');

            list.classList.remove('d-none');

            // Add click handlers
            items.querySelectorAll('.template-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    items.querySelectorAll('.template-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    selectedTemplateId = this.dataset.id;
                    document.getElementById('selectedTemplateName').textContent = this.dataset.name;
                    applySection.classList.remove('d-none');
                    applyHr.classList.remove('d-none');
                    document.getElementById('confirmApplyTemplate').classList.remove('d-none');
                    document.getElementById('deleteTemplateBtn').classList.remove('d-none');
                    // Set default target date to next week
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7 - nextWeek.getDay());
                    document.getElementById('applyTargetDate').value = nextWeek.toISOString().split('T')[0];
                });
            });
        } catch (e) {
            loading.classList.add('d-none');
            empty.classList.remove('d-none');
        }
    }

    // Apply template
    document.getElementById('confirmApplyTemplate')?.addEventListener('click', async function() {
        if (!selectedTemplateId) return;

        const targetDate = document.getElementById('applyTargetDate').value;
        if (!targetDate) {
            grimnirUtils.showToast('Please select a target date', 'error');
            return;
        }

        const data = {
            target_date: targetDate,
            clear_existing: document.getElementById('clearExisting').checked
        };

        try {
            const response = await fetch(`/api/v1/schedule-templates/${selectedTemplateId}/apply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                loadTemplateModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast(`Template applied: ${result.created} entries created`, 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to apply template', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to apply template', 'error');
        }
    });

    // Delete template
    document.getElementById('deleteTemplateBtn')?.addEventListener('click', async function() {
        if (!selectedTemplateId) return;
        if (!confirm('Delete this template?')) return;

        try {
            const response = await fetch(`/api/v1/schedule-templates/${selectedTemplateId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                grimnirUtils.showToast('Template deleted', 'success');
                loadTemplatesList();
            } else {
                grimnirUtils.showToast('Failed to delete template', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to delete template', 'error');
        }
    });

    // ===== Version History =====

    document.getElementById('viewHistoryBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadVersionsList();
        versionHistoryModal.show();
    });

    async function loadVersionsList() {
        const loading = document.getElementById('versionListLoading');
        const empty = document.getElementById('versionListEmpty');
        const list = document.getElementById('versionList');
        const items = document.getElementById('versionListItems');

        loading.classList.remove('d-none');
        empty.classList.add('d-none');
        list.classList.add('d-none');

        try {
            const response = await fetch(`/api/v1/schedule/versions?station_id=${stationID}&limit=20`);
            const data = await response.json();
            const versions = data.versions || [];

            loading.classList.add('d-none');

            if (versions.length === 0) {
                empty.classList.remove('d-none');
                return;
            }

            items.innerHTML = versions.map(v => `
                <tr>
                    <td><strong>v${v.version_number}</strong></td>
                    <td>
                        <span class="badge bg-secondary">${v.change_type || 'change'}</span>
                        ${v.change_summary || ''}
                    </td>
                    <td>${v.changed_by?.email || 'System'}</td>
                    <td>${new Date(v.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-diff-btn" data-id="${v.id}" data-version="${v.version_number}">
                            <i class="bi bi-file-diff"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            list.classList.remove('d-none');

            // Add click handlers for diff buttons
            items.querySelectorAll('.view-diff-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectedVersionId = this.dataset.id;
                    viewVersionDiff(this.dataset.id, this.dataset.version);
                });
            });
        } catch (e) {
            loading.classList.add('d-none');
            empty.classList.remove('d-none');
        }
    }

    async function viewVersionDiff(versionId, versionNumber) {
        const loading = document.getElementById('diffLoading');
        const content = document.getElementById('diffContent');
        const restoreBtn = document.getElementById('restoreVersionBtn');

        loading.classList.remove('d-none');
        content.classList.add('d-none');
        restoreBtn.classList.add('d-none');

        versionHistoryModal.hide();
        versionDiffModal.show();

        try {
            const response = await fetch(`/api/v1/schedule/versions/${versionId}/diff`);
            const diff = await response.json();

            loading.classList.add('d-none');
            content.classList.remove('d-none');
            restoreBtn.classList.remove('d-none');

            document.getElementById('diffFromVersion').textContent = diff.from_version || '0';
            document.getElementById('diffToVersion').textContent = diff.to_version;

            const added = diff.added || [];
            const removed = diff.removed || [];
            const modified = diff.modified || [];

            document.getElementById('diffAddedCount').textContent = added.length;
            document.getElementById('diffRemovedCount').textContent = removed.length;
            document.getElementById('diffModifiedCount').textContent = modified.length;

            document.getElementById('diffAddedList').innerHTML = added.length === 0
                ? '<p class="text-body-secondary small m-0">None</p>'
                : added.map(e => `<div class="small mb-1">${e.source_type}: ${new Date(e.starts_at).toLocaleString()}</div>`).join('');

            document.getElementById('diffRemovedList').innerHTML = removed.length === 0
                ? '<p class="text-body-secondary small m-0">None</p>'
                : removed.map(e => `<div class="small mb-1">${e.source_type}: ${new Date(e.starts_at).toLocaleString()}</div>`).join('');

            document.getElementById('diffModifiedList').innerHTML = modified.length === 0
                ? '<p class="text-body-secondary small m-0">None</p>'
                : modified.map(e => `<div class="small mb-1">${e.after.source_type}: ${new Date(e.after.starts_at).toLocaleString()}</div>`).join('');

        } catch (e) {
            loading.classList.add('d-none');
            content.innerHTML = '<div class="alert alert-danger">Failed to load diff</div>';
            content.classList.remove('d-none');
        }
    }

    // Restore version
    document.getElementById('restoreVersionBtn')?.addEventListener('click', async function() {
        if (!selectedVersionId) return;
        if (!confirm('Restore to this version? This will replace current schedule entries.')) return;

        try {
            const response = await fetch(`/api/v1/schedule/versions/${selectedVersionId}/restore`, {
                method: 'POST'
            });

            if (response.ok) {
                const result = await response.json();
                versionDiffModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast(`Restored to v${result.version}: ${result.restored} entries`, 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to restore version', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to restore version', 'error');
        }
    });
});
</script>
{{end}}
