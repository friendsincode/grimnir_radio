{{define "pages/dashboard/schedule/calendar"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "head"}}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet"
      onerror="this.onerror=null;this.href='/static/css/fullcalendar.min.css';">
<style>
    #calendar {
        height: calc(100vh - 200px);
        min-height: 500px;
    }
    .fc-event {
        cursor: pointer;
        font-size: 0.85rem;
    }
    .fc-timegrid-slot {
        height: 2em;
    }
    /* Context Menu */
    .context-menu {
        position: fixed;
        z-index: 9999;
        min-width: 180px;
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        padding: 0.5rem 0;
        display: none;
    }
    .context-menu.show {
        display: block;
    }
    .context-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--bs-body-color);
        font-size: 0.875rem;
        transition: background 0.15s;
    }
    .context-menu-item:hover {
        background: var(--bs-tertiary-bg);
    }
    .context-menu-item i {
        width: 1.25rem;
        text-align: center;
        color: var(--bs-secondary);
    }
    .context-menu-item.danger {
        color: var(--bs-danger);
    }
    .context-menu-item.danger i {
        color: var(--bs-danger);
    }
    .context-menu-divider {
        border-top: 1px solid var(--bs-border-color);
        margin: 0.5rem 0;
    }
    /* Selection highlight */
    .fc-highlight {
        background: rgba(var(--bs-primary-rgb), 0.2) !important;
    }
    /* Source type colors */
    .fc-event.event-media { background: var(--bs-primary) !important; border-color: var(--bs-primary) !important; }
    .fc-event.event-playlist { background: var(--bs-success) !important; border-color: var(--bs-success) !important; }
    .fc-event.event-smart_block { background: var(--bs-info) !important; border-color: var(--bs-info) !important; }
    .fc-event.event-live { background: var(--bs-danger) !important; border-color: var(--bs-danger) !important; }
    .fc-event.event-webstream { background: var(--bs-warning) !important; border-color: var(--bs-warning) !important; color: var(--bs-dark) !important; }
</style>
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Schedule</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Schedule</h4>
    <div class="d-flex gap-2">
        <select class="form-select form-select-sm" id="mountFilter" style="width: 200px;">
            <option value="">All Mounts</option>
            {{range .Data.Mounts}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
        {{if roleAtLeast .User "manager"}}
        <button class="btn btn-outline-primary btn-sm"
                hx-post="/dashboard/schedule/refresh"
                hx-swap="none">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
        {{end}}
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div id="calendar"></div>
    </div>
</div>

<!-- Context Menu for Calendar -->
<div id="calendarContextMenu" class="context-menu">
    <div class="context-menu-item" data-action="add-media">
        <i class="bi bi-music-note"></i>
        <span>Add Media</span>
    </div>
    <div class="context-menu-item" data-action="add-playlist">
        <i class="bi bi-list-ul"></i>
        <span>Add Playlist</span>
    </div>
    <div class="context-menu-item" data-action="add-smartblock">
        <i class="bi bi-magic"></i>
        <span>Add Smart Block</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="add-webstream">
        <i class="bi bi-globe"></i>
        <span>Add Webstream</span>
    </div>
    <div class="context-menu-item" data-action="add-live">
        <i class="bi bi-broadcast"></i>
        <span>Schedule Live Session</span>
    </div>
</div>

<!-- Context Menu for Events -->
<div id="eventContextMenu" class="context-menu">
    <div class="context-menu-item" data-action="event-details">
        <i class="bi bi-info-circle"></i>
        <span>View Details</span>
    </div>
    <div class="context-menu-item" data-action="event-edit">
        <i class="bi bi-pencil"></i>
        <span>Edit</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="event-duplicate">
        <i class="bi bi-copy"></i>
        <span>Duplicate</span>
    </div>
    <div class="context-menu-item" data-action="event-move">
        <i class="bi bi-arrows-move"></i>
        <span>Move to...</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" data-action="event-delete">
        <i class="bi bi-trash"></i>
        <span>Delete</span>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {{if roleAtLeast .User "manager"}}
                <button type="button" class="btn btn-danger" id="deleteEventBtn">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                {{end}}
            </div>
        </div>
    </div>
</div>

<!-- Add Schedule Entry Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Add to Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addScheduleForm">
                    <input type="hidden" id="scheduleStartTime" name="starts_at">
                    <input type="hidden" id="scheduleEndTime" name="ends_at">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-control" id="scheduleStartInput" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Time</label>
                            <input type="datetime-local" class="form-control" id="scheduleEndInput" required>
                        </div>
                    </div>

                    <hr>

                    <!-- Source Type Tabs -->
                    <ul class="nav nav-tabs" id="sourceTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="media-tab" data-bs-toggle="tab" data-bs-target="#mediaPane" type="button">
                                <i class="bi bi-music-note me-1"></i>Media
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="playlist-tab" data-bs-toggle="tab" data-bs-target="#playlistPane" type="button">
                                <i class="bi bi-list-ul me-1"></i>Playlist
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="smartblock-tab" data-bs-toggle="tab" data-bs-target="#smartblockPane" type="button">
                                <i class="bi bi-magic me-1"></i>Smart Block
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="webstream-tab" data-bs-toggle="tab" data-bs-target="#webstreamPane" type="button">
                                <i class="bi bi-globe me-1"></i>Webstream
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#livePane" type="button">
                                <i class="bi bi-broadcast me-1"></i>Live
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3" id="sourceTypeTabContent">
                        <!-- Media Search -->
                        <div class="tab-pane fade show active" id="mediaPane" role="tabpanel">
                            <input type="text" class="form-control mb-3" id="mediaSearchInput"
                                   placeholder="Search media by title, artist...">
                            <div id="mediaSearchResults" class="list-group" style="max-height: 300px; overflow-y: auto;">
                                <!-- Results populated by JS -->
                            </div>
                        </div>

                        <!-- Playlist Selection -->
                        <div class="tab-pane fade" id="playlistPane" role="tabpanel">
                            <select class="form-select" id="playlistSelect">
                                <option value="">Select a playlist...</option>
                            </select>
                        </div>

                        <!-- Smart Block Selection -->
                        <div class="tab-pane fade" id="smartblockPane" role="tabpanel">
                            <select class="form-select" id="smartBlockSelect">
                                <option value="">Select a smart block...</option>
                            </select>
                        </div>

                        <!-- Webstream Selection -->
                        <div class="tab-pane fade" id="webstreamPane" role="tabpanel">
                            <select class="form-select" id="webstreamSelect">
                                <option value="">Select a webstream...</option>
                            </select>
                        </div>

                        <!-- Live Session -->
                        <div class="tab-pane fade" id="livePane" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Session Name</label>
                                <input type="text" class="form-control" id="liveSessionName" placeholder="e.g., DJ Set, Live Show">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="livePriority">
                                    <option value="0">Highest (0) - Immediate takeover</option>
                                    <option value="1">High (1) - After current track</option>
                                    <option value="2" selected>Normal (2) - Scheduled slot</option>
                                    <option value="3">Low (3) - Fallback only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddSchedule">
                    <i class="bi bi-calendar-plus me-1"></i>Add to Schedule
                </button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"
        onerror="this.onerror=null;this.src='/static/js/fullcalendar.min.js';"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const mountFilter = document.getElementById('mountFilter');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const addScheduleModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));

    // Context menu elements
    const calendarContextMenu = document.getElementById('calendarContextMenu');
    const eventContextMenu = document.getElementById('eventContextMenu');

    let selectedEvent = null;
    let selectedTimeRange = null;
    let contextMenuTarget = null;

    // Hide context menus on click outside
    document.addEventListener('click', hideAllContextMenus);
    document.addEventListener('contextmenu', (e) => {
        // Only hide if clicking outside menus
        if (!e.target.closest('.context-menu')) {
            hideAllContextMenus();
        }
    });

    function hideAllContextMenus() {
        calendarContextMenu.classList.remove('show');
        eventContextMenu.classList.remove('show');
    }

    function showContextMenu(menu, x, y) {
        hideAllContextMenus();
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';

        // Ensure menu stays within viewport
        const rect = menu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            menu.style.left = (x - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            menu.style.top = (y - rect.height) + 'px';
        }

        menu.classList.add('show');
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        slotDuration: '00:15:00',
        snapDuration: '00:05:00',
        allDaySlot: false,
        nowIndicator: true,
        editable: {{if roleAtLeast .User "manager"}}true{{else}}false{{end}},
        eventResizableFromStart: true,
        selectable: {{if roleAtLeast .User "manager"}}true{{else}}false{{end}},
        selectMirror: true,
        unselectAuto: false,
        longPressDelay: 500,

        // Custom event class names based on source type
        eventClassNames: function(arg) {
            const type = arg.event.extendedProps.source_type;
            return ['event-' + (type || 'media')];
        },

        events: function(info, successCallback, failureCallback) {
            const mountId = mountFilter.value;
            let url = `/dashboard/schedule/events?start=${info.startStr}&end=${info.endStr}`;
            if (mountId) {
                url += `&mount_id=${mountId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => successCallback(data))
                .catch(error => failureCallback(error));
        },

        // Left click on event - show details
        eventClick: function(info) {
            selectedEvent = info.event;
            showEventDetails(info.event);
        },

        // Right click on event - show context menu
        eventDidMount: function(info) {
            info.el.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                selectedEvent = info.event;
                contextMenuTarget = 'event';
                showContextMenu(eventContextMenu, e.pageX, e.pageY);
            });
        },

        eventDrop: function(info) {
            updateEvent(info.event);
        },

        eventResize: function(info) {
            updateEvent(info.event);
        },

        // Time selection - store the range
        select: function(info) {
            selectedTimeRange = { start: info.start, end: info.end };
        },

        unselect: function() {
            // Keep the selection for context menu usage
        },

        // Double click to quickly add
        dateClick: function(info) {
            // Double-click detection
            if (this.lastClick && Date.now() - this.lastClick < 300) {
                // Double click - open add modal
                const start = info.date;
                const end = new Date(start.getTime() + 30 * 60000); // +30 min default
                openAddScheduleModal(start, end);
            }
            this.lastClick = Date.now();
        }
    });

    // Add right-click on calendar background (empty time slots)
    calendarEl.addEventListener('contextmenu', function(e) {
        const fcEvent = e.target.closest('.fc-event');
        if (fcEvent) return; // Event right-click handled above

        const timeGrid = e.target.closest('.fc-timegrid-slot, .fc-daygrid-day');
        if (timeGrid || selectedTimeRange) {
            e.preventDefault();
            contextMenuTarget = 'calendar';
            showContextMenu(calendarContextMenu, e.pageX, e.pageY);
        }
    });

    calendar.render();
    window.calendar = calendar;

    // Context menu action handlers
    document.querySelectorAll('.context-menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const action = this.dataset.action;
            hideAllContextMenus();
            handleContextAction(action);
        });
    });

    function handleContextAction(action) {
        switch(action) {
            // Calendar context actions
            case 'add-media':
            case 'add-playlist':
            case 'add-smartblock':
            case 'add-webstream':
            case 'add-live':
                if (selectedTimeRange) {
                    openAddScheduleModal(selectedTimeRange.start, selectedTimeRange.end, action.replace('add-', ''));
                } else {
                    // Use current time if no selection
                    const now = new Date();
                    const end = new Date(now.getTime() + 60 * 60000);
                    openAddScheduleModal(now, end, action.replace('add-', ''));
                }
                break;

            // Event context actions
            case 'event-details':
                if (selectedEvent) showEventDetails(selectedEvent);
                break;
            case 'event-edit':
                if (selectedEvent) openEditModal(selectedEvent);
                break;
            case 'event-duplicate':
                if (selectedEvent) duplicateEvent(selectedEvent);
                break;
            case 'event-move':
                grimnirUtils.showToast('Drag the event to move it', 'info');
                break;
            case 'event-delete':
                if (selectedEvent) deleteEvent(selectedEvent);
                break;
        }
    }

    function showEventDetails(event) {
        const props = event.extendedProps;

        document.getElementById('eventModalTitle').textContent = event.title || 'Scheduled Item';

        let typeColor = {
            'media': 'primary',
            'playlist': 'success',
            'smart_block': 'info',
            'live': 'danger',
            'webstream': 'warning'
        }[props.source_type] || 'secondary';

        let body = `
            <dl class="row mb-0">
                <dt class="col-4">Type</dt>
                <dd class="col-8"><span class="badge bg-${typeColor}">${props.source_type}</span></dd>

                <dt class="col-4">Start</dt>
                <dd class="col-8">${event.start.toLocaleString()}</dd>

                <dt class="col-4">End</dt>
                <dd class="col-8">${event.end.toLocaleString()}</dd>

                <dt class="col-4">Duration</dt>
                <dd class="col-8">${formatDuration((event.end - event.start) / 1000)}</dd>
        `;

        if (props.metadata) {
            if (props.metadata.artist) {
                body += `<dt class="col-4">Artist</dt><dd class="col-8">${props.metadata.artist}</dd>`;
            }
            if (props.metadata.album) {
                body += `<dt class="col-4">Album</dt><dd class="col-8">${props.metadata.album}</dd>`;
            }
        }

        body += '</dl>';
        document.getElementById('eventModalBody').innerHTML = body;
        eventModal.show();
    }

    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}h ${m}m`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    function openAddScheduleModal(start, end, sourceType = 'media') {
        const startInput = document.getElementById('scheduleStartInput');
        const endInput = document.getElementById('scheduleEndInput');

        // Format for datetime-local input
        startInput.value = formatDateTimeLocal(start);
        endInput.value = formatDateTimeLocal(end);

        // Select the appropriate tab
        const tabMap = {
            'media': 'media-tab',
            'playlist': 'playlist-tab',
            'smartblock': 'smartblock-tab',
            'webstream': 'webstream-tab',
            'live': 'live-tab'
        };
        const tabId = tabMap[sourceType] || 'media-tab';
        document.getElementById(tabId)?.click();

        // Load data for dropdowns
        loadPlaylists();
        loadSmartBlocks();
        loadWebstreams();

        addScheduleModal.show();
    }

    function formatDateTimeLocal(date) {
        const d = new Date(date);
        const pad = n => n.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // Load dropdown data
    async function loadPlaylists() {
        try {
            const response = await fetch('/api/v1/playlists');
            const data = await response.json();
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Select a playlist...</option>';
            (data.playlists || []).forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
        } catch (e) { console.error('Failed to load playlists:', e); }
    }

    async function loadSmartBlocks() {
        try {
            const response = await fetch('/api/v1/smart-blocks');
            const data = await response.json();
            const select = document.getElementById('smartBlockSelect');
            select.innerHTML = '<option value="">Select a smart block...</option>';
            (data.smart_blocks || []).forEach(sb => {
                select.innerHTML += `<option value="${sb.id}">${sb.name}</option>`;
            });
        } catch (e) { console.error('Failed to load smart blocks:', e); }
    }

    async function loadWebstreams() {
        try {
            const response = await fetch('/api/v1/webstreams');
            const data = await response.json();
            const select = document.getElementById('webstreamSelect');
            select.innerHTML = '<option value="">Select a webstream...</option>';
            (data.webstreams || []).forEach(ws => {
                select.innerHTML += `<option value="${ws.id}">${ws.name}</option>`;
            });
        } catch (e) { console.error('Failed to load webstreams:', e); }
    }

    // Media search
    let mediaSearchTimeout;
    document.getElementById('mediaSearchInput')?.addEventListener('input', function(e) {
        clearTimeout(mediaSearchTimeout);
        const query = e.target.value;
        if (query.length < 2) return;

        mediaSearchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/api/v1/media?q=${encodeURIComponent(query)}&limit=20`);
                const data = await response.json();
                const results = document.getElementById('mediaSearchResults');
                results.innerHTML = '';

                (data.items || []).forEach(item => {
                    const div = document.createElement('a');
                    div.href = '#';
                    div.className = 'list-group-item list-group-item-action';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.title}</strong><br>
                                <small class="text-body-secondary">${item.artist || 'Unknown'} â€¢ ${formatDuration(item.duration)}</small>
                            </div>
                            <i class="bi bi-plus-circle text-primary"></i>
                        </div>
                    `;
                    div.addEventListener('click', (e) => {
                        e.preventDefault();
                        div.classList.add('active');
                        div.dataset.mediaId = item.id;
                        div.dataset.duration = item.duration;
                        // Deselect others
                        results.querySelectorAll('.list-group-item').forEach(el => {
                            if (el !== div) el.classList.remove('active');
                        });
                    });
                    results.appendChild(div);
                });
            } catch (e) { console.error('Media search failed:', e); }
        }, 300);
    });

    // Confirm add schedule
    document.getElementById('confirmAddSchedule')?.addEventListener('click', async function() {
        const startInput = document.getElementById('scheduleStartInput').value;
        const endInput = document.getElementById('scheduleEndInput').value;
        const activeTab = document.querySelector('#sourceTypeTabs .nav-link.active')?.id;

        let sourceType, sourceId, metadata = {};

        switch(activeTab) {
            case 'media-tab':
                const selectedMedia = document.querySelector('#mediaSearchResults .list-group-item.active');
                if (!selectedMedia) {
                    grimnirUtils.showToast('Please select a media item', 'warning');
                    return;
                }
                sourceType = 'media';
                sourceId = selectedMedia.dataset.mediaId;
                break;

            case 'playlist-tab':
                sourceId = document.getElementById('playlistSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a playlist', 'warning');
                    return;
                }
                sourceType = 'playlist';
                break;

            case 'smartblock-tab':
                sourceId = document.getElementById('smartBlockSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a smart block', 'warning');
                    return;
                }
                sourceType = 'smart_block';
                break;

            case 'webstream-tab':
                sourceId = document.getElementById('webstreamSelect').value;
                if (!sourceId) {
                    grimnirUtils.showToast('Please select a webstream', 'warning');
                    return;
                }
                sourceType = 'webstream';
                break;

            case 'live-tab':
                sourceType = 'live';
                sourceId = null;
                metadata = {
                    session_name: document.getElementById('liveSessionName').value || 'Live Session',
                    priority: parseInt(document.getElementById('livePriority').value)
                };
                break;
        }

        try {
            const response = await fetch('/dashboard/schedule/entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    starts_at: new Date(startInput).toISOString(),
                    ends_at: new Date(endInput).toISOString(),
                    source_type: sourceType,
                    source_id: sourceId,
                    metadata: metadata
                })
            });

            if (response.ok) {
                addScheduleModal.hide();
                calendar.refetchEvents();
                grimnirUtils.showToast('Schedule entry added', 'success');
            } else {
                const err = await response.json();
                grimnirUtils.showToast(err.error || 'Failed to add entry', 'error');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to add entry', 'error');
        }
    });

    function updateEvent(event) {
        fetch(`/dashboard/schedule/entries/${event.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                starts_at: event.start.toISOString(),
                ends_at: event.end.toISOString()
            })
        }).then(response => {
            if (response.ok) {
                grimnirUtils.showToast('Schedule updated', 'success');
            } else {
                calendar.refetchEvents();
                grimnirUtils.showToast('Failed to update', 'error');
            }
        });
    }

    function deleteEvent(event) {
        if (!confirm('Delete this schedule entry?')) return;

        fetch(`/dashboard/schedule/entries/${event.id}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                event.remove();
                eventModal.hide();
                grimnirUtils.showToast('Entry deleted', 'success');
            }
        });
    }

    async function duplicateEvent(event) {
        try {
            const response = await fetch(`/dashboard/schedule/entries/${event.id}/duplicate`, {
                method: 'POST'
            });
            if (response.ok) {
                calendar.refetchEvents();
                grimnirUtils.showToast('Event duplicated', 'success');
            }
        } catch (e) {
            grimnirUtils.showToast('Failed to duplicate', 'error');
        }
    }

    // Mount filter
    mountFilter.addEventListener('change', () => {
        calendar.refetchEvents();
    });

    // Delete event button in modal
    document.getElementById('deleteEventBtn')?.addEventListener('click', () => {
        if (selectedEvent) deleteEvent(selectedEvent);
    });

    // WebSocket updates
    window.grimnirWS.on('schedule_update', () => {
        calendar.refetchEvents();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // N - New entry (if time selected)
        if (e.key === 'n' && selectedTimeRange) {
            openAddScheduleModal(selectedTimeRange.start, selectedTimeRange.end);
        }

        // Delete/Backspace - Delete selected event
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedEvent) {
            deleteEvent(selectedEvent);
        }

        // Escape - Deselect and close menus
        if (e.key === 'Escape') {
            hideAllContextMenus();
            calendar.unselect();
            selectedEvent = null;
            selectedTimeRange = null;
        }
    });
});
</script>
{{end}}
