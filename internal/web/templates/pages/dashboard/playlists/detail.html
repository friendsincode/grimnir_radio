{{define "pages/dashboard/playlists/detail"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
{{$data := .Data}}
{{$playlist := index $data "Playlist"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/dashboard/playlists">Playlists</a></li>
        <li class="breadcrumb-item active">{{$playlist.Name}}</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
{{$data := .Data}}
{{$playlist := index $data "Playlist"}}
{{$items := index $data "Items"}}
{{$availableMedia := index $data "AvailableMedia"}}
{{$genres := index $data "Genres"}}
{{$artists := index $data "Artists"}}
{{$moods := index $data "Moods"}}
{{$smartBlocks := index $data "SmartBlocks"}}

<div class="d-flex justify-content-between align-items-start mb-4">
    <div class="flex-grow-1">
        <!-- Editable Name -->
        <div class="editable-field mb-2" id="nameField">
            <h4 class="mb-0 d-inline-flex align-items-center gap-2">
                <i class="bi bi-list-ul"></i>
                <span class="editable-text" id="nameText" data-original="{{$playlist.Name}}">{{$playlist.Name}}</span>
                <input type="text" class="form-control form-control-lg d-none editable-input"
                       id="nameInput" value="{{$playlist.Name}}" style="width: auto; min-width: 200px;">
                <button class="btn btn-sm btn-link text-body-secondary edit-btn" title="Click to edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-success d-none save-btn" title="Save">
                    <i class="bi bi-check"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary d-none revert-btn" title="Revert">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            </h4>
        </div>

        <!-- Editable Description -->
        <div class="editable-field" id="descField">
            <p class="text-body-secondary mb-0 d-inline-flex align-items-center gap-2">
                <span class="editable-text" id="descText" data-original="{{$playlist.Description}}">{{if $playlist.Description}}{{$playlist.Description}}{{else}}<em>No description</em>{{end}}</span>
                <textarea class="form-control d-none editable-input" id="descInput" rows="2"
                          style="min-width: 300px;">{{$playlist.Description}}</textarea>
                <button class="btn btn-sm btn-link text-body-secondary edit-btn" title="Click to edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-success d-none save-btn" title="Save">
                    <i class="bi bi-check"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary d-none revert-btn" title="Revert">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            </p>
        </div>
    </div>

    <div class="d-flex gap-2 align-items-start">
        <!-- Cover Image -->
        <div class="position-relative" style="width: 80px; height: 80px;">
            {{if len $playlist.CoverImage}}
            <img src="/dashboard/playlists/{{$playlist.ID}}/cover" alt="Cover"
                 class="rounded shadow" style="width: 80px; height: 80px; object-fit: cover;">
            <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                    style="padding: 0.1rem 0.3rem;"
                    hx-delete="/dashboard/playlists/{{$playlist.ID}}/cover"
                    hx-confirm="Remove cover image?"
                    title="Remove cover image">
                <i class="bi bi-x"></i>
            </button>
            {{else}}
            <label class="bg-secondary rounded d-flex align-items-center justify-content-center shadow"
                   style="width: 80px; height: 80px; cursor: pointer;" title="Upload cover image">
                <i class="bi bi-image text-white fs-3"></i>
                <input type="file" class="d-none" accept="image/*" id="coverUpload">
            </label>
            {{end}}
        </div>

        <button class="btn btn-outline-danger"
                hx-delete="/dashboard/playlists/{{$playlist.ID}}"
                hx-confirm="Delete this playlist and all its items?">
            <i class="bi bi-trash me-1"></i>Delete
        </button>
    </div>
</div>

<div class="row g-4">
    <!-- Playlist Items -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Tracks ({{len $items}})</h5>
                <small class="text-body-secondary"><i class="bi bi-grip-vertical me-1"></i>Drag to reorder or drop media here</small>
            </div>
            <div class="card-body p-0" id="playlistDropZone">
                {{if $items}}
                <div class="list-group list-group-flush" id="playlistItems">
                    {{range $index, $item := $items}}
                    <div class="list-group-item d-flex align-items-center gap-3 playlist-item"
                         draggable="true"
                         data-id="{{$item.ID}}"
                         data-media-id="{{$item.MediaID}}"
                         data-position="{{$item.Position}}">
                        <span class="drag-handle text-body-secondary">
                            <i class="bi bi-grip-vertical"></i>
                        </span>
                        <span class="badge bg-secondary position-number">{{add $index 1}}</span>
                        <div class="flex-grow-1">
                            <div class="fw-medium">{{$item.Media.Title}}</div>
                            <small class="text-body-secondary">
                                {{if $item.Media.Artist}}{{$item.Media.Artist}}{{else}}Unknown Artist{{end}}
                                {{if $item.Media.Duration}} - {{formatDuration $item.Media.Duration}}{{end}}
                            </small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary preview-btn"
                                    data-src="/dashboard/media/{{$item.MediaID}}/stream" title="Preview">
                                <i class="bi bi-play"></i>
                            </button>
                            <button class="btn btn-outline-danger" title="Remove from playlist"
                                    hx-delete="/dashboard/playlists/{{$playlist.ID}}/items/{{$item.ID}}"
                                    hx-target="closest .playlist-item"
                                    hx-swap="outerHTML">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{else}}
                <div class="list-group list-group-flush" id="playlistItems"></div>
                <div class="text-center py-5 text-body-secondary" id="emptyPlaylistMsg">
                    <i class="bi bi-music-note-list fs-1 mb-3 d-block"></i>
                    <p class="mb-0">No tracks in this playlist yet.</p>
                    <p class="small">Drag tracks from the media library or click + to add.</p>
                </div>
                {{end}}
            </div>
            {{if $items}}
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center small text-body-secondary">
                    <span>{{len $items}} tracks</span>
                    <span>Total duration: {{formatDuration (index $data "TotalDuration")}}</span>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Add Media Panel -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Add Media</h5>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" title="Toggle advanced filters">
                    <i class="bi bi-sliders"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <!-- Smart Block Quick Select -->
                {{if $smartBlocks}}
                <div class="p-3 border-bottom bg-body-tertiary">
                    <label class="form-label small fw-semibold mb-1">
                        <i class="bi bi-magic me-1"></i>Use Smart Block Criteria
                    </label>
                    <select class="form-select form-select-sm" id="smartBlockFilter">
                        <option value="">-- Select Smart Block --</option>
                        {{range $smartBlocks}}
                        <option value="{{.ID}}" data-rules='{{jsonMarshal .Rules}}'>{{.Name}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                <!-- Search and Filters Form -->
                <form id="mediaSearchForm"
                      hx-get="/dashboard/playlists/{{$playlist.ID}}/media-search"
                      hx-target="#availableMedia"
                      hx-trigger="load, input delay:300ms from:#mediaSearch, change from:.media-filter"
                      hx-indicator="#searchSpinner">

                    <!-- Basic Filters -->
                    <div class="p-3 border-bottom">
                        <div class="position-relative mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Search by title, artist, or album..."
                                   id="mediaSearch" name="q">
                            <div class="position-absolute top-50 end-0 translate-middle-y pe-2 htmx-indicator" id="searchSpinner">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <select class="form-select form-select-sm media-filter" id="genreFilter" name="genre">
                                    <option value="">All Genres</option>
                                    {{range $genres}}
                                    <option value="{{.}}">{{.}}</option>
                                    {{end}}
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm media-filter" id="artistFilter" name="artist">
                                    <option value="">All Artists</option>
                                    {{range $artists}}
                                    <option value="{{.}}">{{.}}</option>
                                    {{end}}
                                </select>
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input media-filter" id="includeArchive" name="include_archive" value="true">
                            <label class="form-check-label small" for="includeArchive">
                                <i class="bi bi-globe me-1"></i>Include public archive from other stations
                            </label>
                        </div>
                    </div>

                    <!-- Advanced Filters (collapsed by default) -->
                    <div class="collapse border-bottom" id="advancedFilters">
                        <div class="p-3 bg-body-tertiary">
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label small mb-1">Mood</label>
                                    <select class="form-select form-select-sm media-filter" id="moodFilter" name="mood">
                                        <option value="">Any Mood</option>
                                        {{range $moods}}
                                        <option value="{{.}}">{{.}}</option>
                                        {{end}}
                                        <option value="energetic">Energetic</option>
                                        <option value="happy">Happy</option>
                                        <option value="relaxed">Relaxed</option>
                                        <option value="melancholic">Melancholic</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small mb-1">Year</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control media-filter" id="yearFrom" name="year_from" placeholder="From" min="1900" max="2100">
                                        <input type="number" class="form-control media-filter" id="yearTo" name="year_to" placeholder="To" min="1900" max="2100">
                                    </div>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-12">
                                    <label class="form-label small mb-1">BPM Range</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control media-filter" id="bpmFrom" name="bpm_from" placeholder="Min" min="0" max="300">
                                        <input type="number" class="form-control media-filter" id="bpmTo" name="bpm_to" placeholder="Max" min="0" max="300">
                                    </div>
                                </div>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input media-filter" id="excludeExplicit" name="exclude_explicit" value="true">
                                <label class="form-check-label small" for="excludeExplicit">Exclude explicit</label>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" type="button" id="clearFilters">
                                <i class="bi bi-x-circle me-1"></i>Clear All Filters
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Media List -->
                <div id="availableMedia" class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div id="noResults" class="text-center text-body-secondary py-4 d-none">
                    <i class="bi bi-search fs-4 mb-2 d-block"></i>
                    No matching media found
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <span class="small text-body-secondary" id="mediaCount">{{len $availableMedia}} items</span>
                <a href="/dashboard/media/upload" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-upload me-1"></i>Upload
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Hidden audio for preview -->
<audio id="previewAudio"></audio>

<!-- Hidden form for cover upload -->
<form id="coverForm" hx-post="/dashboard/playlists/{{$playlist.ID}}/cover" hx-encoding="multipart/form-data" hx-swap="none" style="display:none;">
    <input type="file" name="cover" id="coverFileInput">
</form>
{{end}}

{{define "scripts"}}
<script>
const playlistId = '{{.Data.Playlist.ID}}';

// ==================== DRAG AND DROP ====================
const list = document.getElementById('playlistItems');
const dropZone = document.getElementById('playlistDropZone');
let draggedItem = null;
let draggedMediaId = null;

// Get list of media IDs already in playlist for duplicate detection
function getExistingMediaIds() {
    const ids = new Set();
    document.querySelectorAll('.playlist-item').forEach(item => {
        if (item.dataset.mediaId) {
            ids.add(item.dataset.mediaId);
        }
    });
    return ids;
}

// Hide media items that are already in the playlist
function hideExistingMedia() {
    const existingIds = getExistingMediaIds();
    document.querySelectorAll('.media-item').forEach(item => {
        if (existingIds.has(item.dataset.mediaId)) {
            item.classList.add('d-none', 'already-added');
        }
    });
    updateMediaCount();
}

// Update the media count display
function updateMediaCount() {
    const visible = document.querySelectorAll('.media-item:not(.d-none)').length;
    const mediaCountEl = document.getElementById('mediaCount');
    if (mediaCountEl) {
        mediaCountEl.textContent = `${visible} items`;
    }
}

// Check if media is duplicate and confirm with user
function checkDuplicateAndAdd(mediaId, title) {
    const existingIds = getExistingMediaIds();
    if (existingIds.has(mediaId)) {
        if (!confirm(`"${title}" is already in this playlist. Add it again?`)) {
            return false;
        }
    }
    return true;
}

// Add media to playlist
function addMediaToPlaylist(mediaId, title) {
    if (!checkDuplicateAndAdd(mediaId, title)) {
        return;
    }

    const formData = new FormData();
    formData.append('media_id', mediaId);

    fetch(`/dashboard/playlists/${playlistId}/items`, {
        method: 'POST',
        body: new URLSearchParams(formData)
    }).then(res => {
        if (res.ok) {
            // Hide the item from Add Media list
            const mediaItem = document.querySelector(`.media-item[data-media-id="${mediaId}"]`);
            if (mediaItem) {
                mediaItem.classList.add('d-none', 'already-added');
            }
            updateMediaCount();
            // Reload to show the new track in the playlist
            window.location.reload();
        } else {
            alert('Failed to add track to playlist');
        }
    });
}

// Playlist item reordering
if (list) {
    list.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('playlist-item')) {
            draggedItem = e.target;
            draggedMediaId = null; // Not dragging from media panel
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', 'playlist-item');
        }
    });

    list.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('playlist-item')) {
            e.target.classList.remove('dragging');
            draggedItem = null;
            list.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
    });

    list.addEventListener('dragover', (e) => {
        e.preventDefault();
        const target = e.target.closest('.playlist-item');
        if (target && target !== draggedItem) {
            list.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }
    });

    list.addEventListener('dragleave', (e) => {
        const target = e.target.closest('.playlist-item');
        if (target) {
            target.classList.remove('drag-over');
        }
    });

    list.addEventListener('drop', (e) => {
        e.preventDefault();
        const target = e.target.closest('.playlist-item');

        // Handle reordering playlist items
        if (target && draggedItem && target !== draggedItem) {
            const items = Array.from(list.querySelectorAll('.playlist-item'));
            const draggedIdx = items.indexOf(draggedItem);
            const targetIdx = items.indexOf(target);

            if (draggedIdx < targetIdx) {
                target.after(draggedItem);
            } else {
                target.before(draggedItem);
            }

            updatePositionNumbers();
            saveOrder();
        }
        target?.classList.remove('drag-over');
    });
}

// Drop zone for media items from Add Media panel
if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
        // Only highlight if dragging from media panel
        if (draggedMediaId) {
            e.preventDefault();
            dropZone.classList.add('drop-highlight');
        }
    });

    dropZone.addEventListener('dragleave', (e) => {
        if (e.target === dropZone || !dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove('drop-highlight');
        }
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drop-highlight');

        // Handle drop from media panel
        if (draggedMediaId) {
            const mediaId = draggedMediaId;
            const title = e.dataTransfer.getData('text/title') || 'this track';
            draggedMediaId = null;
            addMediaToPlaylist(mediaId, title);
        }
    });
}

function updatePositionNumbers() {
    document.querySelectorAll('.playlist-item').forEach((item, idx) => {
        const posNum = item.querySelector('.position-number');
        if (posNum) posNum.textContent = idx + 1;
    });
}

function saveOrder() {
    const items = Array.from(document.querySelectorAll('.playlist-item'));
    const order = items.map((el, idx) => ({
        id: el.dataset.id,
        position: idx + 1
    }));

    fetch(`/dashboard/playlists/${playlistId}/items/reorder`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
    }).then(res => {
        if (!res.ok) {
            alert('Failed to save order. Please refresh the page.');
        }
    });
}

// ==================== INLINE EDITING ====================
document.querySelectorAll('.editable-field').forEach(field => {
    const textEl = field.querySelector('.editable-text');
    const inputEl = field.querySelector('.editable-input');
    const editBtn = field.querySelector('.edit-btn');
    const saveBtn = field.querySelector('.save-btn');
    const revertBtn = field.querySelector('.revert-btn');

    function enterEditMode() {
        textEl.classList.add('d-none');
        inputEl.classList.remove('d-none');
        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        revertBtn.classList.remove('d-none');
        inputEl.focus();
    }

    function exitEditMode(save) {
        textEl.classList.remove('d-none');
        inputEl.classList.add('d-none');
        editBtn.classList.remove('d-none');
        saveBtn.classList.add('d-none');
        revertBtn.classList.add('d-none');

        if (save) {
            const newValue = inputEl.value.trim();
            textEl.textContent = newValue || (field.id === 'descField' ? 'No description' : '');
            textEl.dataset.original = newValue;
            savePlaylist();
        } else {
            inputEl.value = textEl.dataset.original;
        }
    }

    // Click text or edit button to edit
    textEl.addEventListener('click', enterEditMode);
    editBtn.addEventListener('click', enterEditMode);

    saveBtn.addEventListener('click', () => exitEditMode(true));
    revertBtn.addEventListener('click', () => exitEditMode(false));

    // Enter to save, Escape to cancel
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && inputEl.tagName !== 'TEXTAREA') {
            e.preventDefault();
            exitEditMode(true);
        } else if (e.key === 'Escape') {
            exitEditMode(false);
        }
    });
});

function savePlaylist() {
    const name = document.getElementById('nameInput').value;
    const description = document.getElementById('descInput').value;

    const formData = new FormData();
    formData.append('name', name);
    formData.append('description', description);

    fetch(`/dashboard/playlists/${playlistId}`, {
        method: 'PUT',
        body: new URLSearchParams(formData)
    });
}

// ==================== MEDIA FILTERING (Server-side via HTMX) ====================
const mediaSearch = document.getElementById('mediaSearch');
const genreFilter = document.getElementById('genreFilter');
const artistFilter = document.getElementById('artistFilter');
const moodFilter = document.getElementById('moodFilter');
const yearFrom = document.getElementById('yearFrom');
const yearTo = document.getElementById('yearTo');
const bpmFrom = document.getElementById('bpmFrom');
const bpmTo = document.getElementById('bpmTo');
const excludeExplicit = document.getElementById('excludeExplicit');
const smartBlockFilter = document.getElementById('smartBlockFilter');
const clearFiltersBtn = document.getElementById('clearFilters');
const mediaSearchForm = document.getElementById('mediaSearchForm');

// Trigger HTMX search
function triggerSearch() {
    if (mediaSearchForm) {
        htmx.trigger(mediaSearchForm, 'submit');
    }
}

// Apply smart block rules to filters and trigger search
function applySmartBlockRules(rules) {
    if (!rules) return;

    if (rules.genre && genreFilter) {
        genreFilter.value = rules.genre;
    }
    if (rules.artist && artistFilter) {
        artistFilter.value = rules.artist;
    }
    if (rules.mood && moodFilter) {
        moodFilter.value = rules.mood;
    }
    if (rules.yearFrom && yearFrom) {
        yearFrom.value = rules.yearFrom;
    }
    if (rules.yearTo && yearTo) {
        yearTo.value = rules.yearTo;
    }
    if (rules.bpmFrom && bpmFrom) {
        bpmFrom.value = rules.bpmFrom;
    }
    if (rules.bpmTo && bpmTo) {
        bpmTo.value = rules.bpmTo;
    }
    if (rules.excludeExplicit && excludeExplicit) {
        excludeExplicit.checked = rules.excludeExplicit;
    }

    // Show advanced filters if smart block uses them
    if (rules.mood || rules.yearFrom || rules.yearTo || rules.bpmFrom || rules.bpmTo || rules.excludeExplicit) {
        const advancedFilters = document.getElementById('advancedFilters');
        if (advancedFilters) {
            new bootstrap.Collapse(advancedFilters, { show: true });
        }
    }

    triggerSearch();
}

function clearAllFilters() {
    if (mediaSearch) mediaSearch.value = '';
    if (genreFilter) genreFilter.value = '';
    if (artistFilter) artistFilter.value = '';
    if (moodFilter) moodFilter.value = '';
    if (yearFrom) yearFrom.value = '';
    if (yearTo) yearTo.value = '';
    if (bpmFrom) bpmFrom.value = '';
    if (bpmTo) bpmTo.value = '';
    if (excludeExplicit) excludeExplicit.checked = false;
    if (smartBlockFilter) smartBlockFilter.value = '';
    triggerSearch();
}

clearFiltersBtn?.addEventListener('click', clearAllFilters);

smartBlockFilter?.addEventListener('change', () => {
    const selected = smartBlockFilter.options[smartBlockFilter.selectedIndex];
    if (selected && selected.dataset.rules) {
        try {
            const rules = JSON.parse(selected.dataset.rules);
            // Clear filters first without triggering search
            if (mediaSearch) mediaSearch.value = '';
            if (genreFilter) genreFilter.value = '';
            if (artistFilter) artistFilter.value = '';
            if (moodFilter) moodFilter.value = '';
            if (yearFrom) yearFrom.value = '';
            if (yearTo) yearTo.value = '';
            if (bpmFrom) bpmFrom.value = '';
            if (bpmTo) bpmTo.value = '';
            if (excludeExplicit) excludeExplicit.checked = false;
            smartBlockFilter.value = selected.value; // Restore selection after clear
            applySmartBlockRules(rules);
        } catch (e) {
            console.error('Failed to parse smart block rules:', e);
        }
    } else {
        clearAllFilters();
    }
});

// ==================== ADD MEDIA ====================
function initMediaButtons(container) {
    container.querySelectorAll('.add-media-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const mediaId = btn.dataset.mediaId;
            const mediaItem = btn.closest('.media-item');
            const title = mediaItem?.dataset.title || 'this track';
            addMediaToPlaylist(mediaId, title);
        });
    });

    // Also setup draggable for new items
    container.querySelectorAll('.draggable-media').forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedMediaId = item.dataset.mediaId;
            draggedItem = null;
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', 'media-item');
            e.dataTransfer.setData('text/title', item.dataset.title || '');
            item.classList.add('dragging');
        });

        item.addEventListener('dragend', (e) => {
            item.classList.remove('dragging');
            draggedMediaId = null;
            dropZone?.classList.remove('drop-highlight');
        });
    });

    // Mark items already in playlist
    const existingIds = getExistingMediaIds();
    container.querySelectorAll('.media-item').forEach(item => {
        if (existingIds.has(item.dataset.mediaId)) {
            item.classList.add('d-none', 'already-added');
        }
    });

    updateMediaCount();
}

// Initialize buttons for initial content
initMediaButtons(document.getElementById('availableMedia'));

// Re-initialize after HTMX swaps in new content
document.body.addEventListener('htmx:afterSwap', (e) => {
    if (e.detail.target.id === 'availableMedia') {
        initMediaButtons(e.detail.target);
    }
});

// ==================== COVER UPLOAD ====================
const coverUpload = document.getElementById('coverUpload');
const coverForm = document.getElementById('coverForm');
const coverFileInput = document.getElementById('coverFileInput');

coverUpload?.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        coverFileInput.files = e.target.files;
        htmx.trigger(coverForm, 'submit');
    }
});

// ==================== AUDIO PREVIEW ====================
const previewAudio = document.getElementById('previewAudio');
let currentPreviewBtn = null;

document.querySelectorAll('.preview-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const src = btn.dataset.src;

        if (currentPreviewBtn === btn && !previewAudio.paused) {
            previewAudio.pause();
            btn.innerHTML = '<i class="bi bi-play"></i>';
            currentPreviewBtn = null;
        } else {
            // Stop any current playback
            if (currentPreviewBtn) {
                currentPreviewBtn.innerHTML = '<i class="bi bi-play"></i>';
            }

            previewAudio.src = src;
            previewAudio.play();
            btn.innerHTML = '<i class="bi bi-pause"></i>';
            currentPreviewBtn = btn;
        }
    });
});

previewAudio.addEventListener('ended', () => {
    if (currentPreviewBtn) {
        currentPreviewBtn.innerHTML = '<i class="bi bi-play"></i>';
        currentPreviewBtn = null;
    }
});
</script>

<style>
.playlist-item {
    cursor: grab;
    transition: background-color 0.15s, transform 0.15s;
}
.playlist-item.dragging {
    opacity: 0.5;
    cursor: grabbing;
}
.playlist-item.drag-over {
    background-color: var(--bs-primary-bg-subtle);
    border-top: 2px solid var(--bs-primary);
    margin-top: -2px;
}
.drag-handle {
    cursor: grab;
}
.draggable-media {
    cursor: grab;
}
.draggable-media.dragging {
    opacity: 0.5;
    cursor: grabbing;
}
#playlistDropZone.drop-highlight {
    background-color: var(--bs-success-bg-subtle);
    border: 2px dashed var(--bs-success);
    border-radius: 0.375rem;
}
.min-width-0 {
    min-width: 0;
}
.editable-text {
    cursor: pointer;
}
.editable-text:hover {
    text-decoration: underline;
    text-decoration-style: dashed;
}
</style>
{{end}}
