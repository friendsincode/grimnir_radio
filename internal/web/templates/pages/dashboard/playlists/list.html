{{define "pages/dashboard/playlists/list"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Playlists</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-list-ul me-2"></i>Playlists</h4>
    <div class="d-flex gap-2">
        <!-- View Toggle -->
        <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-outline-secondary active" id="viewCards" title="Card View">
                <i class="bi bi-grid-3x3-gap"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="viewList" title="List View">
                <i class="bi bi-list"></i>
            </button>
        </div>
        <a href="/dashboard/playlists/new" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>New Playlist
        </a>
    </div>
</div>

<!-- Bulk Actions Toolbar -->
<div class="card mb-3 d-none" id="bulkActionsBar">
    <div class="card-body py-2">
        <div class="d-flex align-items-center gap-3">
            <span class="text-body-secondary">
                <strong id="selectedCount">0</strong> selected
            </span>
            <div class="vr"></div>
            <button class="btn btn-sm btn-outline-danger" onclick="bulkAction('delete')" title="Delete selected">
                <i class="bi bi-trash me-1"></i>Delete
            </button>
            <div class="ms-auto">
                <button class="btn btn-sm btn-link text-body-secondary" onclick="clearSelection()" title="Clear selection">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Card View -->
<div class="row g-4" id="cardView">
    {{range .Data}}
    {{$hasCover := .HasCover}}
    <div class="col-sm-6 col-lg-4">
        <div class="card h-100 playlist-card {{if $hasCover}}has-cover{{end}}" data-playlist-id="{{.ID}}" style="cursor: pointer;{{if $hasCover}} background-image: url('/dashboard/playlists/{{.ID}}/cover'); background-size: cover; background-position: center;{{end}}">
            {{if $hasCover}}<div class="card-overlay"></div>{{end}}
            <div class="card-body d-flex flex-column {{if $hasCover}}position-relative{{end}}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input playlist-checkbox"
                               value="{{.ID}}" onchange="updateSelection()" onclick="event.stopPropagation();">
                        <h5 class="card-title mb-0 {{if $hasCover}}text-white text-shadow{{end}}">{{.Name}}</h5>
                    </div>
                    <button class="btn btn-sm {{if $hasCover}}btn-danger{{else}}btn-outline-danger{{end}} delete-btn"
                            hx-delete="/dashboard/playlists/{{.ID}}"
                            hx-confirm="Delete playlist '{{.Name}}' and all {{.ItemCount}} track(s) inside it?"
                            hx-target="closest .col-sm-6"
                            hx-swap="outerHTML"
                            onclick="event.stopPropagation();"
                            title="Delete playlist">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                {{if .Description}}
                <p class="card-text {{if $hasCover}}text-white-50{{else}}text-body-secondary{{end}} small mb-2">{{truncate .Description 80}}</p>
                {{end}}
                <div class="mt-auto d-flex gap-2">
                    <span class="badge {{if $hasCover}}bg-dark bg-opacity-75{{else}}bg-secondary{{end}}" title="Number of tracks">{{.ItemCount}} items</span>
                    {{if .TotalDuration}}<span class="badge {{if $hasCover}}bg-dark bg-opacity-75{{else}}bg-info{{end}}" title="Total duration"><i class="bi bi-clock me-1"></i>{{formatDuration .TotalDuration}}</span>{{end}}
                </div>

                <!-- Hover Preview -->
                {{if .PreviewItems}}
                <div class="playlist-preview mt-3 pt-3 {{if not $hasCover}}border-top{{end}}" style="display: none;">
                    <div class="preview-container {{if $hasCover}}bg-dark bg-opacity-75 rounded p-2{{end}}">
                        {{range .PreviewItems}}
                        <div class="preview-item small d-flex justify-content-between gap-2 py-1 {{if $hasCover}}text-white{{end}}">
                            <span class="preview-title">
                                <i class="bi bi-music-note {{if $hasCover}}text-white-50{{else}}text-primary{{end}} me-1"></i>{{.Title}}</span>
                            <span class="{{if $hasCover}}text-white-50{{else}}text-body-secondary{{end}} flex-shrink-0">{{.Duration}}</span>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
            </div>
        </div>
    </div>
    {{else}}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5 text-body-secondary">
                <i class="bi bi-list-ul fs-1 mb-3"></i>
                <p class="mb-0">No playlists yet. <a href="/dashboard/playlists/new">Create your first one</a></p>
            </div>
        </div>
    </div>
    {{end}}
</div>

<!-- List View (hidden by default) -->
<div class="card d-none" id="listView">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="form-check-input" id="selectAllList"
                               onchange="toggleSelectAll(this)" title="Select all">
                    </th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Items</th>
                    <th>Duration</th>
                    <th>Created</th>
                    <th style="width: 80px;"></th>
                </tr>
            </thead>
            <tbody>
                {{range .Data}}
                <tr class="playlist-row" data-playlist-id="{{.ID}}" style="cursor: pointer;">
                    <td onclick="event.stopPropagation()">
                        <input type="checkbox" class="form-check-input playlist-checkbox"
                               value="{{.ID}}" onchange="updateSelection()">
                    </td>
                    <td class="fw-medium">{{.Name}}</td>
                    <td class="text-body-secondary">{{if .Description}}{{truncate .Description 50}}{{else}}-{{end}}</td>
                    <td><span class="badge bg-secondary" title="Number of tracks">{{.ItemCount}}</span></td>
                    <td class="text-body-secondary">{{if .TotalDuration}}{{formatDuration .TotalDuration}}{{else}}-{{end}}</td>
                    <td class="text-body-secondary small">{{formatTime .CreatedAt}}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-btn"
                                hx-delete="/dashboard/playlists/{{.ID}}"
                                hx-confirm="Delete playlist '{{.Name}}' and all {{.ItemCount}} track(s) inside it?"
                                hx-target="closest tr"
                                hx-swap="outerHTML"
                                onclick="event.stopPropagation();"
                                title="Delete playlist">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="7" class="text-center py-5 text-body-secondary">
                        No playlists yet. <a href="/dashboard/playlists/new">Create your first one</a>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// View toggle
const cardView = document.getElementById('cardView');
const listView = document.getElementById('listView');
const viewCardsBtn = document.getElementById('viewCards');
const viewListBtn = document.getElementById('viewList');

// Load saved view preference
const savedView = localStorage.getItem('playlistView') || 'cards';
if (savedView === 'list') {
    cardView.classList.add('d-none');
    listView.classList.remove('d-none');
    viewCardsBtn.classList.remove('active');
    viewListBtn.classList.add('active');
}

viewCardsBtn.addEventListener('click', () => {
    cardView.classList.remove('d-none');
    listView.classList.add('d-none');
    viewCardsBtn.classList.add('active');
    viewListBtn.classList.remove('active');
    localStorage.setItem('playlistView', 'cards');
});

viewListBtn.addEventListener('click', () => {
    cardView.classList.add('d-none');
    listView.classList.remove('d-none');
    viewCardsBtn.classList.remove('active');
    viewListBtn.classList.add('active');
    localStorage.setItem('playlistView', 'list');
});

// Click on card/row to go to detail
document.querySelectorAll('.playlist-card, .playlist-row').forEach(el => {
    el.addEventListener('click', (e) => {
        // Don't navigate if clicking delete button or checkbox
        if (e.target.closest('.delete-btn') || e.target.closest('.form-check-input')) return;
        const id = el.dataset.playlistId;
        if (id) {
            window.location.href = '/dashboard/playlists/' + id;
        }
    });
});

// Hover preview - simple show/hide
document.querySelectorAll('.playlist-card').forEach(card => {
    const preview = card.querySelector('.playlist-preview');
    if (!preview) return;

    card.addEventListener('mouseenter', () => {
        preview.style.display = 'block';
    });

    card.addEventListener('mouseleave', () => {
        preview.style.display = 'none';
    });
});

// Bulk selection
function getSelectedIds() {
    return Array.from(document.querySelectorAll('.playlist-checkbox:checked')).map(cb => cb.value);
}

function updateSelection() {
    const selected = getSelectedIds();
    const bar = document.getElementById('bulkActionsBar');
    const count = document.getElementById('selectedCount');

    if (selected.length > 0) {
        bar.classList.remove('d-none');
        count.textContent = selected.length;
    } else {
        bar.classList.add('d-none');
    }
}

function toggleSelectAll(checkbox) {
    // Only toggle checkboxes in visible view
    const visibleView = cardView.classList.contains('d-none') ? listView : cardView;
    visibleView.querySelectorAll('.playlist-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelection();
}

function clearSelection() {
    document.querySelectorAll('.playlist-checkbox').forEach(cb => cb.checked = false);
    const selectAllList = document.getElementById('selectAllList');
    if (selectAllList) selectAllList.checked = false;
    updateSelection();
}

function bulkAction(action) {
    const ids = getSelectedIds();
    if (ids.length === 0) return;

    let message = '';
    switch(action) {
        case 'delete': message = `DELETE ${ids.length} playlist(s) and ALL tracks inside them? This cannot be undone!`; break;
        default: message = `Apply action to ${ids.length} playlist(s)?`;
    }

    if (!confirm(message)) return;

    fetch('/dashboard/playlists/bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        },
        body: JSON.stringify({ action: action, ids: ids })
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            response.text().then(text => alert('Error: ' + text));
        }
    }).catch(err => alert('Error: ' + err));
}
</script>

<style>
.playlist-card {
    position: relative;
    overflow: hidden;
}

.playlist-card:hover {
    border-color: var(--bs-primary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.playlist-card.has-cover {
    min-height: 200px;
    border: none;
}

.playlist-card.has-cover:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
}

.text-shadow {
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.playlist-row:hover {
    background: var(--bs-tertiary-bg);
}

.preview-item {
    line-height: 1.4;
}

.preview-title {
    word-break: break-word;
}
</style>
{{end}}
