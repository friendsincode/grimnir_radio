{{define "pages/dashboard/profile"}}
{{template "layouts/dashboard" .}}
{{end}}

{{define "breadcrumb"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Profile</li>
    </ol>
</nav>
{{end}}

{{define "main"}}
{{$user := .Data.User}}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <h4 class="mb-4"><i class="bi bi-person-circle me-2"></i>Profile Settings</h4>

        {{if .Flash}}
        <div class="alert alert-{{if eq .Flash.Type "error"}}danger{{else}}{{.Flash.Type}}{{end}} alert-dismissible fade show" role="alert">
            {{.Flash.Message}}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {{end}}

        <!-- Account Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Account Information</h5>
            </div>
            <div class="card-body">
                <div id="profileResult"></div>

                <form method="POST" action="/dashboard/profile"
                      hx-put="/dashboard/profile"
                      hx-target="#profileResult"
                      hx-swap="innerHTML">

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email"
                               value="{{$user.Email}}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-control-plaintext" value="{{$user.Role}}" readonly>
                        <div class="form-text">Your role determines what features you can access.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Account Created</label>
                        <input type="text" class="form-control-plaintext" value="{{formatTime $user.CreatedAt}}" readonly>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Update Profile
                    </button>
                </form>
            </div>
        </div>

        <!-- Calendar Preferences -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-palette me-2"></i>Calendar Preferences</h5>
            </div>
            <div class="card-body">
                <div id="calendarResult"></div>

                <form method="POST" action="/dashboard/profile"
                      hx-put="/dashboard/profile"
                      hx-target="#calendarResult"
                      hx-swap="innerHTML">

                    <!-- Keep email field hidden to preserve it -->
                    <input type="hidden" name="email" value="{{$user.Email}}">

                    <div class="mb-3">
                        <label class="form-label">Calendar Color Theme</label>
                        <select class="form-select" name="calendar_color_theme" id="calendarColorTheme" style="max-width: 300px;">
                            <option value="default" {{if eq $user.CalendarColorTheme "default"}}selected{{end}}>Default (Indigo/Green/Amber)</option>
                            <option value="ocean" {{if eq $user.CalendarColorTheme "ocean"}}selected{{end}}>Ocean (Blue/Teal/Cyan)</option>
                            <option value="forest" {{if eq $user.CalendarColorTheme "forest"}}selected{{end}}>Forest (Green/Emerald/Lime)</option>
                            <option value="sunset" {{if eq $user.CalendarColorTheme "sunset"}}selected{{end}}>Sunset (Orange/Red/Pink)</option>
                            <option value="berry" {{if eq $user.CalendarColorTheme "berry"}}selected{{end}}>Berry (Purple/Violet/Fuchsia)</option>
                            <option value="earth" {{if eq $user.CalendarColorTheme "earth"}}selected{{end}}>Earth (Brown/Amber/Stone)</option>
                            <option value="neon" {{if eq $user.CalendarColorTheme "neon"}}selected{{end}}>Neon (Bright/Electric)</option>
                            <option value="pastel" {{if eq $user.CalendarColorTheme "pastel"}}selected{{end}}>Pastel (Soft/Light)</option>
                        </select>
                        <div class="form-text">Choose a color theme for your schedule calendar.</div>
                    </div>

                    <!-- Theme Preview -->
                    <div class="mb-3">
                        <label class="form-label">Preview</label>
                        <div class="d-flex gap-2" id="colorPreview">
                            <!-- Preview colors will be updated by JavaScript -->
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Save Preferences
                    </button>
                </form>
            </div>
        </div>

        <script>
        (function() {
            const colorThemes = {
                'default': ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'],
                'ocean': ['#0ea5e9', '#14b8a6', '#06b6d4', '#3b82f6', '#0891b2', '#22d3ee', '#0284c7', '#2dd4bf'],
                'forest': ['#22c55e', '#10b981', '#84cc16', '#16a34a', '#059669', '#4ade80', '#15803d', '#a3e635'],
                'sunset': ['#f97316', '#ef4444', '#ec4899', '#f43f5e', '#fb923c', '#e11d48', '#f472b6', '#dc2626'],
                'berry': ['#a855f7', '#8b5cf6', '#d946ef', '#c026d3', '#9333ea', '#e879f9', '#7c3aed', '#f0abfc'],
                'earth': ['#92400e', '#f59e0b', '#78716c', '#b45309', '#d97706', '#a16207', '#fbbf24', '#6b7280'],
                'neon': ['#00ff88', '#ff0088', '#00ffff', '#ffff00', '#ff00ff', '#88ff00', '#0088ff', '#ff8800'],
                'pastel': ['#93c5fd', '#a5b4fc', '#c4b5fd', '#f9a8d4', '#fca5a5', '#fed7aa', '#fde68a', '#bbf7d0']
            };

            function updatePreview(theme) {
                const preview = document.getElementById('colorPreview');
                const colors = colorThemes[theme] || colorThemes['default'];
                preview.innerHTML = colors.map(c =>
                    `<div style="width: 32px; height: 32px; background-color: ${c}; border-radius: 4px;" title="${c}"></div>`
                ).join('');
            }

            const select = document.getElementById('calendarColorTheme');
            if (select) {
                updatePreview(select.value);
                select.addEventListener('change', function() {
                    updatePreview(this.value);
                });
            }
        })();
        </script>

        <!-- Change Password -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Change Password</h5>
            </div>
            <div class="card-body">
                <div id="passwordResult"></div>

                <form method="POST" action="/dashboard/profile/password"
                      hx-post="/dashboard/profile/password"
                      hx-target="#passwordResult"
                      hx-swap="innerHTML">

                    <div class="mb-3">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-control" name="current_password" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-control" name="new_password"
                               required minlength="8"
                               placeholder="Minimum 8 characters">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" name="confirm_password" required>
                    </div>

                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-key me-1"></i>Change Password
                    </button>
                </form>
            </div>
        </div>

        <!-- Role Permissions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Role Permissions</h5>
            </div>
            <div class="card-body">
                <p class="text-body-secondary mb-3">
                    Your current role: <strong class="text-primary">{{$user.Role}}</strong>
                </p>

                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th class="text-center">DJ</th>
                                <th class="text-center">Manager</th>
                                <th class="text-center">Admin</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>View Dashboard</td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Media Library (view/upload)</td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Playlists</td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Live DJ Controls</td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Schedule</td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Smart Blocks</td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Clock Templates</td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Webstreams</td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>User Management</td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Station Management</td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Mount Configuration</td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                            <tr>
                                <td>System Settings</td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-x-circle text-danger"></i></td>
                                <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}
